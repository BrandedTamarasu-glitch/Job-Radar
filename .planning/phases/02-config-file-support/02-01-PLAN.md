---
phase: 02-config-file-support
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - job_radar/config.py
  - job_radar/search.py
autonomous: true

must_haves:
  truths:
    - "Config file at ~/.job-radar/config.json sets CLI defaults without passing flags"
    - "CLI flag always overrides config value (e.g. --min-score 2.5 beats config min_score 3.0)"
    - "Missing or absent config file causes zero behavior change from today"
    - "--config /path/to/custom.json loads that file instead of default location"
    - "Unknown config key produces a warning naming the unrecognized key"
    - "--no-new-only overrides config-set new_only: true back to false"
  artifacts:
    - path: "job_radar/config.py"
      provides: "Config loading, validation, DEFAULT_CONFIG_PATH, KNOWN_KEYS"
      exports: ["load_config", "DEFAULT_CONFIG_PATH", "KNOWN_KEYS"]
      contains: "KNOWN_KEYS"
    - path: "job_radar/search.py"
      provides: "Two-pass CLI parsing with --config flag, set_defaults integration, BooleanOptionalAction for --new-only"
      contains: "set_defaults"
  key_links:
    - from: "job_radar/search.py"
      to: "job_radar/config.py"
      via: "from .config import load_config"
      pattern: "from \\.config import load_config"
    - from: "job_radar/search.py"
      to: "argparse.set_defaults"
      via: "parser.set_defaults(**config)"
      pattern: "set_defaults\\(\\*\\*config\\)"
    - from: "job_radar/config.py"
      to: "~/.job-radar/config.json"
      via: "Path expanduser and json.load"
      pattern: "DEFAULT_CONFIG_PATH.*job-radar/config\\.json"
---

<objective>
Add persistent JSON config file support so users can save CLI defaults once and have them apply on every run.

Purpose: Eliminates repetitive CLI flag typing (e.g., `--min-score 3.0 --new-only --output custom_dir`) for users who run the tool daily with the same preferences. Satisfies requirements CONF-01 through CONF-05.

Output: New `job_radar/config.py` module and updated `job_radar/search.py` with config integration.
</objective>

<execution_context>
@/Users/coryebert/.claude/get-shit-done/workflows/execute-plan.md
@/Users/coryebert/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-config-file-support/02-RESEARCH.md
@job_radar/search.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create config loading module</name>
  <files>job_radar/config.py</files>
  <action>
Create `job_radar/config.py` with the following:

1. **Constants:**
   - `DEFAULT_CONFIG_PATH = Path("~/.job-radar/config.json")` -- the default config location
   - `KNOWN_KEYS = {"min_score", "new_only", "output"}` -- use underscore names to match argparse dest names. Do NOT include "profile" (it is `required=True` and argparse validates required before set_defaults applies, per research Pitfall 5). Do NOT include "config" (circular).

2. **`load_config(config_path: str | None = None) -> dict` function:**
   - If `config_path` is provided, use `Path(config_path).expanduser()`; otherwise use `DEFAULT_CONFIG_PATH.expanduser()`
   - If path does not exist, return `{}` silently (CONF-03: no config = no behavior change)
   - Wrap `json.load()` in try/except `json.JSONDecodeError`. On error, print warning to stderr with the path, error message, and line number, then return `{}`
   - After loading, check `isinstance(raw, dict)`. If not a dict, print warning to stderr and return `{}`
   - Iterate over keys: for unknown keys (not in KNOWN_KEYS), print warning to stderr naming the key (CONF-05). Only include recognized keys in the returned dict.
   - All warnings use `print(..., file=sys.stderr)` so they don't pollute piped stdout (per research Open Question 3).

3. **Imports:** `json`, `sys`, `from pathlib import Path`. No third-party imports.
  </action>
  <verify>
Run: `cd "/Users/coryebert/Documents/Job Hunt Python/Project Folder/Job-Radar" && python -c "from job_radar.config import load_config, DEFAULT_CONFIG_PATH, KNOWN_KEYS; print('OK:', KNOWN_KEYS)"`

This must print OK and the set of known keys without import errors.
  </verify>
  <done>
- `job_radar/config.py` exists with `load_config()`, `DEFAULT_CONFIG_PATH`, and `KNOWN_KEYS` exported
- `load_config()` returns `{}` when no config file exists
- `load_config()` returns `{}` with stderr warning on invalid JSON
- `load_config()` warns on stderr for unknown keys and excludes them from result
- `load_config()` accepts optional `config_path` parameter for custom path
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate config loading into CLI pipeline</name>
  <files>job_radar/search.py</files>
  <action>
Modify `job_radar/search.py` to wire config loading into the CLI pipeline. Three changes:

**Change 1: Two-pass parsing in `main()`**

Before the current `args = parse_args()` call in `main()`, add a pre-parser to extract `--config`:

```python
from .config import load_config

def main():
    # Two-pass: extract --config before full parse
    pre_parser = argparse.ArgumentParser(add_help=False)
    pre_parser.add_argument("--config", default=None)
    pre_args, _ = pre_parser.parse_known_args()

    config = load_config(pre_args.config)
    args = parse_args(config)
    # ... rest of main unchanged
```

**Change 2: Update `parse_args()` to accept config dict**

- Change signature from `def parse_args():` to `def parse_args(config: dict | None = None):`
- Add `--config` argument: `parser.add_argument("--config", default=None, help="Path to custom config file (default: ~/.job-radar/config.json)")`
- Change `--new-only` from `action="store_true"` to `action=argparse.BooleanOptionalAction` so `--no-new-only` can override config-set `new_only: true`. Keep `default=False`.
- Before `return parser.parse_args()`, add: `if config: parser.set_defaults(**config)` -- this injects config values as parser-level defaults; CLI flags override them automatically.
- Keep `--profile` as `required=True` (not configurable via config file).
- Keep `--min-score` with `default=None` (config will supply the default via set_defaults; the None sentinel means "use fallback 2.8" only if neither config nor CLI provides a value).

**Change 3: No other changes needed**

The rest of `main()` already handles `args.min_score` correctly (line 374: `min_score = args.min_score if args.min_score is not None else 2.8`). The `args.new_only`, `args.output`, etc. are all consumed as-is. Config integration is transparent.

**What NOT to change:**
- Do NOT change how `args.min_score` is used downstream (the `if is not None else 2.8` fallback stays)
- Do NOT make `--profile` optional or add it to KNOWN_KEYS (per research Pitfall 5)
- Do NOT add `--open`, `--dry-run`, `--verbose`, `--no-cache`, `--from`, or `--to` to KNOWN_KEYS in config.py -- only `min_score`, `new_only`, and `output` are configurable for now
  </action>
  <verify>
Run all three checks:

1. Import test: `cd "/Users/coryebert/Documents/Job Hunt Python/Project Folder/Job-Radar" && python -c "from job_radar.search import parse_args; print('import OK')"`

2. No-config test (CONF-03): `cd "/Users/coryebert/Documents/Job Hunt Python/Project Folder/Job-Radar" && python -c "
from job_radar.config import load_config
config = load_config('/tmp/nonexistent-config.json')
assert config == {}, f'Expected empty dict, got {config}'
print('CONF-03 OK: missing config returns empty dict')
"`

3. Help text includes --config and --no-new-only: `cd "/Users/coryebert/Documents/Job Hunt Python/Project Folder/Job-Radar" && python -m job_radar --help 2>&1 | grep -E '(--config|--no-new-only)'`
  </verify>
  <done>
- `search.py` imports `load_config` from `.config`
- `main()` uses two-pass parsing to extract `--config` before full parse
- `parse_args()` accepts config dict and calls `parser.set_defaults(**config)`
- `--config` flag appears in help text
- `--new-only` uses `BooleanOptionalAction` (both `--new-only` and `--no-new-only` work)
- Running without any config file produces identical behavior to before this change
  </done>
</task>

</tasks>

<verification>
After both tasks complete, verify all five CONF requirements:

1. **CONF-01** (config file sets defaults): Create a temp config file with `{"min_score": 3.0, "new_only": true}`, run with `--config /tmp/test-config.json --profile profiles/some_profile.json --dry-run`, confirm min_score and new_only are applied from config.

2. **CONF-02** (CLI overrides config): Same config file but add `--min-score 2.5` on the CLI. Confirm 2.5 is used, not 3.0.

3. **CONF-03** (no config = no change): Run without any config file. Confirm behavior is identical to before (no errors, no warnings).

4. **CONF-04** (custom config path): Run with `--config /tmp/test-config.json`. Confirm it loads that file.

5. **CONF-05** (unknown key warning): Create config with `{"unknown_key": true, "min_score": 3.0}`. Run and confirm stderr shows warning naming "unknown_key".
</verification>

<success_criteria>
- `job_radar/config.py` exists as a clean, stdlib-only module with `load_config()`, `DEFAULT_CONFIG_PATH`, `KNOWN_KEYS`
- `job_radar/search.py` has two-pass parsing, `--config` flag, `BooleanOptionalAction` for `--new-only`, and `set_defaults` integration
- All five CONF requirements (CONF-01 through CONF-05) are satisfied
- Running without a config file produces zero behavior change from before this plan
</success_criteria>

<output>
After completion, create `.planning/phases/02-config-file-support/02-01-SUMMARY.md`
</output>
