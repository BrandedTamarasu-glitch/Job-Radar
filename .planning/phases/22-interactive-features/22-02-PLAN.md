---
phase: 22-interactive-features
plan: 02
type: execute
wave: 2
depends_on: ["22-01"]
files_modified: [job_radar/report.py, tests/test_report.py]
autonomous: true

must_haves:
  truths:
    - "User can click Export CSV button to download a CSV file of visible jobs"
    - "CSV file opens correctly in Excel on Windows with no character corruption"
    - "CSV includes proper column headers (Rank, Score, New, Status, Title, Company, Salary, Type, Location, Snippet, URL)"
    - "CSV only exports visible (not filtered-out) jobs"
    - "CSV escapes commas, quotes, and newlines per RFC 4180"
    - "CSV sanitizes formula injection (cells starting with =+-@ get single-quote prefix)"
    - "Tests verify filter UI, filter JavaScript, CSV export button, and CSV escaping functions exist in generated HTML"
  artifacts:
    - path: "job_radar/report.py"
      provides: "CSV export JavaScript with Export CSV button"
      contains: "exportVisibleJobsToCSV"
    - path: "tests/test_report.py"
      provides: "Tests for filter UI, filter JS, CSV export"
      contains: "test_html_report_filter"
  key_links:
    - from: "Export CSV button onclick"
      to: "exportVisibleJobsToCSV function"
      via: "onclick handler"
      pattern: "exportVisibleJobsToCSV"
    - from: "exportVisibleJobsToCSV"
      to: "escapeCSVField function"
      via: "maps each field through escaper"
      pattern: "escapeCSVField"
    - from: "exportVisibleJobsToCSV"
      to: "display:none check"
      via: "skips elements with display none"
      pattern: "style.display.*none"
    - from: "Blob with BOM"
      to: "download attribute"
      via: "URL.createObjectURL triggers download"
      pattern: "createObjectURL"
---

<objective>
Add CSV export functionality to the HTML report and write tests for both filtering (Plan 01) and CSV export. Users can download visible job results as a properly formatted CSV file that opens correctly in Excel on Windows.

Purpose: Users need to export job search results for external tracking in spreadsheets. CSV must handle UTF-8 encoding (BOM), RFC 4180 escaping, and formula injection protection. Tests ensure both interactive features work correctly.

Output: Updated report.py with CSV export JavaScript and Export CSV button. Updated test_report.py with tests for filter UI, filter JavaScript, CSV export button, and CSV helper functions.
</objective>

<execution_context>
@/home/corye/.claude/get-shit-done/workflows/execute-plan.md
@/home/corye/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/22-interactive-features/22-RESEARCH.md
@.planning/phases/22-interactive-features/22-01-SUMMARY.md
@job_radar/report.py
@tests/test_report.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add CSV export JavaScript and Export CSV button</name>
  <files>job_radar/report.py</files>
  <action>
Add CSV export functionality to the HTML report in two places:

**A) Export CSV button in the filter UI bar (from Plan 01):**
Add an "Export CSV" button inside the filter bar's flex container (the `d-flex` div), after the Show All button and before the filter count span. The button HTML:
```
<button class="btn btn-outline-success btn-sm no-print" id="export-csv-btn" onclick="exportVisibleJobsToCSV()" aria-label="Export visible jobs to CSV file">Export CSV</button>
```
The `no-print` class ensures it won't appear in print output (existing CSS pattern from Phase 16).

**B) CSV export JavaScript functions in the filter script block (last `<script>` block):**
Add these functions INSIDE the existing filter script block from Plan 01 (keep all JS in one script block for simplicity), using `var`/`function` declarations and doubled braces for f-string escaping:

1. `escapeCSVField(value)` - RFC 4180 field escaping with formula injection protection:
   - If value is null/undefined/empty string, return empty string.
   - Convert to String.
   - Formula injection: if string starts with `=`, `+`, `-`, or `@`, prefix with single quote `'`. Use regex `/^[=+\-@]/`.
   - RFC 4180 quoting: if string contains comma, double-quote, newline (`\n`), or carriage return (`\r`), wrap in double quotes with internal `"` escaped as `""`. Use `str.replace(/"/g, '""')`.
   - Return the escaped string.

2. `extractJobDataFromElement(jobElement, rank)` - Extract job data from DOM element:
   - Detect if element is table row (`jobElement.tagName === 'TR'`) or card.
   - **For table rows:** Extract from `td`/`th` cells by index. Clean score text with regex `(\d+\.\d+)` match. Get status from `.status-badge` text (strip `‚óè` character). Check for NEW badge. Extract title (cell 4), company (cell 5), salary (cell 6), type (cell 7), location (cell 8), snippet (cell 9). Get URL from `data-job-url` attribute.
   - **For cards:** Extract title from `data-job-title`, company from `data-job-company`, score from `data-score`, URL from `data-job-url`. Get status from `.status-badge`. Parse salary/location from card body `li` elements containing "Rate/Salary:" and "Location:" text.
   - Return array: `[rank, score, isNew, status, title, company, salary, type, location, snippet, url]`

3. `exportVisibleJobsToCSV()` - Main export function:
   - Query all `[data-job-key]` elements. Filter to only visible (where `element.style.display !== 'none'`). NOTE: Also check `element.offsetParent !== null` as a fallback for elements hidden by CSS class rather than inline style, but primarily rely on `style.display`.
   - If no visible jobs: show `notyf.error('No visible jobs to export')`, announce to screen reader, return.
   - Build CSV header row: `['Rank', 'Score', 'New', 'Status', 'Title', 'Company', 'Salary', 'Type', 'Location', 'Snippet', 'URL']`
   - Build data rows by calling `extractJobDataFromElement` for each visible job with rank (i+1).
   - Map each row through `escapeCSVField` and join with commas.
   - Join all rows with `\r\n` (CRLF per RFC 4180).
   - Prepend UTF-8 BOM: `'\uFEFF'` before CSV content.
   - Create Blob: `new Blob([csvWithBOM], {{ type: 'text/csv;charset=utf-8;' }})`.
   - Create object URL: `URL.createObjectURL(blob)`.
   - Create temporary anchor element with `download` attribute set to `'job-radar-export-' + new Date().toISOString().split('T')[0] + '.csv'`.
   - Append to body, click, remove from body.
   - Call `URL.revokeObjectURL(url)` to free memory.
   - Show success toast: `notyf.success('Exported N jobs to CSV')`.
   - Announce to screen reader via `announceToScreenReader`.

IMPORTANT: All braces in JavaScript must be doubled for Python f-string escaping. The `notyf` variable and `announceToScreenReader` function are defined in earlier script blocks and available globally.
  </action>
  <verify>Run `python -c "from job_radar.report import generate_report"` to confirm no syntax errors. Run `grep -c 'escapeCSVField\|exportVisibleJobsToCSV\|export-csv-btn\|uFEFF' job_radar/report.py` to confirm CSV functions exist (should be >= 4 matches).</verify>
  <done>CSV export JavaScript exists with escapeCSVField (RFC 4180 + formula injection), extractJobDataFromElement (table rows + cards), and exportVisibleJobsToCSV (Blob + BOM + download). Export CSV button is present in filter UI bar.</done>
</task>

<task type="auto">
  <name>Task 2: Add tests for filter UI, filter JavaScript, and CSV export</name>
  <files>tests/test_report.py</files>
  <action>
Add test functions at the end of tests/test_report.py following the existing test pattern (each test generates a report using the shared fixtures, reads the HTML file, and asserts on string content). Use the existing `sample_profile`, `sample_scored_results`, `sample_manual_urls`, and `tmp_path` fixtures.

Add these test functions:

1. `test_html_report_filter_ui_controls` - Assert HTML contains:
   - `id="filter-heading"` (filter section heading)
   - `id="filter-applied"` (checkbox for Hide Applied)
   - `id="filter-rejected"` (checkbox for Hide Rejected)
   - `id="filter-interviewing"` (checkbox for Hide Interviewing)
   - `id="filter-offer"` (checkbox for Hide Offer)
   - `id="clear-filters"` (Show All button)
   - `role="group"` (accessible button group)
   - `aria-label="Status filter checkboxes"` or similar ARIA label

2. `test_html_report_filter_javascript` - Assert HTML contains:
   - `job-radar-filter-state` (localStorage key)
   - `loadFilterState` (load function)
   - `saveFilterState` (save function)
   - `applyFilter` (apply function)
   - `initializeFilters` (init function)
   - `handleFilterChange` (change handler)
   - `clearAllFilters` (clear function)

3. `test_html_report_filter_aria_announcements` - Assert HTML contains:
   - `announceFilterCount` (ARIA announcement function)
   - `Showing` (the announcement message pattern - "Showing X of Y jobs")
   - References to `status-announcer` (existing ARIA live region reuse)

4. `test_html_report_filter_persistence` - Assert HTML contains:
   - `localStorage.getItem` (reading filter state)
   - `localStorage.setItem` (writing filter state)
   - `JSON.parse` and `JSON.stringify` (serialization)
   - `QuotaExceededError` or `quota` (error handling)

5. `test_html_report_export_csv_button` - Assert HTML contains:
   - `export-csv-btn` (button id)
   - `Export CSV` or `Export` (button text)
   - `exportVisibleJobsToCSV` (onclick handler)
   - `no-print` (hidden from print)
   - `aria-label` on the export button

6. `test_html_report_csv_escape_function` - Assert HTML contains:
   - `escapeCSVField` (escape function name)
   - `replace(/"/g` or similar double-quote escaping pattern
   - `uFEFF` (UTF-8 BOM character)
   - RFC 4180 indicators: pattern for comma/quote/newline detection

7. `test_html_report_csv_formula_injection_protection` - Assert HTML contains:
   - Pattern matching formula prefix check: `=`, `+`, `-`, `@` detection
   - Single quote prefix: the `"'" +` or `"\\'" +` pattern indicating single-quote prepending

8. `test_html_report_csv_export_respects_filter` - Assert HTML contains:
   - `style.display` check (visibility detection)
   - `data-job-key` (selector for job elements)
   - `Blob` (file generation)
   - `createObjectURL` (download trigger)
   - `revokeObjectURL` (memory cleanup)

9. `test_html_report_csv_download_filename` - Assert HTML contains:
   - `job-radar-export-` (filename prefix)
   - `.csv` (file extension)
   - `download` attribute (force download)
   - `text/csv` (MIME type)

Each test follows the exact same pattern as existing tests. Example skeleton:
```python
def test_html_report_filter_ui_controls(sample_profile, sample_scored_results, sample_manual_urls, tmp_path):
    """Filter UI includes checkbox controls for each status type."""
    result = generate_report(sample_scored_results, sample_profile, sample_manual_urls, str(tmp_path))
    html_path = result["html"]
    with open(html_path) as f:
        html = f.read()
    assert 'id="filter-applied"' in html
    # ... more assertions
```
  </action>
  <verify>Run `python -m pytest tests/test_report.py -x -q` to confirm all tests pass including new ones. Run `python -m pytest tests/test_report.py -k "filter or csv" -v` to confirm new tests specifically pass.</verify>
  <done>9 new test functions exist and pass: filter_ui_controls, filter_javascript, filter_aria_announcements, filter_persistence, export_csv_button, csv_escape_function, csv_formula_injection_protection, csv_export_respects_filter, csv_download_filename. All existing tests continue to pass.</done>
</task>

</tasks>

<verification>
1. `python -c "from job_radar.report import generate_report"` succeeds
2. `python -m pytest tests/test_report.py -x -q` all tests pass
3. `python -m pytest tests/test_report.py -k "filter or csv" -v` new tests pass
4. `grep 'escapeCSVField' job_radar/report.py` confirms CSV escape function
5. `grep 'uFEFF' job_radar/report.py` confirms UTF-8 BOM
6. `grep 'export-csv-btn' job_radar/report.py` confirms Export CSV button
7. `grep 'revokeObjectURL' job_radar/report.py` confirms memory cleanup
</verification>

<success_criteria>
- Export CSV button renders in the filter control bar
- CSV export JavaScript generates proper RFC 4180 CSV with UTF-8 BOM
- Formula injection protection prefixes dangerous characters with single quote
- CSV only includes visible (not filtered-out) jobs
- Blob URL is revoked after download for memory cleanup
- 9 new tests pass covering filter UI, filter JS, CSV export, escaping, and download
- All existing tests continue to pass
</success_criteria>

<output>
After completion, create `.planning/phases/22-interactive-features/22-02-SUMMARY.md`
</output>
