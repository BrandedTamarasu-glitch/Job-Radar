---
phase: 15-pdf-resume-parser
plan: 03
type: execute
wave: 2
depends_on: ["15-01"]
files_modified:
  - tests/test_pdf_parser.py
  - tests/test_wizard.py
autonomous: true

must_haves:
  truths:
    - "PDF validation tests verify rejection of image-only, encrypted, oversized, and corrupted PDFs"
    - "Extraction tests verify name, years, titles, and skills parsing from resume text"
    - "Wizard tests verify PDF upload flow (upload choice, pre-fill defaults, disclaimer, manual fallback)"
    - "All tests pass with pytest"
  artifacts:
    - path: "tests/test_pdf_parser.py"
      provides: "Comprehensive tests for pdf_parser module"
      min_lines: 100
    - path: "tests/test_wizard.py"
      provides: "Extended wizard tests for PDF integration"
      contains: "Upload resume PDF"
  key_links:
    - from: "tests/test_pdf_parser.py"
      to: "job_radar/pdf_parser.py"
      via: "import and test all public functions"
      pattern: "from job_radar.pdf_parser import"
    - from: "tests/test_wizard.py"
      to: "job_radar/wizard.py"
      via: "mock PDF parser for wizard integration tests"
      pattern: "pdf_parser"
---

<objective>
Create comprehensive test coverage for the PDF parser module and wizard PDF integration, ensuring all requirements (PDF-01 through PDF-10) are verified.

Purpose: Validates that PDF parsing works correctly in isolation and that the wizard integration handles all user paths (upload, skip, errors, partial extraction).
Output: New tests/test_pdf_parser.py file and additions to tests/test_wizard.py.
</objective>

<execution_context>
@/Users/coryebert/.claude/get-shit-done/workflows/execute-plan.md
@/Users/coryebert/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/15-pdf-resume-parser/15-CONTEXT.md
@.planning/phases/15-pdf-resume-parser/15-RESEARCH.md
@.planning/phases/15-pdf-resume-parser/15-01-SUMMARY.md
@job_radar/pdf_parser.py
@tests/test_wizard.py
@tests/conftest.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create test_pdf_parser.py with extraction and validation tests</name>
  <files>tests/test_pdf_parser.py</files>
  <action>
Create new file `tests/test_pdf_parser.py` with comprehensive tests for the pdf_parser module. Follow established test patterns from the project (MockDocument class style, pytest.raises, parametrize).

**Test categories:**

1. **Validation tests** (test validate_pdf_file):
   - `test_validate_rejects_nonexistent_file` — PDFValidationError for missing file
   - `test_validate_rejects_non_pdf_extension` — PDFValidationError for .txt, .docx files
   - `test_validate_rejects_oversized_file` — Create tmp file > 5 MB, verify rejection with "File size exceeds 5 MB" message
   - `test_validate_rejects_image_only_pdf` — Mock pdfplumber.open to return page with extract_text() returning None/empty, verify "image-based" message
   - `test_validate_rejects_encrypted_pdf` — Mock pdfplumber.open to raise PDFPasswordIncorrect, verify "password-protected" message
   - `test_validate_rejects_corrupted_pdf` — Mock pdfplumber.open to raise PDFSyntaxError, verify "corrupted" message
   - `test_validate_accepts_valid_pdf` — Mock pdfplumber.open to return page with text, verify no exception

2. **Name extraction tests** (test _extract_name directly):
   - `test_extract_name_basic` — "John Doe\nSoftware Engineer\n..." returns "John Doe"
   - `test_extract_name_skips_contact_info` — "john@email.com\nJohn Doe\n..." returns "John Doe"
   - `test_extract_name_skips_phone` — "555-123-4567\nJane Smith\n..." returns "Jane Smith"
   - `test_extract_name_unicode` — "Jose Garcia\n..." returns "Jose Garcia" (test basic non-ASCII)
   - `test_extract_name_returns_none_no_match` — Text with no name-like line returns None
   - `test_extract_name_skips_section_headers` — All-caps "PROFESSIONAL EXPERIENCE" (>20 chars) not returned as name
   - Use @pytest.mark.parametrize for the basic cases

3. **Years experience extraction tests** (test _extract_years_experience directly):
   - `test_years_explicit_mention` — "5 years of experience" returns 5
   - `test_years_plus_format` — "10+ years experience" returns 10
   - `test_years_from_date_ranges` — Text with "Experience\nJan 2020 - Present\n..." calculates correct years
   - `test_years_returns_none_no_data` — Text with no experience info returns None
   - Use @pytest.mark.parametrize for explicit mention patterns

4. **Job titles extraction tests** (test _extract_job_titles directly):
   - `test_titles_basic_extraction` — Experience section with "Software Engineer" returns ["Software Engineer"]
   - `test_titles_multiple` — Multiple roles extracted (max 3)
   - `test_titles_filters_company_names` — "Amazon Inc" not returned as title
   - `test_titles_returns_none_no_section` — Text without experience section returns None

5. **Skills extraction tests** (test _extract_skills directly):
   - `test_skills_comma_separated` — "Skills\nPython, JavaScript, React" returns ["Python", "JavaScript", "React"]
   - `test_skills_filters_long_items` — Items > 50 chars filtered out
   - `test_skills_stops_at_next_section` — "Skills\nPython\nExperience\n..." only gets "Python"
   - `test_skills_returns_none_no_section` — Text without skills section returns None

6. **Integration test** (test extract_resume_data with mocked pdfplumber):
   - `test_extract_resume_data_full_extraction` — Mock pdfplumber to return realistic resume text, verify all fields extracted
   - `test_extract_resume_data_partial_extraction` — Mock with text that only has name and skills, verify dict has only those keys
   - `test_extract_resume_data_empty_on_all_fail` — Mock with text that matches no patterns, verify empty dict returned

7. **PDF_SUPPORT flag test:**
   - `test_pdf_support_flag_exists` — Verify PDF_SUPPORT is importable

**Implementation notes:**
- Import private functions directly for unit testing: `from job_radar.pdf_parser import _extract_name, _extract_years_experience, _extract_job_titles, _extract_skills`
- Mock pdfplumber for validation tests (don't require actual PDF files for most tests)
- Use `tmp_path` fixture for file-based tests
- Follow existing pattern: use descriptive test names, keep tests focused on single behavior
  </action>
  <verify>
Run: `pytest tests/test_pdf_parser.py -v` — all tests pass.
Run: `pytest tests/test_pdf_parser.py --tb=short -q` — verify count of tests (expect 20+).
  </verify>
  <done>
tests/test_pdf_parser.py exists with 20+ tests covering validation (6 tests), name extraction (6 tests), years extraction (4 tests), titles extraction (4 tests), skills extraction (4 tests), and integration (3 tests). All tests pass.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add wizard PDF integration tests to test_wizard.py</name>
  <files>tests/test_wizard.py</files>
  <action>
Add new tests to the bottom of `tests/test_wizard.py` for the wizard PDF upload flow. These tests mock the pdf_parser module to test wizard behavior without actual PDF files.

**New tests to add (append after existing tests):**

1. **`test_wizard_pdf_upload_happy_path`** — Verifies the full PDF upload flow:
   - Mock `pdf_parser.PDF_SUPPORT = True`
   - Mock `pdf_parser.extract_resume_data` to return `{'name': 'PDF User', 'years_experience': 7, 'titles': ['Engineer'], 'skills': ['Python', 'AWS']}`
   - Mock questionary.select to return "Upload resume PDF" then "Save this configuration"
   - Mock questionary.path to return a fake PDF path
   - Mock questionary.text — verify defaults are populated from extracted data
   - Assert profile.json contains extracted values

2. **`test_wizard_pdf_skip_manual`** — Verifies "Fill manually" path:
   - Mock `pdf_parser.PDF_SUPPORT = True`
   - Mock questionary.select to return "Fill manually" then "Save this configuration"
   - Provide manual text answers
   - Assert wizard completes normally, no PDF parsing attempted
   - Verify `extract_resume_data` was NOT called

3. **`test_wizard_pdf_parse_error_fallback`** — Verifies error fallback:
   - Mock `pdf_parser.PDF_SUPPORT = True`
   - Mock `pdf_parser.extract_resume_data` to raise `PDFValidationError("image-based")`
   - Mock questionary.select to return "Upload resume PDF"
   - Mock questionary.path to return a fake path
   - Mock questionary.confirm (for fallback) to return True
   - Provide manual text answers
   - Assert wizard completes with manual data, returns True

4. **`test_wizard_pdf_hidden_when_unavailable`** — Verifies PDF option not shown without pdfplumber:
   - Mock `pdf_parser.PDF_SUPPORT = False` or make pdf_parser import fail
   - Provide manual text answers
   - Assert wizard goes straight to manual prompts (no select for upload choice)
   - Assert wizard completes normally

5. **`test_wizard_pdf_partial_extraction`** — Verifies partial extraction pre-fill:
   - Mock extract_resume_data to return `{'name': 'Partial User'}` (only name, no other fields)
   - Verify name prompt gets default but other prompts have no defaults
   - Assert wizard completes with partial pre-fill + manual entry for rest

**Implementation pattern:** Follow the existing test patterns in test_wizard.py:
- Use `mocker.patch('job_radar.paths.get_data_dir', return_value=tmp_path)`
- Use side_effect functions for sequential mock answers
- Mock at `job_radar.wizard.questionary.text`, `job_radar.wizard.questionary.confirm`, `job_radar.wizard.questionary.select`
- For pdf_parser mocks, patch at `job_radar.wizard.pdf_parser` or use mocker to patch the import paths appropriately
- Verify profile.json and config.json content after wizard completion
  </action>
  <verify>
Run: `pytest tests/test_wizard.py -v -k "pdf"` — all new PDF-related tests pass.
Run: `pytest tests/test_wizard.py -v` — all existing AND new tests pass (no regressions).
  </verify>
  <done>
tests/test_wizard.py has 5 new tests for PDF integration (upload happy path, skip to manual, error fallback, hidden when unavailable, partial extraction). All new tests pass. All existing wizard tests still pass (no regressions).
  </done>
</task>

</tasks>

<verification>
1. `pytest tests/test_pdf_parser.py -v` — all PDF parser tests pass
2. `pytest tests/test_wizard.py -v -k "pdf"` — all wizard PDF tests pass
3. `pytest tests/test_wizard.py -v` — all wizard tests pass (no regressions)
4. `pytest tests/ -v --tb=short` — full test suite passes
</verification>

<success_criteria>
- tests/test_pdf_parser.py covers validation (rejects image-only, encrypted, oversized, corrupted; accepts valid), name extraction (basic, contact skip, unicode, section header skip), years extraction (explicit mention, date calculation), title extraction (basic, company filter), skill extraction (comma-separated, length filter, section boundary), and integration (full, partial, empty)
- tests/test_wizard.py covers PDF upload happy path, manual skip, error fallback, hidden when unavailable, partial extraction
- All new tests pass
- All existing tests pass (no regressions)
- Test count increases by 25+
</success_criteria>

<output>
After completion, create `.planning/phases/15-pdf-resume-parser/15-03-SUMMARY.md`
</output>
