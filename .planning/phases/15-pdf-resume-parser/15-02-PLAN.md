---
phase: 15-pdf-resume-parser
plan: 02
type: execute
wave: 2
depends_on: ["15-01"]
files_modified:
  - job_radar/wizard.py
autonomous: true

must_haves:
  truths:
    - "User sees 'Upload resume PDF' and 'Fill manually' as opening choices in wizard"
    - "Choosing 'Fill manually' proceeds to normal wizard flow with no PDF parsing"
    - "Choosing 'Upload resume PDF' prompts for file path with validation"
    - "After successful parse, wizard shows disclaimer 'Please review - extraction may contain errors' ONCE"
    - "Extracted name, years, titles, skills appear as editable default values in wizard prompts"
    - "Partial extraction works: extracted fields pre-filled, failed fields left empty for manual entry"
    - "PDF validation error shows specific message and offers manual fallback"
    - "PDF upload option hidden if pdfplumber not installed (PDF_SUPPORT=False)"
  artifacts:
    - path: "job_radar/wizard.py"
      provides: "PDF import integration in wizard flow"
      contains: "Upload resume PDF"
  key_links:
    - from: "job_radar/wizard.py"
      to: "job_radar/pdf_parser.py"
      via: "lazy import inside run_setup_wizard()"
      pattern: "from .pdf_parser import"
    - from: "job_radar/wizard.py"
      to: "questionary.path"
      via: "file path prompt for PDF selection"
      pattern: "questionary.path"
    - from: "job_radar/wizard.py"
      to: "questionary.select"
      via: "upload vs manual choice"
      pattern: "Upload resume PDF"
---

<objective>
Integrate PDF resume parsing into the wizard setup flow so users can optionally upload a PDF to pre-fill profile fields.

Purpose: Connects the pdf_parser.py extraction engine (from Plan 01) to the user-facing wizard, enabling the PDF import feature that users interact with.
Output: Modified job_radar/wizard.py with PDF upload step at beginning of wizard flow.
</objective>

<execution_context>
@/Users/coryebert/.claude/get-shit-done/workflows/execute-plan.md
@/Users/coryebert/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/15-pdf-resume-parser/15-CONTEXT.md
@.planning/phases/15-pdf-resume-parser/15-RESEARCH.md
@.planning/phases/15-pdf-resume-parser/15-01-SUMMARY.md
@job_radar/wizard.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add PDF upload choice and extraction to wizard flow</name>
  <files>job_radar/wizard.py</files>
  <action>
Modify `run_setup_wizard()` in wizard.py to add PDF import as the first step. Follow the CONTEXT.md locked decisions precisely and RESEARCH.md Pattern 2 for implementation guidance.

**Changes to make (in order):**

1. **After the wizard header print block** (after the `print("=" * 60)` lines and BEFORE the `print("\nTip: Type /back...")`), insert the PDF upload flow:

   a. **Check PDF_SUPPORT availability:**
   ```python
   # Check if PDF parsing is available
   pdf_available = False
   try:
       from .pdf_parser import PDF_SUPPORT
       pdf_available = PDF_SUPPORT
   except ImportError:
       pass
   ```

   b. **Show upload choice** (only if pdf_available is True, per CONTEXT.md: "Upload resume or fill manually?"):
   ```python
   extracted_data = {}
   if pdf_available:
       print("\nSpeed up setup by uploading your resume PDF to auto-fill fields.\n")

       upload_choice = questionary.select(
           "How would you like to create your profile?",
           choices=[
               "Upload resume PDF",
               "Fill manually",
           ],
           style=custom_style
       ).ask()

       if upload_choice and "PDF" in upload_choice:
           # Prompt for file path
           pdf_path_str = questionary.path(
               "Path to your resume PDF:",
               only_directories=False,
               style=custom_style
           ).ask()

           if pdf_path_str:
               from pathlib import Path as _Path
               pdf_path = _Path(pdf_path_str)

               # Validate extension before calling parser
               if pdf_path.suffix.lower() != '.pdf':
                   print("\nFile must be a PDF (.pdf extension required)")
               elif not pdf_path.exists():
                   print(f"\nFile not found: {pdf_path}")
               else:
                   print(f"\nParsing resume PDF...\n")
                   try:
                       from .pdf_parser import extract_resume_data, PDFValidationError
                       extracted_data = extract_resume_data(pdf_path_str)

                       # Disclaimer - shown ONCE after parsing (CONTEXT.md locked decision)
                       print("Resume parsed successfully!")
                       print("\n  Please review - extraction may contain errors\n")

                       # Show what was extracted
                       if extracted_data:
                           print("Extracted fields:")
                           for key in extracted_data:
                               print(f"   - {key}")
                           print()

                   except PDFValidationError as e:
                       # Per CONTEXT.md: show specific actionable error message
                       print(f"\n{str(e)}\n")

                   except Exception as e:
                       # Catch-all for unexpected errors
                       print(f"\nPDF parsing encountered an error: {e}")
                       print("Continuing with manual entry...\n")
                       extracted_data = {}

               # If extraction failed or had errors, offer manual fallback
               # Per CONTEXT.md: "every error path ends with manual option"
               if not extracted_data and upload_choice and "PDF" in upload_choice:
                   fallback = questionary.confirm(
                       "Would you like to fill your profile manually?",
                       default=True,
                       style=custom_style
                   ).ask()

                   if not fallback:
                       return False

                   extracted_data = {}
   ```

   c. If pdf_available is False, skip the upload choice entirely. User goes straight to manual wizard (satisfies PDF-10: user can skip PDF import).

2. **After the existing line** `print("\nTip: Type /back at any prompt to return to the previous question.\n")`, the existing question loop begins. **No changes needed to the questions list.**

3. **In the prompt loop** (the `while idx < len(questions):` block), modify the default value logic to check extracted_data. Replace the existing default logic block:

   Find the block that starts with:
   ```python
   # Pre-fill with previous answer if going back
   if key in answers:
       if q['type'] == 'text':
           prompt_kwargs['default'] = str(answers[key])
   elif q.get('default') is not None and q['type'] == 'text':
       # Only use default for new answers on fields with defaults
       prompt_kwargs['default'] = q['default']
   ```

   Replace with:
   ```python
   # Pre-fill with previous answer if going back
   if key in answers:
       if q['type'] == 'text':
           prompt_kwargs['default'] = str(answers[key])
   elif key in extracted_data:
       # Pre-fill with PDF-extracted data (per CONTEXT.md: pre-display validation)
       value = extracted_data[key]
       if key == 'years_experience' and isinstance(value, int) and 0 <= value <= 50:
           prompt_kwargs['default'] = str(value)
       elif key == 'name' and isinstance(value, str) and value.strip() and len(value) < 100:
           prompt_kwargs['default'] = value
       elif key == 'titles' and isinstance(value, list) and value:
           prompt_kwargs['default'] = ', '.join(value)
       elif key == 'skills' and isinstance(value, list) and value:
           # Filter out overly long items (sanity check per CONTEXT.md)
           valid_skills = [s for s in value if len(s) < 50]
           if valid_skills:
               prompt_kwargs['default'] = ', '.join(valid_skills)
   elif q.get('default') is not None and q['type'] == 'text':
       # Only use default for new answers on fields with defaults
       prompt_kwargs['default'] = q['default']
   ```

   This ensures:
   - Previous answers (back navigation) take priority
   - Extracted data used as default for first-time through
   - Sanity checks on extracted values (per CONTEXT.md: "basic sanity checks before showing")
   - Question-defined defaults (like min_score="2.8") still work when no extraction

**IMPORTANT constraints from CONTEXT.md:**
- PDF upload offered FIRST THING in wizard flow (before any manual prompts)
- Options are "Upload resume PDF" and "Fill manually" as equal choices
- Disclaimer shown ONCE after parsing, NOT on every field
- No visual distinction between extracted and manual fields
- Partial extraction: pre-fill what worked, prompt for rest
- Every error path offers manual entry fallback
- No back navigation to PDF upload once wizard prompts start
  </action>
  <verify>
Run: `python -c "from job_radar.wizard import run_setup_wizard; print('Import OK')"` â€” wizard imports without error.
Verify the upload choice code exists: `grep -c 'Upload resume PDF' job_radar/wizard.py` returns at least 1.
Verify extracted_data default logic: `grep -c 'extracted_data' job_radar/wizard.py` returns at least 3.
  </verify>
  <done>
wizard.py run_setup_wizard() has PDF upload as first step. Upload choice uses questionary.select with two equal options. Successful parse shows disclaimer once. Extracted data pre-fills wizard prompts with sanity checks. All error paths offer manual fallback. PDF option hidden if pdfplumber not installed.
  </done>
</task>

</tasks>

<verification>
1. `grep 'Upload resume PDF' job_radar/wizard.py` confirms upload choice exists
2. `grep 'Please review - extraction may contain errors' job_radar/wizard.py` confirms disclaimer
3. `grep 'extracted_data' job_radar/wizard.py` confirms pre-fill logic
4. `grep 'PDF_SUPPORT' job_radar/wizard.py` confirms conditional feature check
5. `grep 'Fill manually' job_radar/wizard.py` confirms skip option
6. `python -c "from job_radar.wizard import run_setup_wizard"` imports without error
</verification>

<success_criteria>
- Wizard offers "Upload resume PDF" and "Fill manually" as first choice
- PDF upload prompts for file path, validates, parses, shows disclaimer once
- Extracted data appears as editable defaults in wizard prompts with sanity checks
- Partial extraction pre-fills available fields, leaves others for manual entry
- All error paths (validation, parsing, unexpected) offer manual fallback
- "Fill manually" skips PDF entirely, proceeds to normal wizard
- PDF option not shown when pdfplumber not installed
- Existing wizard functionality unchanged (back navigation, edit fields, cancel, save)
</success_criteria>

<output>
After completion, create `.planning/phases/15-pdf-resume-parser/15-02-SUMMARY.md`
</output>
