---
phase: 17-application-status-tracking
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - job_radar/report.py
  - job_radar/tracker.py
autonomous: true

must_haves:
  truths:
    - "User can click a status dropdown on any job card and select Applied, Interviewing, Rejected, or Offer"
    - "Selected status appears as a color-coded Bootstrap badge on the job card"
    - "Status change writes to localStorage and shows toast confirmation"
    - "On page load, embedded tracker.json statuses hydrate badges on all matching job cards"
    - "User can export pending status updates as a downloadable JSON file"
  artifacts:
    - path: "job_radar/report.py"
      provides: "Status dropdown UI, status badges, embedded tracker JSON, status management JavaScript"
      contains: "tracker-status"
    - path: "job_radar/tracker.py"
      provides: "get_all_application_statuses() bulk read function"
      contains: "get_all_application_statuses"
  key_links:
    - from: "job_radar/report.py (_generate_html_report)"
      to: "job_radar/tracker.py (get_all_application_statuses)"
      via: "Python function call to embed status data"
      pattern: "get_all_application_statuses"
    - from: "HTML template (script#tracker-status)"
      to: "JavaScript hydration code"
      via: "JSON.parse of embedded script tag on DOMContentLoaded"
      pattern: "getElementById.*tracker-status"
    - from: "JavaScript status change handler"
      to: "localStorage"
      via: "localStorage.setItem on dropdown click"
      pattern: "localStorage\\.setItem.*job-radar-application-status"
    - from: "JavaScript export function"
      to: "Blob download"
      via: "Blob API with pending_sync filter"
      pattern: "exportPendingStatusUpdates"
---

<objective>
Add application status tracking UI to HTML reports with persistent state hydration.

Purpose: Enable users to mark jobs as Applied/Interviewing/Rejected/Offer directly from the HTML report, with status persisting across sessions via embedded tracker.json data and localStorage caching.

Output: Modified report.py with status dropdown UI, badge rendering, state hydration JavaScript, and localStorage sync. Modified tracker.py with bulk status read helper.
</objective>

<execution_context>
@/home/corye/.claude/get-shit-done/workflows/execute-plan.md
@/home/corye/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/17-application-status-tracking/17-RESEARCH.md
@.planning/phases/16-application-flow-essentials/16-01-SUMMARY.md
@job_radar/report.py
@job_radar/tracker.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add tracker bulk read and embed status data in HTML template</name>
  <files>job_radar/tracker.py, job_radar/report.py</files>
  <action>
**tracker.py changes:**

Add a `get_all_application_statuses() -> dict` function that loads tracker.json and returns the entire `applications` dict. This avoids repeated file reads when embedding status for all jobs. Pattern follows existing `get_stats()` which also loads and returns bulk data.

**report.py changes — Python/HTML side:**

1. At top of `_generate_html_report()`, import and call `get_all_application_statuses()` to get all application statuses. Serialize with `json.dumps()` for embedding.

2. In the HTML `<head>` section (after existing style block, before closing `</head>`), add:
   ```html
   <script type="application/json" id="tracker-status">
   {embedded_status_json}
   </script>
   ```
   This safely embeds tracker.json application status data for client-side hydration. The `type="application/json"` prevents execution.

3. Add CSS for status badges and status dropdown in the existing `<style>` block:
   - `.status-badge` — standard badge positioning with `me-2` margin
   - `.status-dropdown` — compact dropdown button sizing
   - `.pending-dot` — small yellow indicator dot for unsynced statuses
   - `.export-status-btn` — styling for the export button

4. Add `data-job-key`, `data-job-title`, and `data-job-company` attributes to job items in BOTH `_html_recommended_section()` and `_html_results_table()`:
   - Job key: use `f"{job.title.lower().strip()}||{job.company.lower().strip()}"` (matches tracker.py `job_key()` format)
   - These attributes enable JavaScript to identify jobs for status operations

5. In `_html_recommended_section()`, for each job card header, add a status dropdown button group after the score badge:
   ```html
   <div class="dropdown d-inline-block ms-2">
     <button class="btn btn-sm btn-outline-secondary dropdown-toggle status-dropdown"
             type="button" data-bs-toggle="dropdown"
             aria-label="Change application status">
       Status
     </button>
     <ul class="dropdown-menu dropdown-menu-end">
       <li><a class="dropdown-item" href="#" data-status="applied">Applied</a></li>
       <li><a class="dropdown-item" href="#" data-status="interviewing">Interviewing</a></li>
       <li><a class="dropdown-item" href="#" data-status="rejected">Rejected</a></li>
       <li><a class="dropdown-item" href="#" data-status="offer">Offer</a></li>
       <li><hr class="dropdown-divider"></li>
       <li><a class="dropdown-item" href="#" data-status="">Clear Status</a></li>
     </ul>
   </div>
   ```

6. In `_html_results_table()`, add a "Status" column (between "New" and "Title"). Each row cell contains same dropdown HTML but more compact. Add the Status `<th>` to the table header.

7. Above the recommended section (near the Copy All button area), add an "Export Status Updates" button:
   ```html
   <button class="btn btn-sm btn-outline-info export-status-btn no-print"
           onclick="exportPendingStatusUpdates()">
     Export Status Updates
   </button>
   ```

IMPORTANT: Use `html.escape()` for all user-supplied data in attributes. The job key in `data-job-key` must use the same format as `tracker.job_key()` to ensure matching.

Do NOT use the `from .tracker import ...` import at module level if it creates a circular dependency. Instead, import inside `_generate_html_report()` with a local import: `from . import tracker`.
  </action>
  <verify>
Run `python -c "from job_radar.report import generate_report; print('OK')"` to confirm no import errors. Then run `python -c "from job_radar.tracker import get_all_application_statuses; print(get_all_application_statuses())"` to confirm the new function works. Grep report.py for: `tracker-status`, `data-job-key`, `data-status=`, `dropdown-toggle`, `export-status-btn`.
  </verify>
  <done>report.py generates HTML with embedded tracker status JSON, status dropdown on every job card and table row, data-job-key attributes on all job items, and export button. tracker.py has get_all_application_statuses() function.</done>
</task>

<task type="auto">
  <name>Task 2: Add status management JavaScript (hydration, change handler, badges, export)</name>
  <files>job_radar/report.py</files>
  <action>
In `_generate_html_report()`, add a new `<script>` block AFTER the existing clipboard/keyboard script block but BEFORE the dark mode handler script. This script implements all status management logic as inline JavaScript (matching Phase 16 pattern for single-file portability).

The JavaScript must implement these functions:

**1. STATUS_CONFIG constant:**
```javascript
var STATUS_CONFIG = {
  applied:      { class: 'bg-success', label: 'Applied' },
  interviewing: { class: 'bg-primary', label: 'Interviewing' },
  rejected:     { class: 'bg-danger',  label: 'Rejected' },
  offer:        { class: 'bg-warning text-dark', label: 'Offer' }
};
```

**2. hydrateApplicationStatus() — called on DOMContentLoaded:**
- Parse embedded tracker status from `document.getElementById('tracker-status').textContent`
- Parse localStorage cache from `localStorage.getItem('job-radar-application-status')`
- Merge: tracker.json entries win for existing keys; localStorage adds new entries with `pending_sync: true`
- Save merged state back to localStorage
- Call `renderAllStatusBadges()` with merged data
- If any pending_sync entries exist, show count on export button

**3. renderAllStatusBadges(statusMap):**
- Query all elements with `[data-job-key]`
- For each, look up status in statusMap by `data-job-key` value
- If status exists, call `renderStatusBadge(element, status, isPending)`

**4. renderStatusBadge(jobElement, status, isPending):**
- Find or create a `.status-badge` span in the job element's header (`.card-header` for cards, parent `<tr>` for table rows)
- Set badge class from STATUS_CONFIG
- Set badge text from STATUS_CONFIG label
- If isPending, append a small pending indicator (title attribute "Pending sync to tracker.json")
- For table rows, render badge in the Status `<td>` cell

**5. Status change click handler (event delegation on document):**
- Listen for clicks on `.dropdown-item[data-status]`
- `event.preventDefault()`
- Find parent `.job-item` or `tr[data-job-key]` element
- Read `data-job-key`, `data-job-title`, `data-job-company` from element
- Load status map from localStorage
- If `data-status` is empty string, delete the entry and remove badge; otherwise set new status with `pending_sync: true` and current ISO timestamp
- Save to localStorage
- Render badge
- Show Notyf toast: "Marked as {Status}" or "Status cleared"

**6. exportPendingStatusUpdates():**
- Load localStorage status map
- Filter entries where `pending_sync === true`
- If none, show error toast "No pending status updates to export"
- Create JSON blob with `{ applications: { ...pendingUpdates } }` structure
- Trigger download with filename `job-status-updates-YYYY-MM-DD.json`
- Show success toast with count

**7. updateExportButtonCount():**
- Count pending_sync entries in localStorage
- Update export button text: "Export Status Updates (N)" or just "Export Status Updates" if 0

**8. DOMContentLoaded listener:**
- Call `hydrateApplicationStatus()`

IMPORTANT implementation notes:
- Use `var` not `let`/`const` for maximum browser compatibility (matching Phase 16 clipboard JS pattern)
- Use `function` declarations not arrow functions
- Use `.then()` not `async/await` where promises are involved
- All string concatenation with `+` operator, not template literals
- localStorage key: `job-radar-application-status`
- Wrap localStorage operations in try/catch to handle QuotaExceededError gracefully
- The `notyf` variable is already initialized in the clipboard script block above
- Python f-string doubles: `{{` for literal JS braces in the f-string template
  </action>
  <verify>
Run `python -c "from job_radar.report import generate_report; print('OK')"` to confirm no syntax errors. Grep report.py for: `hydrateApplicationStatus`, `renderStatusBadge`, `renderAllStatusBadges`, `STATUS_CONFIG`, `exportPendingStatusUpdates`, `job-radar-application-status`, `DOMContentLoaded`, `pending_sync`. All patterns must be present.
  </verify>
  <done>HTML reports contain complete inline JavaScript for status hydration from embedded tracker data, localStorage merge with conflict resolution, status badge rendering with semantic colors, dropdown status change handling with toast feedback, and JSON export of pending status updates.</done>
</task>

</tasks>

<verification>
1. `python -c "from job_radar.report import generate_report; print('OK')"` — no import errors
2. `python -c "from job_radar.tracker import get_all_application_statuses; print(type(get_all_application_statuses()))"` — returns dict
3. Grep report.py for all key patterns: `tracker-status`, `data-job-key`, `STATUS_CONFIG`, `hydrateApplicationStatus`, `renderStatusBadge`, `exportPendingStatusUpdates`, `job-radar-application-status`, `dropdown-item.*data-status`
4. Python syntax check: `python -m py_compile job_radar/report.py` exits 0
5. Python syntax check: `python -m py_compile job_radar/tracker.py` exits 0
</verification>

<success_criteria>
- report.py generates HTML with embedded tracker status JSON in script#tracker-status
- Every job card has a status dropdown with Applied/Interviewing/Rejected/Offer/Clear options
- Every table row has a Status column with the same dropdown options
- Inline JavaScript hydrates status from embedded data + localStorage on page load
- Status changes write to localStorage with pending_sync flag and show toast
- Export button downloads JSON with pending status updates
- All existing clipboard/keyboard functionality preserved (no regressions)
</success_criteria>

<output>
After completion, create `.planning/phases/17-application-status-tracking/17-01-SUMMARY.md`
</output>
