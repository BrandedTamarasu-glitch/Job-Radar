---
phase: 03-test-suite
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - tests/test_tracker.py
autonomous: true

must_haves:
  truths:
    - "job_key generates stable dedup keys regardless of whitespace and casing"
    - "mark_seen marks first-time jobs as is_new=True and repeat jobs as is_new=False"
    - "get_stats returns correct aggregation of total unique jobs, total runs, and avg new per run"
    - "All tracker tests use tmp_path isolation and never touch production tracker.json"
  artifacts:
    - path: "tests/test_tracker.py"
      provides: "Parametrized tracker tests with tmp_path isolation"
      min_lines: 60
  key_links:
    - from: "tests/test_tracker.py"
      to: "job_radar/tracker.py"
      via: "Direct imports of tracker functions"
      pattern: "from job_radar\\.tracker import"
    - from: "tests/test_tracker.py"
      to: "job_radar/tracker.py"
      via: "patch _TRACKER_PATH to tmp_path"
      pattern: "patch.*job_radar\\.tracker\\._TRACKER_PATH"
    - from: "tests/test_tracker.py"
      to: "tests/conftest.py"
      via: "job_factory fixture for creating test JobResults"
      pattern: "def test_.*\\(.*job_factory"
---

<objective>
Create tracker tests covering job_key stability, mark_seen new/seen annotation, and get_stats aggregation -- all isolated with tmp_path to prevent touching production tracker.json.

Purpose: Validates the tracking/dedup system that prevents duplicate job entries across runs. Covers requirements TEST-04, TEST-05, TEST-06.
Output: tests/test_tracker.py with comprehensive parametrized tests using tmp_path isolation.
</objective>

<execution_context>
@/Users/coryebert/.claude/get-shit-done/workflows/execute-plan.md
@/Users/coryebert/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-test-suite/03-RESEARCH.md

@job_radar/tracker.py
@job_radar/sources.py
@tests/conftest.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create tracker tests with tmp_path isolation</name>
  <files>tests/test_tracker.py</files>
  <action>
Create `tests/test_tracker.py` with tests for all tracker functions. Every test that touches the filesystem MUST use `unittest.mock.patch` to redirect `_TRACKER_PATH` to a `tmp_path` location. Import `patch` from `unittest.mock`.

**Required imports:**
```python
import pytest
from unittest.mock import patch
from job_radar.tracker import job_key, mark_seen, get_stats
```

**Required test functions:**

1. `test_job_key_stable()` -- TEST-04
   Parametrize with cases:
   - ("Python Developer", "TestCorp", "python developer||testcorp")  # basic lowering
   - ("  Python Developer  ", "  TestCorp  ", "python developer||testcorp")  # whitespace stripped
   - ("PYTHON DEVELOPER", "TESTCORP", "python developer||testcorp")  # all caps
   - ("Senior Dev", "Company A", "senior dev||company a")  # different title
   Assert job_key(title, company) == expected.
   NOTE: job_key is a pure function -- no tmp_path needed.

2. `test_job_key_different_jobs_differ()` -- TEST-04
   Assert job_key("Python Dev", "CompanyA") != job_key("Java Dev", "CompanyA").
   Assert job_key("Python Dev", "CompanyA") != job_key("Python Dev", "CompanyB").

3. `test_mark_seen_new_job(tmp_path, job_factory)` -- TEST-05
   Patch _TRACKER_PATH to `str(tmp_path / "tracker.json")`.
   Create one job via job_factory, wrap in scored result dict: `{"job": job, "score": {"overall": 4.2}}`.
   Call mark_seen([result]).
   Assert result["is_new"] is True.
   Assert result["first_seen"] is a string (today's date).
   Assert the tracker file exists on disk.

4. `test_mark_seen_repeat_job(tmp_path, job_factory)` -- TEST-05
   Patch _TRACKER_PATH to tmp_path.
   Create one job, call mark_seen twice with the same job.
   First call: assert is_new is True.
   Second call: assert is_new is False.
   Assert first_seen is the same date in both calls.

5. `test_mark_seen_multiple_jobs(tmp_path, job_factory)` -- TEST-05
   Patch _TRACKER_PATH to tmp_path.
   Create 3 different jobs (different titles).
   Call mark_seen with all 3.
   Assert all 3 are is_new=True.
   Call mark_seen again with 2 of the 3 plus 1 new job.
   Assert the 2 repeats are is_new=False and the new one is is_new=True.

6. `test_get_stats_empty(tmp_path)` -- TEST-06
   Patch _TRACKER_PATH to tmp_path (file does not exist).
   Call get_stats().
   Assert total_unique_jobs_seen == 0, total_runs == 0, avg_new_per_run_last_7 == 0.

7. `test_get_stats_after_runs(tmp_path, job_factory)` -- TEST-06
   Patch _TRACKER_PATH to tmp_path.
   Run mark_seen with 5 different jobs.
   Call get_stats().
   Assert total_unique_jobs_seen == 5.
   Assert total_runs == 1.
   Assert avg_new_per_run_last_7 == 5.0.

   Run mark_seen again with 3 new jobs (different titles) + 2 repeats.
   Call get_stats().
   Assert total_unique_jobs_seen == 8.
   Assert total_runs == 2.
   Assert avg_new_per_run_last_7 == 4.0.  # (5+3)/2

8. `test_tracker_never_touches_production()` -- Safety
   This test verifies isolation. Do NOT patch _TRACKER_PATH.
   Instead, verify that the default _TRACKER_PATH points to `results/tracker.json` in cwd.
   Import `_TRACKER_PATH` from `job_radar.tracker`.
   Assert "results/tracker.json" is in _TRACKER_PATH (documents the risk).
   This is a documentation test, not a functional test -- it proves we understand where production data lives.

**Important implementation notes:**
- Use `with patch("job_radar.tracker._TRACKER_PATH", str(tmp_path / "tracker.json")):` for every test that calls mark_seen or get_stats
- The job_factory fixture from conftest.py creates JobResult instances -- use it with varying titles to create distinct jobs
- mark_seen expects `list[dict]` where each dict has "job" (JobResult) and "score" (dict with "overall" key)
- get_stats returns dict with keys: total_unique_jobs_seen, total_runs, avg_new_per_run_last_7
  </action>
  <verify>
Run `.venv/bin/python -m pytest tests/test_tracker.py -v` from the project root. All tests must pass. Then run the full suite: `.venv/bin/python -m pytest tests/ -v` to confirm no conflicts with scoring tests.
Verify production tracker is untouched: `ls results/tracker.json` should show the file is unchanged (or not exist if it never existed).
  </verify>
  <done>
tests/test_tracker.py exists with parametrized tests for job_key stability (TEST-04), mark_seen new/seen annotation (TEST-05), and get_stats aggregation (TEST-06). All tests use tmp_path isolation via patch("job_radar.tracker._TRACKER_PATH"). Full test suite (`pytest tests/ -v`) passes with zero failures. No production tracker.json was created or modified.
  </done>
</task>

</tasks>

<verification>
1. Run `cd "/Users/coryebert/Documents/Job Hunt Python/Project Folder/Job-Radar" && .venv/bin/python -m pytest tests/ -v` -- ALL tests pass (scoring + tracker), zero failures
2. Verify tracker isolation: `git status results/` shows no changes to tracker.json
3. Verify test count: `pytest --collect-only -q | tail -1` should show 40+ tests collected across both files
4. Verify all requirements covered:
   - TEST-04: job_key tests present (grep test_job_key in test_tracker.py)
   - TEST-05: mark_seen tests present with tmp_path (grep test_mark_seen in test_tracker.py)
   - TEST-06: get_stats tests present (grep test_get_stats in test_tracker.py)
</verification>

<success_criteria>
- job_key tests verify stable keys regardless of whitespace/casing and different jobs produce different keys
- mark_seen tests verify is_new=True for first occurrence and is_new=False for repeats
- get_stats tests verify correct aggregation of unique jobs, run count, and average new per run
- ALL tracker tests use tmp_path + patch isolation -- zero production data touched
- Full test suite (scoring + tracker) passes with zero failures
</success_criteria>

<output>
After completion, create `.planning/phases/03-test-suite/03-02-SUMMARY.md`
</output>
