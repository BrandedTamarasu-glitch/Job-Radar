---
phase: 06-core-packaging-infrastructure
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - job_radar/paths.py
  - job_radar/banner.py
  - job_radar/config.py
  - job_radar/__init__.py
  - pyproject.toml
  - tests/test_paths.py
autonomous: true

must_haves:
  truths:
    - "get_resource_path() returns correct path in both dev and frozen (sys._MEIPASS) modes"
    - "get_data_dir() returns platform-appropriate directory (APPDATA on Windows, Application Support on macOS, ~/.local/share on Linux)"
    - "display_banner() prints ASCII art banner with version number and degrades gracefully"
    - "Error logging writes timestamped entries to ~/job-radar-error.log"
    - "Existing tests still pass after config.py changes"
  artifacts:
    - path: "job_radar/paths.py"
      provides: "Resource path resolution and platform data directory helpers"
      exports: ["get_resource_path", "get_data_dir", "get_log_file", "is_frozen"]
    - path: "job_radar/banner.py"
      provides: "Startup banner display and error logging"
      exports: ["display_banner", "log_error_and_exit"]
    - path: "tests/test_paths.py"
      provides: "Unit tests for path resolution in dev mode"
  key_links:
    - from: "job_radar/paths.py"
      to: "sys._MEIPASS"
      via: "getattr(sys, 'frozen', False) check"
      pattern: "getattr\\(sys.*frozen.*False\\)"
    - from: "job_radar/paths.py"
      to: "platformdirs"
      via: "user_data_dir() call"
      pattern: "user_data_dir"
---

<objective>
Create the runtime infrastructure modules that make Job Radar work in both development (python -m job_radar) and PyInstaller frozen (.exe/.app/binary) modes.

Purpose: All packaging depends on two capabilities: (1) resolving resource paths correctly whether running from source or a frozen bundle, and (2) using platform-appropriate directories for user data. This plan creates both, plus the startup banner and error logging required by locked decisions.

Output: Three new modules (paths.py, banner.py) and updated config.py/pyproject.toml with new dependencies. Existing functionality preserved.
</objective>

<execution_context>
@/Users/coryebert/.claude/get-shit-done/workflows/execute-plan.md
@/Users/coryebert/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-core-packaging-infrastructure/06-RESEARCH.md
@job_radar/__init__.py
@job_radar/__main__.py
@job_radar/config.py
@job_radar/search.py
@pyproject.toml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create paths.py and banner.py modules</name>
  <files>
    job_radar/paths.py
    job_radar/banner.py
  </files>
  <action>
Create `job_radar/paths.py` with these functions:

```python
"""Path resolution for both development and PyInstaller frozen modes."""

import sys
from pathlib import Path


def is_frozen() -> bool:
    """Check if running in a PyInstaller bundle."""
    return getattr(sys, 'frozen', False) and hasattr(sys, '_MEIPASS')


def get_resource_path(relative_path: str) -> Path:
    """Get absolute path to a bundled resource.

    In development: resolves relative to the job_radar package directory.
    In frozen mode: resolves relative to sys._MEIPASS (PyInstaller bundle root).
    """
    if is_frozen():
        base_path = Path(sys._MEIPASS)
    else:
        # In dev, resources live alongside the package
        base_path = Path(__file__).parent
    return base_path / relative_path


def get_data_dir() -> Path:
    """Get platform-specific user data directory. Creates it if missing.

    Windows: %APPDATA%\\JobRadar
    macOS:   ~/Library/Application Support/JobRadar
    Linux:   ~/.local/share/JobRadar
    """
    from platformdirs import user_data_dir
    data_dir = Path(user_data_dir("JobRadar", "JobRadar"))
    data_dir.mkdir(parents=True, exist_ok=True)
    return data_dir


def get_log_file() -> Path:
    """Get error log path: ~/job-radar-error.log."""
    return Path.home() / 'job-radar-error.log'
```

Create `job_radar/banner.py` with these functions:

```python
"""Startup banner and error logging for Job Radar."""

import sys
from datetime import datetime
from pathlib import Path

from .paths import get_log_file


def display_banner(version: str = "1.1") -> None:
    """Display 'Job Radar v1.1' ASCII art banner on launch.

    Uses pyfiglet with 'slant' font. Falls back to simple text
    banner if pyfiglet is unavailable or fails.
    """
    try:
        import pyfiglet
        banner = pyfiglet.figlet_format("Job Radar", font="slant")
        print(banner.rstrip())
        print(f"  Version {version}\n")
    except Exception:
        print("=" * 50)
        print(f"  Job Radar v{version}")
        print("=" * 50)
        print()


def log_error_and_exit(error_message: str, exception: Exception | None = None) -> None:
    """Log error to ~/job-radar-error.log and exit with brief console message."""
    error_log = get_log_file()

    try:
        with open(error_log, 'a', encoding='utf-8') as f:
            timestamp = datetime.now().isoformat()
            f.write(f"[{timestamp}] {error_message}\n")
            if exception:
                f.write(f"  Exception: {type(exception).__name__}: {exception}\n")
    except Exception:
        pass  # Fail silently if can't write log

    print(f"Error: {error_message}")
    print(f"Details logged to: {error_log}")
    sys.exit(1)
```

IMPORTANT notes:
- Use pathlib.Path exclusively, never os.sep or string concatenation for paths (research recommendation)
- pyfiglet import is inside display_banner() so it fails gracefully if missing
- platformdirs import is inside get_data_dir() to keep module import lightweight
- get_data_dir() creates the directory on access (mkdir parents=True, exist_ok=True)
- Locked decision: error log goes to ~/job-radar-error.log (user's home directory)
- Locked decision: banner shows "Job Radar v1.1" with ASCII art decoration
  </action>
  <verify>
    Run `python -c "from job_radar.paths import get_resource_path, get_data_dir, get_log_file, is_frozen; print(get_resource_path('test.txt')); print(get_data_dir()); print(get_log_file()); print(is_frozen())"` -- should print valid paths and False for is_frozen.
    Run `python -c "from job_radar.banner import display_banner; display_banner()"` -- should print ASCII art banner.
  </verify>
  <done>
    paths.py exports is_frozen(), get_resource_path(), get_data_dir(), get_log_file().
    banner.py exports display_banner(), log_error_and_exit().
    Both modules import cleanly and run in development mode.
    get_data_dir() returns platform-appropriate path.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update dependencies and config.py for platformdirs</name>
  <files>
    pyproject.toml
    job_radar/__init__.py
    job_radar/config.py
    tests/test_paths.py
  </files>
  <action>
1. Update `pyproject.toml`:
   - Change version from "0.4.0" to "1.1.0"
   - Add new dependencies to the dependencies list: "platformdirs>=4.0", "pyfiglet", "colorama"
   - Keep existing dependencies: "requests", "beautifulsoup4"
   - Add "certifi" to dependencies (explicit, for SSL in frozen builds)
   - Full dependencies line: `dependencies = ["requests", "beautifulsoup4", "platformdirs>=4.0", "pyfiglet", "colorama", "certifi"]`

2. Update `job_radar/__init__.py`:
   - Change `__version__` from "1.0.0" to "1.1.0"

3. Update `job_radar/config.py`:
   - Import get_data_dir from .paths
   - Change `DEFAULT_CONFIG_PATH = Path("~/.job-radar/config.json")` to use get_data_dir():
     ```python
     def _default_config_path() -> Path:
         """Return default config path, using platform-appropriate directory."""
         from .paths import get_data_dir
         return get_data_dir() / "config.json"
     ```
   - Update load_config() to call `_default_config_path()` instead of using the constant
   - IMPORTANT: For backward compatibility, also check the legacy path `~/.job-radar/config.json` if the new path doesn't exist. This ensures existing v1.0 users don't lose their config:
     ```python
     LEGACY_CONFIG_PATH = Path("~/.job-radar/config.json")
     ```
     In load_config(), if platform path doesn't exist, fall back to LEGACY_CONFIG_PATH.expanduser()

4. Create `tests/test_paths.py`:
   ```python
   """Tests for job_radar.paths module."""
   import sys
   from pathlib import Path
   from unittest.mock import patch

   from job_radar.paths import get_resource_path, get_data_dir, get_log_file, is_frozen


   def test_is_frozen_returns_false_in_dev():
       assert is_frozen() is False


   def test_is_frozen_returns_true_when_frozen():
       with patch.object(sys, 'frozen', True, create=True):
           with patch.object(sys, '_MEIPASS', '/tmp/fake_meipass', create=True):
               assert is_frozen() is True


   def test_get_resource_path_dev_mode():
       result = get_resource_path('resources/test.txt')
       # In dev mode, should be relative to paths.py's parent (job_radar/)
       expected_parent = Path(__file__).parent.parent / 'job_radar'
       assert result.parent.parent == expected_parent.parent or 'job_radar' in str(result)


   def test_get_resource_path_frozen_mode():
       with patch.object(sys, 'frozen', True, create=True):
           with patch.object(sys, '_MEIPASS', '/tmp/fake_bundle', create=True):
               result = get_resource_path('resources/test.txt')
               assert str(result) == str(Path('/tmp/fake_bundle/resources/test.txt'))


   def test_get_data_dir_returns_path():
       result = get_data_dir()
       assert isinstance(result, Path)
       assert result.exists()
       assert 'JobRadar' in str(result) or 'jobradar' in str(result).lower()


   def test_get_log_file_in_home():
       result = get_log_file()
       assert result == Path.home() / 'job-radar-error.log'
   ```

5. Install the new dependencies in the project venv:
   Run `pip install platformdirs pyfiglet colorama certifi` in the project's venv.

6. Run `pytest` to confirm all existing tests still pass AND new tests pass.
  </action>
  <verify>
    `pip list | grep -i platformdirs` shows platformdirs installed.
    `pip list | grep -i pyfiglet` shows pyfiglet installed.
    `pytest tests/` passes all tests (existing 78 + new path tests).
    `python -c "from job_radar.config import load_config; print(load_config())"` works without error.
  </verify>
  <done>
    pyproject.toml has version 1.1.0 and all six dependencies listed.
    __init__.py shows __version__ = "1.1.0".
    config.py uses platformdirs-based default path with legacy fallback.
    All tests pass (existing + new test_paths.py).
    New dependencies installed in venv.
  </done>
</task>

</tasks>

<verification>
1. `python -c "from job_radar.paths import *; print(get_resource_path('x'), get_data_dir(), get_log_file(), is_frozen())"` -- all four functions work
2. `python -c "from job_radar.banner import display_banner; display_banner()"` -- prints ASCII banner
3. `python -c "from job_radar.config import load_config; load_config()"` -- no errors
4. `python -m pytest tests/` -- all tests pass
5. `python -m job_radar --help` -- still works (backward compatibility)
</verification>

<success_criteria>
- paths.py provides working resource resolution for dev mode (frozen mode tested via mock)
- banner.py displays ASCII art banner with version
- config.py uses platform-appropriate directory with legacy fallback
- All 78+ existing tests pass, plus new test_paths.py tests
- New dependencies (platformdirs, pyfiglet, colorama, certifi) installed
- Version bumped to 1.1.0
</success_criteria>

<output>
After completion, create `.planning/phases/06-core-packaging-infrastructure/06-01-SUMMARY.md`
</output>
