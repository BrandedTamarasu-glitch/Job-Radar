---
phase: 16-application-flow-essentials
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - job_radar/report.py
autonomous: true

must_haves:
  truths:
    - "Each job card and table row has a visible Copy URL button"
    - "A Copy All Recommended button appears above the recommended section"
    - "Clicking any Copy URL button copies that job's URL to clipboard"
    - "Clicking Copy All copies all score>=3.5 job URLs separated by newlines"
    - "Pressing C key copies focused job URL to clipboard"
    - "Pressing A key copies all recommended URLs to clipboard"
    - "Every copy action shows a toast notification confirming success or failure"
    - "Job items are focusable via Tab key with visible focus indicators"
    - "Keyboard shortcuts do not fire when typing in input fields"
    - "Ctrl+C and other browser shortcuts are not blocked"
  artifacts:
    - path: "job_radar/report.py"
      provides: "HTML report with copy buttons, keyboard shortcuts, clipboard JS, toast notifications"
      contains: "data-job-url"
  key_links:
    - from: "Copy URL button onclick"
      to: "copyToClipboard() function"
      via: "inline onclick handler"
      pattern: "copyToClipboard"
    - from: "keydown event listener"
      to: "copyFocusedJobUrl / copyAllRecommendedUrls"
      via: "event.key check"
      pattern: "event\\.key"
    - from: "copyToClipboard success"
      to: "notyf.success()"
      via: "promise resolution"
      pattern: "notyf\\.success"
---

<objective>
Add copy-to-clipboard functionality, keyboard shortcuts, and toast notifications to the HTML job report.

Purpose: Users currently waste 5-10 minutes per session manually selecting and copying job URLs. This plan adds one-click copy buttons per job, a "Copy All Recommended" batch action, and keyboard shortcuts ('C' for focused, 'A' for all) with visual toast feedback.

Output: Modified `job_radar/report.py` with complete clipboard + keyboard + notification functionality embedded in the HTML report.
</objective>

<execution_context>
@/home/corye/.claude/get-shit-done/workflows/execute-plan.md
@/home/corye/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/16-application-flow-essentials/16-RESEARCH.md
@job_radar/report.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add data attributes, copy buttons, CDN links, and CSS to HTML template</name>
  <files>job_radar/report.py</files>
  <action>
Modify _generate_html_report() and its helper functions in job_radar/report.py to add the structural HTML elements needed for clipboard functionality:

**1. Add Notyf CDN to the HTML head section** (inside _generate_html_report):
- Add Notyf CSS: `<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/notyf@3/notyf.min.css">`
- Place it after the Bootstrap CSS link

**2. Add Notyf JS to the HTML body** (before closing `</body>` tag):
- Add: `<script src="https://cdn.jsdelivr.net/npm/notyf@3/notyf.min.js"></script>`
- Place it after the Bootstrap JS script

**3. Add custom CSS** to the existing `<style>` block in the head:
```css
/* Copy button styling */
.copy-btn {{
  font-size: 0.75rem;
  padding: 0.2em 0.5em;
  margin-left: 0.5em;
  transition: background-color 0.2s ease;
}}
.copy-btn.copied {{
  background-color: #28a745 !important;
  border-color: #28a745 !important;
  color: white !important;
}}

/* Focus indicators for keyboard navigation */
.job-item:focus-visible {{
  outline: 2px solid #005fcc;
  outline-offset: 2px;
  border-radius: 4px;
}}

/* Copy All button styling */
.copy-all-btn {{
  transition: background-color 0.2s ease;
}}
.copy-all-btn.copied {{
  background-color: #28a745 !important;
  border-color: #28a745 !important;
}}

/* Keyboard shortcut hint */
.shortcut-hint {{
  font-size: 0.8rem;
  color: var(--bs-secondary-color);
}}
```

**4. Add data attributes and tabindex to recommended job cards** in _html_recommended_section():
- On each card's outer div (`<div class="card mb-3">`), add: `class="card mb-3 job-item" tabindex="0" data-job-url="{html.escape(job.url)}" data-score="{score_val:.1f}"`
- After the existing link `</li>` in the details list, add a "Copy URL" button:
  `<li><button class="btn btn-sm btn-outline-secondary copy-btn" onclick="copySingleUrl(this)" data-url="{html.escape(job.url)}">Copy URL</button></li>`
- Only add the copy button and data-job-url if `job.url` is truthy

**5. Add data attributes and copy button to table rows** in _html_results_table():
- On each `<tr>`, add: `class="job-item" tabindex="0" data-job-url="{html.escape(job.url)}" data-score="{score:.1f}"`
- In the last `<td>` (link column), after the existing View button/link, add a copy button:
  `<button class="btn btn-sm btn-outline-secondary copy-btn" onclick="copySingleUrl(this)" data-url="{html.escape(job.url)}">Copy</button>`
- Only add data-job-url and copy button if `job.url` is truthy

**6. Add "Copy All Recommended" button** in _html_recommended_section():
- Before the cards_html output, add a div with a button and keyboard hint:
  ```html
  <div class="d-flex align-items-center mb-3">
    <button class="btn btn-primary copy-all-btn" onclick="copyAllRecommendedUrls(this)">
      Copy All Recommended URLs
    </button>
    <span class="shortcut-hint ms-2">Keyboard: <kbd>C</kbd> = copy focused, <kbd>A</kbd> = copy all</span>
  </div>
  ```
- Only show this button if there are recommended results

Note: All f-string curly braces in the Python template must be doubled ({{ }}) except for variable interpolations. Be careful with the existing f-string patterns in report.py.
  </action>
  <verify>
Run `python -c "from job_radar.report import generate_report; print('import ok')"` to verify no syntax errors.
Run `grep -c 'data-job-url' job_radar/report.py` to confirm data attributes were added (expect >= 2 occurrences).
Run `grep -c 'copy-btn' job_radar/report.py` to confirm copy buttons were added (expect >= 2).
Run `grep -c 'notyf' job_radar/report.py` to confirm Notyf CDN was added (expect >= 2).
  </verify>
  <done>
HTML template includes: Notyf CDN (CSS+JS), custom CSS for copy buttons and focus indicators, data-job-url and data-score attributes on job items, tabindex="0" on focusable items, Copy URL buttons on cards and table rows, Copy All Recommended button with keyboard hint.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add inline JavaScript for clipboard, keyboard shortcuts, and toast notifications</name>
  <files>job_radar/report.py</files>
  <action>
Add an inline `<script>` block to _generate_html_report() AFTER the Notyf JS CDN script tag and BEFORE the dark mode handler script. This script implements all clipboard, keyboard, focus, and notification logic:

```javascript
// Initialize Notyf toast notifications
const notyf = new Notyf({{
  duration: 3000,
  position: {{ x: 'right', y: 'top' }},
  dismissible: true
}});

// Two-tier clipboard: Clipboard API (HTTPS/localhost) with execCommand fallback (file://)
async function copyToClipboard(text) {{
  if (typeof navigator.clipboard === 'object') {{
    try {{
      await navigator.clipboard.writeText(text);
      return true;
    }} catch (err) {{
      console.warn('[clipboard] API failed, trying fallback', err);
    }}
  }}
  // Fallback for file:// protocol
  const ta = document.createElement('textarea');
  ta.value = text;
  ta.style.position = 'fixed';
  ta.style.opacity = '0';
  document.body.appendChild(ta);
  ta.focus({{ preventScroll: true }});
  ta.select();
  try {{
    const ok = document.execCommand('copy');
    ta.remove();
    return ok;
  }} catch (err) {{
    console.error('[clipboard] execCommand failed', err);
    ta.remove();
    return false;
  }}
}}

// Copy single URL from button click
function copySingleUrl(btn) {{
  const url = btn.dataset.url;
  if (!url) {{ notyf.error('No URL available'); return; }}
  copyToClipboard(url).then(function(ok) {{
    if (ok) {{
      notyf.success('Job URL copied to clipboard');
      btn.classList.add('copied');
      btn.textContent = 'Copied!';
      setTimeout(function() {{
        btn.classList.remove('copied');
        btn.textContent = btn.closest('tr') ? 'Copy' : 'Copy URL';
      }}, 2000);
    }} else {{
      notyf.error('Copy failed — try Ctrl+C');
    }}
  }});
}}

// Copy all recommended URLs (score >= 3.5)
function copyAllRecommendedUrls(btn) {{
  const items = document.querySelectorAll('.job-item[data-job-url][data-score]');
  const urls = Array.from(items)
    .filter(function(el) {{
      var s = parseFloat(el.dataset.score);
      return !isNaN(s) && s >= 3.5;
    }})
    .map(function(el) {{ return el.dataset.jobUrl; }})
    .filter(function(u) {{ return u && u.length > 0; }});

  if (urls.length === 0) {{
    notyf.error('No recommended jobs found (score >= 3.5)');
    return;
  }}

  copyToClipboard(urls.join('\\n')).then(function(ok) {{
    if (ok) {{
      notyf.success(urls.length + ' job URL' + (urls.length > 1 ? 's' : '') + ' copied to clipboard');
      if (btn) {{
        btn.classList.add('copied');
        btn.textContent = 'Copied ' + urls.length + ' URLs!';
        setTimeout(function() {{
          btn.classList.remove('copied');
          btn.textContent = 'Copy All Recommended URLs';
        }}, 2000);
      }}
    }} else {{
      notyf.error('Copy failed — try selecting URLs manually');
    }}
  }});
}}

// Track focused job item for keyboard shortcuts
var currentFocusedJob = null;
document.querySelectorAll('.job-item').forEach(function(item) {{
  item.addEventListener('focus', function() {{ currentFocusedJob = item; }});
  item.addEventListener('blur', function() {{
    if (currentFocusedJob === item) currentFocusedJob = null;
  }});
}});

// Keyboard shortcuts: C = copy focused, A = copy all recommended
document.addEventListener('keydown', function(event) {{
  // Don't interfere with form inputs
  if (event.target.matches('input, textarea, select')) return;
  // Don't interfere with browser shortcuts (Ctrl+C, Ctrl+A, etc.)
  if (event.ctrlKey || event.metaKey || event.altKey) return;

  var key = event.key.toLowerCase();

  if (key === 'c') {{
    event.preventDefault();
    if (!currentFocusedJob) {{
      notyf.error('No job focused — click a job or use Tab to navigate');
      return;
    }}
    var url = currentFocusedJob.dataset.jobUrl;
    if (!url) {{
      notyf.error('Focused job has no URL');
      return;
    }}
    copyToClipboard(url).then(function(ok) {{
      if (ok) notyf.success('Job URL copied to clipboard');
      else notyf.error('Copy failed — try Ctrl+C');
    }});
  }} else if (key === 'a') {{
    event.preventDefault();
    copyAllRecommendedUrls(document.querySelector('.copy-all-btn'));
  }}
}});
```

IMPORTANT f-string notes for report.py:
- All JavaScript `{` and `}` must be doubled to `{{` and `}}` since this is inside a Python f-string
- Variable interpolations from Python (if any) use single braces
- The `\\n` in `urls.join('\\n')` needs to be `'\\n'` in the f-string to produce `'\n'` in the output
- Test by generating a report and inspecting the HTML source to verify braces are correct

Place this script block in the html_content f-string in _generate_html_report(), after the Notyf JS CDN `<script>` tag and before the dark mode handler `<script>`.
  </action>
  <verify>
Run `python -c "from job_radar.report import generate_report; print('import ok')"` to confirm no syntax errors.
Run `grep -c 'copyToClipboard' job_radar/report.py` to confirm clipboard function exists (expect >= 1).
Run `grep -c 'keydown' job_radar/report.py` to confirm keyboard handler exists (expect >= 1).
Run `grep -c 'notyf' job_radar/report.py` to confirm toast integration (expect >= 4).
Run existing tests: `python -m pytest tests/test_report.py -v` -- all existing tests must still pass (no regression).
  </verify>
  <done>
Inline JavaScript in HTML report implements: two-tier copyToClipboard (Clipboard API + execCommand fallback), copySingleUrl for button clicks with visual button state change, copyAllRecommendedUrls filtering score>=3.5 with newline separator, focus tracking for keyboard navigation, keydown listener for 'C' and 'A' shortcuts with input field protection and modifier key passthrough, Notyf toast for success/error feedback. All existing report tests pass.
  </done>
</task>

</tasks>

<verification>
1. `python -c "from job_radar.report import generate_report; print('ok')"` -- module imports without error
2. `python -m pytest tests/test_report.py -v` -- all existing tests pass (no regression)
3. Generated HTML contains: `data-job-url`, `copy-btn`, `copyToClipboard`, `notyf`, `keydown`, `copy-all-btn`
</verification>

<success_criteria>
- report.py generates HTML with copy buttons on every job card and table row
- HTML includes Notyf CDN (CSS + JS) for toast notifications
- Inline JavaScript handles clipboard (with file:// fallback), keyboard shortcuts, and toasts
- All 9 existing test_report.py tests pass without modification
</success_criteria>

<output>
After completion, create `.planning/phases/16-application-flow-essentials/16-01-SUMMARY.md`
</output>
