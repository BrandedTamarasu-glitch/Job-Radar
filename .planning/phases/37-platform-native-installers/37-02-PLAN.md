---
phase: 37-platform-native-installers
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - installers/windows/installer.nsi
  - installers/windows/build-installer.bat
  - installers/windows/license.txt
  - installers/windows/generate-assets.py
autonomous: true

must_haves:
  truths:
    - "Running build-installer.bat with PyInstaller output produces a setup .exe"
    - "NSIS installer shows Modern UI wizard with license agreement requiring I agree checkbox"
    - "Installer creates Start Menu shortcuts always and Desktop shortcut optionally"
    - "Installed app appears in Windows Add/Remove Programs with version, publisher, and uninstall options"
    - "Windows recognizes .jobprofile files after installation (shell notified via SHChangeNotify)"
    - "Dual uninstall: Add/Remove Programs offers GUI uninstall via app and quick NSIS remove"
  artifacts:
    - path: "installers/windows/installer.nsi"
      provides: "NSIS installer script with Modern UI, license, shortcuts, registry, file association"
      contains: "MUI2.nsh"
    - path: "installers/windows/build-installer.bat"
      provides: "Windows installer build automation with conditional code signing"
      contains: "makensis"
    - path: "installers/windows/license.txt"
      provides: "License text displayed during installation"
      contains: "MIT License"
    - path: "installers/windows/generate-assets.py"
      provides: "Generates header.bmp (150x57) and sidebar.bmp (164x314) branding images"
      contains: "PIL"
  key_links:
    - from: "installers/windows/installer.nsi"
      to: "Add/Remove Programs"
      via: "HKLM registry writes"
      pattern: "CurrentVersion.Uninstall.JobRadar"
    - from: "installers/windows/installer.nsi"
      to: ".jobprofile association"
      via: "HKCR registry writes + SHChangeNotify"
      pattern: "SHChangeNotify"
    - from: "installers/windows/build-installer.bat"
      to: "installer.nsi"
      via: "makensis compilation"
      pattern: "makensis"
---

<objective>
Create the Windows NSIS installer script with Modern UI wizard, license agreement, configurable shortcuts, Add/Remove Programs integration, .jobprofile file association, and dual uninstall support.

Purpose: Windows users get a professional setup wizard instead of a raw .zip archive. The installer provides license agreement, installation location choice, optional desktop shortcut, Start Menu integration, proper system registration, and dual uninstall (GUI with backup via app or quick NSIS remove).

Output: `installers/windows/installer.nsi` (NSIS script), `installers/windows/build-installer.bat` (build automation), `installers/windows/license.txt` (license text), `installers/windows/generate-assets.py` (branding images).
</objective>

<execution_context>
@/Users/coryebert/.claude/get-shit-done/workflows/execute-plan.md
@/Users/coryebert/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/37-platform-native-installers/37-RESEARCH.md
@job-radar.spec
@LICENSE
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create NSIS installer script with Modern UI</name>
  <files>
    installers/windows/installer.nsi
    installers/windows/license.txt
  </files>
  <action>
Create `installers/windows/` directory structure.

**license.txt:** Copy the MIT License text from the project `LICENSE` file. This is displayed in the installer's license agreement page.

**installer.nsi:** Create a full NSIS Modern UI 2 installer script:

```nsis
# Job Radar Windows Installer
# Built with NSIS Modern UI 2

!include "MUI2.nsh"
!include "FileFunc.nsh"
!include "LogicLib.nsh"

# ---- Metadata ----
!define PRODUCT_NAME "Job Radar"
!define PRODUCT_PUBLISHER "Job Radar"
!define PRODUCT_WEB_SITE "https://github.com/coryebert/Job-Radar"
!define PRODUCT_UNINST_KEY "Software\Microsoft\Windows\CurrentVersion\Uninstall\JobRadar"
!define PRODUCT_DIR_REG_KEY "Software\JobRadar"

# Version passed via /DVERSION= at compile time
!ifndef VERSION
  !define VERSION "dev"
!endif

Name "${PRODUCT_NAME} ${VERSION}"
OutFile "Job-Radar-Setup-${VERSION}.exe"
InstallDir "$PROGRAMFILES\Job Radar"
InstallDirRegKey HKLM "${PRODUCT_DIR_REG_KEY}" "InstallDir"
RequestExecutionLevel admin
SetCompressor /SOLID lzma

# ---- Branding ----
!define MUI_ICON "..\..\icon.png"
!define MUI_UNICON "..\..\icon.png"
!define MUI_HEADERIMAGE
!define MUI_HEADERIMAGE_BITMAP "header.bmp"
!define MUI_HEADERIMAGE_RIGHT
!define MUI_WELCOMEFINISHPAGE_BITMAP "sidebar.bmp"
!define MUI_UNWELCOMEFINISHPAGE_BITMAP "sidebar.bmp"
!define MUI_ABORTWARNING

# ---- Variables ----
Var DesktopShortcut

# ---- Pages ----
!insertmacro MUI_PAGE_WELCOME
!insertmacro MUI_PAGE_LICENSE "license.txt"
!insertmacro MUI_PAGE_DIRECTORY
Page custom ShortcutsPage ShortcutsPageLeave
!insertmacro MUI_PAGE_INSTFILES
!define MUI_FINISHPAGE_RUN "$INSTDIR\job-radar-gui.exe"
!define MUI_FINISHPAGE_RUN_TEXT "Launch Job Radar"
!insertmacro MUI_PAGE_FINISH

# Uninstaller pages
!insertmacro MUI_UNPAGE_WELCOME
!insertmacro MUI_UNPAGE_CONFIRM
!insertmacro MUI_UNPAGE_INSTFILES
!insertmacro MUI_UNPAGE_FINISH

# Language
!insertmacro MUI_LANGUAGE "English"

# ---- Shortcuts Page (Custom) ----
Function ShortcutsPage
  nsDialogs::Create 1018
  Pop $0
  ${NSD_CreateCheckBox} 10 10 100% 12u "Create Desktop shortcut"
  Pop $1
  ${NSD_SetState} $1 ${BST_CHECKED}
  nsDialogs::Show
FunctionEnd

Function ShortcutsPageLeave
  ${NSD_GetState} $1 $DesktopShortcut
FunctionEnd

# ---- Install Section ----
Section "Install" SecInstall
  SetOutPath "$INSTDIR"

  # Copy all PyInstaller output files
  File /r "..\..\dist\job-radar\*.*"

  # Create Start Menu shortcuts (always)
  CreateDirectory "$SMPROGRAMS\${PRODUCT_NAME}"
  CreateShortcut "$SMPROGRAMS\${PRODUCT_NAME}\Job Radar.lnk" "$INSTDIR\job-radar-gui.exe" "" "$INSTDIR\job-radar-gui.exe" 0
  CreateShortcut "$SMPROGRAMS\${PRODUCT_NAME}\Job Radar (CLI).lnk" "$INSTDIR\job-radar.exe" "" "$INSTDIR\job-radar.exe" 0
  CreateShortcut "$SMPROGRAMS\${PRODUCT_NAME}\Uninstall Job Radar.lnk" "$INSTDIR\Uninstall.exe" "" "$INSTDIR\Uninstall.exe" 0

  # Desktop shortcut (optional, default checked)
  ${If} $DesktopShortcut == ${BST_CHECKED}
    CreateShortcut "$DESKTOP\Job Radar.lnk" "$INSTDIR\job-radar-gui.exe" "" "$INSTDIR\job-radar-gui.exe" 0
  ${EndIf}

  # ---- File Association: .jobprofile ----
  WriteRegStr HKCR ".jobprofile" "" "JobRadarProfile"
  WriteRegStr HKCR "JobRadarProfile" "" "Job Radar Profile"
  WriteRegStr HKCR "JobRadarProfile\DefaultIcon" "" "$INSTDIR\job-radar-gui.exe,0"
  WriteRegStr HKCR "JobRadarProfile\shell\open\command" "" '"$INSTDIR\job-radar-gui.exe" "%1"'
  # Notify shell of association change
  System::Call 'shell32::SHChangeNotify(i 0x08000000, i 0, p 0, p 0)'

  # ---- Write Uninstaller ----
  WriteUninstaller "$INSTDIR\Uninstall.exe"

  # ---- Add/Remove Programs Registry ----
  WriteRegStr HKLM "${PRODUCT_UNINST_KEY}" "DisplayName" "${PRODUCT_NAME}"
  WriteRegStr HKLM "${PRODUCT_UNINST_KEY}" "UninstallString" '"$INSTDIR\Uninstall.exe"'
  WriteRegStr HKLM "${PRODUCT_UNINST_KEY}" "QuietUninstallString" '"$INSTDIR\Uninstall.exe" /S'
  WriteRegStr HKLM "${PRODUCT_UNINST_KEY}" "DisplayVersion" "${VERSION}"
  WriteRegStr HKLM "${PRODUCT_UNINST_KEY}" "Publisher" "${PRODUCT_PUBLISHER}"
  WriteRegStr HKLM "${PRODUCT_UNINST_KEY}" "URLInfoAbout" "${PRODUCT_WEB_SITE}"
  WriteRegStr HKLM "${PRODUCT_UNINST_KEY}" "DisplayIcon" "$INSTDIR\job-radar-gui.exe,0"
  WriteRegDWORD HKLM "${PRODUCT_UNINST_KEY}" "NoModify" 1
  WriteRegDWORD HKLM "${PRODUCT_UNINST_KEY}" "NoRepair" 1

  # Save install directory for future reference
  WriteRegStr HKLM "${PRODUCT_DIR_REG_KEY}" "InstallDir" "$INSTDIR"

  # Calculate and write installed size (KB)
  ${GetSize} "$INSTDIR" "/S=0K" $0 $1 $2
  IntFmt $0 "0x%08X" $0
  WriteRegDWORD HKLM "${PRODUCT_UNINST_KEY}" "EstimatedSize" $0

SectionEnd

# ---- Uninstall Section ----
Section "Uninstall"
  # Remove installed files
  RMDir /r "$INSTDIR"

  # Remove shortcuts
  Delete "$DESKTOP\Job Radar.lnk"
  RMDir /r "$SMPROGRAMS\${PRODUCT_NAME}"

  # Remove file association
  DeleteRegKey HKCR ".jobprofile"
  DeleteRegKey HKCR "JobRadarProfile"
  System::Call 'shell32::SHChangeNotify(i 0x08000000, i 0, p 0, p 0)'

  # Remove install directory registry
  DeleteRegKey HKLM "${PRODUCT_DIR_REG_KEY}"

  # Remove from Add/Remove Programs (LAST)
  DeleteRegKey HKLM "${PRODUCT_UNINST_KEY}"
SectionEnd
```

Important NSIS details:
- `SetCompressor /SOLID lzma` for best compression (per research pitfall 6)
- `RequestExecutionLevel admin` for Program Files access
- `InstallDirRegKey` remembers install location across upgrades
- SHChangeNotify called after both install AND uninstall file association changes
- Registry key deletion is LAST in uninstall (per research pitfall 3)
- Version defined externally via `/DVERSION=` so CI can inject git tag
- MUI_FINISHPAGE_RUN offers to launch app after install
- Custom shortcuts page with checkbox for Desktop shortcut
  </action>
  <verify>
Verify `installers/windows/installer.nsi` exists and contains key patterns:
- `!include "MUI2.nsh"` (Modern UI 2)
- `SHChangeNotify` (shell notification)
- `PRODUCT_UNINST_KEY` (Add/Remove Programs)
- `SetCompressor /SOLID lzma` (compression)
- `QuietUninstallString` (silent uninstall)
Verify `installers/windows/license.txt` contains "MIT License".
  </verify>
  <done>
NSIS script exists with Modern UI 2, license page, custom shortcuts page with Desktop shortcut checkbox, Start Menu shortcuts, .jobprofile file association with SHChangeNotify, full Add/Remove Programs registry entries with EstimatedSize, and conditional version via /DVERSION=.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Windows build script and branding asset generator</name>
  <files>
    installers/windows/build-installer.bat
    installers/windows/generate-assets.py
  </files>
  <action>
**generate-assets.py:** Create a Python script using Pillow to generate NSIS branding images:

1. **header.bmp** (150x57 pixels) - Wizard header image:
   - Dark navy background (#1a1a2e)
   - "Job Radar" text in white, right-aligned
   - Small radar/target icon element if possible with PIL drawing
   - BMP format required by NSIS

2. **sidebar.bmp** (164x314 pixels) - Welcome/Finish page sidebar:
   - Dark navy gradient background
   - "Job Radar" logo text vertically centered
   - Version text at bottom
   - BMP format required by NSIS

Script should be runnable standalone: `python installers/windows/generate-assets.py`
Use only Pillow (already a build dependency).

**build-installer.bat:** Create a Windows batch script:

```batch
@echo off
setlocal enabledelayedexpansion

set VERSION=%1
if "%VERSION%"=="" set VERSION=dev

set SCRIPT_DIR=%~dp0
set PROJECT_ROOT=%SCRIPT_DIR%..\..

echo === Job Radar Windows Installer Build ===
echo Version: %VERSION%

:: Check NSIS is available
where makensis >nul 2>&1
if errorlevel 1 (
    echo ERROR: NSIS not found. Install from https://nsis.sourceforge.io/Download
    echo   Or run: choco install nsis -y
    exit /b 1
)

:: Check PyInstaller output exists
if not exist "%PROJECT_ROOT%\dist\job-radar\job-radar.exe" (
    echo ERROR: dist\job-radar\ not found. Run PyInstaller first.
    exit /b 1
)

:: Generate branding assets if not present
if not exist "%SCRIPT_DIR%header.bmp" (
    echo Generating branding assets...
    python "%SCRIPT_DIR%generate-assets.py"
)

:: Build installer
echo Building NSIS installer...
makensis /DVERSION=%VERSION% "%SCRIPT_DIR%installer.nsi"

if errorlevel 1 (
    echo ERROR: NSIS build failed
    exit /b 1
)

echo.
set INSTALLER_NAME=Job-Radar-Setup-%VERSION%.exe
echo Installer created: %INSTALLER_NAME%

:: Conditional code signing
if defined WINDOWS_CERT_BASE64 (
    echo Signing installer with code signing certificate...

    :: Decode certificate
    powershell -Command "[IO.File]::WriteAllBytes('%TEMP%\certificate.pfx', [Convert]::FromBase64String($env:WINDOWS_CERT_BASE64))"

    :: Find signtool
    set SIGNTOOL=
    for /f "delims=" %%i in ('where signtool 2^>nul') do set SIGNTOOL=%%i
    if "!SIGNTOOL!"=="" (
        for /f "delims=" %%i in ('dir /s /b "C:\Program Files (x86)\Windows Kits\10\bin\*\x64\signtool.exe" 2^>nul') do set SIGNTOOL=%%i
    )

    if "!SIGNTOOL!"=="" (
        echo WARNING: signtool.exe not found. Skipping code signing.
    ) else (
        "!SIGNTOOL!" sign /f "%TEMP%\certificate.pfx" /p "%WINDOWS_CERT_PASSWORD%" /tr http://timestamp.digicert.com /td sha256 /fd sha256 "%INSTALLER_NAME%"
        if errorlevel 1 (
            echo ERROR: Code signing failed
            del "%TEMP%\certificate.pfx"
            exit /b 1
        )
        "!SIGNTOOL!" verify /pa "%INSTALLER_NAME%"
        echo Installer signed successfully
    )
    del "%TEMP%\certificate.pfx"
) else (
    echo NOTE: No signing certificate found ^(WINDOWS_CERT_BASE64 not set^)
    echo   Installer is unsigned - users will see SmartScreen warning
    echo   See installers\README.md for bypass instructions
)

echo.
echo Build complete!
```

Ensure the batch file works from the `installers/windows/` directory and from CI where the current directory may differ.
  </action>
  <verify>
Verify `installers/windows/build-installer.bat` exists and contains `makensis` and conditional signing.
Run `python installers/windows/generate-assets.py` and confirm `header.bmp` (150x57) and `sidebar.bmp` (164x314) are created.
  </verify>
  <done>
build-installer.bat exists with NSIS compilation, version injection, pre-flight checks, and conditional code signing with signtool.
generate-assets.py creates header.bmp (150x57) and sidebar.bmp (164x314) with Job Radar branding.
  </done>
</task>

</tasks>

<verification>
1. `installers/windows/installer.nsi` exists with MUI2, license, shortcuts, registry, file association
2. `installers/windows/build-installer.bat` exists with makensis and conditional signing
3. `installers/windows/license.txt` contains MIT license text
4. `installers/windows/generate-assets.py` produces header.bmp and sidebar.bmp
5. NSIS script includes SHChangeNotify for file association refresh
6. NSIS script includes QuietUninstallString for silent uninstall
7. NSIS script uses /SOLID lzma compression
</verification>

<success_criteria>
- NSIS installer script exists with full Modern UI wizard flow (welcome, license, directory, shortcuts, install, finish)
- All required Add/Remove Programs registry entries present (DisplayName, UninstallString, QuietUninstallString, DisplayVersion, Publisher, URLInfoAbout, EstimatedSize)
- .jobprofile file association registered with SHChangeNotify
- Build automation script with version injection, pre-flight checks, and conditional signing
- Branding assets generated programmatically (no manual image creation needed)
</success_criteria>

<output>
After completion, create `.planning/phases/37-platform-native-installers/37-02-SUMMARY.md`
</output>
