---
phase: 37-platform-native-installers
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - installers/macos/build-dmg.sh
  - installers/macos/generate-background.py
  - job-radar.spec
autonomous: true

must_haves:
  truths:
    - "Running build-dmg.sh with a PyInstaller .app bundle produces a DMG file"
    - "DMG opens with custom branded background showing drag arrow and icon layout"
    - "DMG contains JobRadar.app and Applications folder symlink in correct positions"
    - "macOS recognizes .jobprofile files as belonging to Job Radar (Info.plist CFBundleDocumentTypes)"
  artifacts:
    - path: "installers/macos/build-dmg.sh"
      provides: "DMG creation automation script with conditional signing"
      contains: "create-dmg"
    - path: "installers/macos/generate-background.py"
      provides: "Programmatic DMG background image generation (800x500)"
      contains: "PIL"
    - path: "job-radar.spec"
      provides: "Updated PyInstaller spec with CFBundleDocumentTypes for .jobprofile"
      contains: "CFBundleDocumentTypes"
  key_links:
    - from: "installers/macos/build-dmg.sh"
      to: "dist/JobRadar.app"
      via: "create-dmg command"
      pattern: "create-dmg.*JobRadar\\.app"
    - from: "job-radar.spec"
      to: ".jobprofile file association"
      via: "Info.plist CFBundleDocumentTypes"
      pattern: "CFBundleDocumentTypes"
---

<objective>
Create the macOS DMG installer build script with custom branded background, drag-to-Applications layout, and .jobprofile file association.

Purpose: macOS users get a professional DMG installer experience instead of a raw .zip archive. The DMG includes a custom background with the Job Radar logo, a drag arrow pointing from the app icon to the Applications folder, and proper file association for future .jobprofile sharing.

Output: `installers/macos/build-dmg.sh` (create-dmg automation), `installers/macos/generate-background.py` (programmatic background image), updated `job-radar.spec` with CFBundleDocumentTypes.
</objective>

<execution_context>
@/Users/coryebert/.claude/get-shit-done/workflows/execute-plan.md
@/Users/coryebert/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/37-platform-native-installers/37-RESEARCH.md
@job-radar.spec
@icon.png
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create DMG background generator and build script</name>
  <files>
    installers/macos/generate-background.py
    installers/macos/build-dmg.sh
  </files>
  <action>
Create `installers/macos/` directory structure.

**generate-background.py:** Create a Python script using Pillow (PIL) to generate the DMG background image (800x500 pixels). The background should:
- Use a gradient or solid branded background color (dark navy #1a1a2e or similar professional dark tone)
- Draw the Job Radar logo text ("Job Radar" in white/light font, centered near top, ~36pt)
- Draw a tagline below logo ("Drag to Applications to install" in lighter color, ~18pt)
- Draw a prominent right-pointing arrow (unicode arrow or drawn with PIL) in the center area between where the app icon (x=200, y=190) and Applications folder (x=600, y=190) will be positioned
- Arrow should be white or light colored, clearly visible
- Add subtle branding elements (version text at bottom, etc.)
- Save as `installers/macos/dmg-background.png`
- Script should be runnable standalone: `python installers/macos/generate-background.py`
- Use only Pillow (already a build dependency in pyproject.toml `[build]` extras)

**build-dmg.sh:** Create a shell script that automates DMG creation using create-dmg:
```bash
#!/bin/bash
set -euo pipefail

VERSION="${1:-dev}"
SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
PROJECT_ROOT="$(cd "$SCRIPT_DIR/../.." && pwd)"
APP_PATH="${PROJECT_ROOT}/dist/JobRadar.app"
DMG_NAME="Job-Radar-${VERSION}-macos.dmg"

# Validate app exists
if [ ! -d "$APP_PATH" ]; then
    echo "ERROR: $APP_PATH not found. Run PyInstaller first."
    exit 1
fi

# Generate background if not present
if [ ! -f "$SCRIPT_DIR/dmg-background.png" ]; then
    echo "Generating DMG background..."
    python3 "$SCRIPT_DIR/generate-background.py"
fi

# Remove stale DMG if exists (create-dmg fails otherwise)
rm -f "$DMG_NAME"

# Build DMG with create-dmg
create-dmg \
  --volname "Job Radar Installer" \
  --background "$SCRIPT_DIR/dmg-background.png" \
  --window-pos 200 120 \
  --window-size 800 500 \
  --icon-size 128 \
  --text-size 12 \
  --icon "JobRadar.app" 200 190 \
  --hide-extension "JobRadar.app" \
  --app-drop-link 600 190 \
  --format UDZO \
  "$DMG_NAME" \
  "$APP_PATH"

echo "DMG created: $DMG_NAME"

# Conditional code signing
if [ -n "${MACOS_CERT_BASE64:-}" ]; then
    echo "Signing DMG with Apple Developer certificate..."
    KEYCHAIN_PASSWORD="${KEYCHAIN_PASSWORD:-build123}"
    echo "$MACOS_CERT_BASE64" | base64 --decode > /tmp/certificate.p12
    security create-keychain -p "$KEYCHAIN_PASSWORD" build.keychain || true
    security default-keychain -s build.keychain
    security unlock-keychain -p "$KEYCHAIN_PASSWORD" build.keychain
    security import /tmp/certificate.p12 -k build.keychain \
        -P "${MACOS_CERT_PASSWORD:-}" -T /usr/bin/codesign
    security set-key-partition-list -S apple-tool:,apple:,codesign: \
        -s -k "$KEYCHAIN_PASSWORD" build.keychain
    codesign --force --sign "${MACOS_SIGNING_IDENTITY:-Developer ID Application}" \
        --timestamp --options runtime "$DMG_NAME"
    codesign --verify --verbose=2 "$DMG_NAME"
    security delete-keychain build.keychain
    rm /tmp/certificate.p12
    echo "DMG signed successfully"
else
    echo "NOTE: No signing certificate found (MACOS_CERT_BASE64 not set)"
    echo "  DMG is unsigned - users will see Gatekeeper warning"
    echo "  See installers/README.md for bypass instructions"
fi
```

Make the script executable (`chmod +x`).
  </action>
  <verify>
Run `ls -la installers/macos/build-dmg.sh` and confirm executable bit is set.
Run `python installers/macos/generate-background.py` and confirm `installers/macos/dmg-background.png` is created (800x500).
Run `bash -n installers/macos/build-dmg.sh` to validate shell syntax.
  </verify>
  <done>
build-dmg.sh exists, is executable, passes shell syntax check, and uses create-dmg with --window-size 800 500, --icon at 200 190, --app-drop-link at 600 190, and conditional code signing.
generate-background.py creates a 800x500 PNG with branding and drag arrow.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add .jobprofile file association to macOS Info.plist</name>
  <files>job-radar.spec</files>
  <action>
Update the `info_plist` dictionary in the macOS `BUNDLE(...)` section of `job-radar.spec` to add CFBundleDocumentTypes for .jobprofile file extension.

Add these keys to the existing `info_plist` dict:

```python
info_plist={
    'NSHighResolutionCapable': 'True',
    'LSBackgroundOnly': 'False',
    'CFBundleDocumentTypes': [
        {
            'CFBundleTypeName': 'Job Radar Profile',
            'CFBundleTypeExtensions': ['jobprofile'],
            'CFBundleTypeRole': 'Editor',
            'LSHandlerRank': 'Owner',
        },
    ],
    'CFBundleShortVersionString': '2.1.0',
    'CFBundleVersion': '2.1.0',
},
```

This tells macOS that Job Radar handles .jobprofile files, enabling future profile sharing/import via double-click.

Also add `CFBundleShortVersionString` and `CFBundleVersion` keys so the version shows in macOS Get Info.
  </action>
  <verify>
Run `python -c "exec(open('job-radar.spec').read())"` â€” no syntax errors.
Grep for CFBundleDocumentTypes in job-radar.spec.
  </verify>
  <done>
job-radar.spec BUNDLE info_plist contains CFBundleDocumentTypes with .jobprofile extension, CFBundleShortVersionString, and CFBundleVersion. Spec file parses without errors.
  </done>
</task>

</tasks>

<verification>
1. `installers/macos/build-dmg.sh` exists and is executable
2. `installers/macos/generate-background.py` runs and produces 800x500 PNG
3. `job-radar.spec` contains CFBundleDocumentTypes for .jobprofile
4. build-dmg.sh validates create-dmg options: --window-size 800 500, icon positions, conditional signing
5. Shell syntax check passes: `bash -n installers/macos/build-dmg.sh`
</verification>

<success_criteria>
- macOS build script exists with create-dmg automation and conditional code signing
- DMG background image generator creates branded 800x500 background with drag arrow
- PyInstaller spec declares .jobprofile file association for macOS
- All scripts pass syntax validation
</success_criteria>

<output>
After completion, create `.planning/phases/37-platform-native-installers/37-01-SUMMARY.md`
</output>
