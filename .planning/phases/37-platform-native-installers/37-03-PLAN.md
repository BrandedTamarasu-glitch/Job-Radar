---
phase: 37-platform-native-installers
plan: 03
type: execute
wave: 2
depends_on: ["37-01", "37-02"]
files_modified:
  - .github/workflows/release.yml
  - installers/README.md
  - job_radar/update_config.py
autonomous: true

must_haves:
  truths:
    - "GitHub Actions release workflow builds DMG on macOS and NSIS installer on Windows"
    - "Installer artifacts are uploaded to GitHub Releases alongside existing archives"
    - "README documents unsigned installer warnings and bypass steps for both platforms"
    - "Update check config file exists with JSON schema for future auto-update"
    - "CI conditional signing runs when secrets present, skips cleanly when absent"
  artifacts:
    - path: ".github/workflows/release.yml"
      provides: "Extended release workflow with build-installers job"
      contains: "build-installers"
    - path: "installers/README.md"
      provides: "Documentation for unsigned installer warnings and bypass instructions"
      contains: "Gatekeeper"
    - path: "job_radar/update_config.py"
      provides: "Auto-update configuration infrastructure with JSON schema"
      contains: "UPDATE_CHECK_URL"
  key_links:
    - from: ".github/workflows/release.yml"
      to: "installers/macos/build-dmg.sh"
      via: "build-installers job macOS step"
      pattern: "build-dmg\\.sh"
    - from: ".github/workflows/release.yml"
      to: "installers/windows/build-installer.bat"
      via: "build-installers job Windows step"
      pattern: "build-installer\\.bat"
    - from: ".github/workflows/release.yml"
      to: "GitHub Releases"
      via: "softprops/action-gh-release with installer files"
      pattern: "action-gh-release"
---

<objective>
Extend the CI/CD release workflow to build and publish platform-native installers, create documentation for unsigned installer warnings, and prepare auto-update infrastructure.

Purpose: Automate installer creation in GitHub Actions so every tagged release produces DMG (macOS) and NSIS setup.exe (Windows) installers alongside existing archives. Document bypass instructions for unsigned installer warnings. Prepare foundation for future auto-update feature.

Output: Updated `.github/workflows/release.yml` with build-installers job, `installers/README.md` with bypass instructions, `job_radar/update_config.py` with auto-update JSON schema.
</objective>

<execution_context>
@/Users/coryebert/.claude/get-shit-done/workflows/execute-plan.md
@/Users/coryebert/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/37-platform-native-installers/37-RESEARCH.md
@.github/workflows/release.yml
@.planning/phases/37-platform-native-installers/37-01-SUMMARY.md
@.planning/phases/37-platform-native-installers/37-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend release workflow with installer builds</name>
  <files>.github/workflows/release.yml</files>
  <action>
Add a new `build-installers` job to the existing release.yml workflow. This job runs AFTER the existing `build` job (uses its artifacts) and BEFORE the existing `release` job.

**New job: `build-installers`**

```yaml
  build-installers:
    name: Build ${{ matrix.platform }} installer
    needs: build
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: macos-latest
            platform: macos
            artifact_name: job-radar-macos
          - os: windows-latest
            platform: windows
            artifact_name: job-radar-windows
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install Pillow (for asset generation)
        run: pip install Pillow

      - name: Download PyInstaller artifact
        uses: actions/download-artifact@v4
        with:
          name: ${{ matrix.artifact_name }}

      - name: Extract macOS artifact
        if: runner.os == 'macOS'
        run: |
          mkdir -p dist
          # The artifact is a .zip containing JobRadar.app
          unzip job-radar-${{ github.ref_name }}-macos.zip -d dist/

      - name: Extract Windows artifact
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path dist
          Expand-Archive -Path job-radar-${{ github.ref_name }}-windows.zip -DestinationPath dist/

      - name: Install create-dmg (macOS)
        if: runner.os == 'macOS'
        run: brew install create-dmg

      - name: Install NSIS (Windows)
        if: runner.os == 'Windows'
        run: choco install nsis -y

      - name: Build DMG installer (macOS)
        if: runner.os == 'macOS'
        run: |
          chmod +x installers/macos/build-dmg.sh
          installers/macos/build-dmg.sh ${{ github.ref_name }}
        env:
          MACOS_CERT_BASE64: ${{ secrets.MACOS_CERT_BASE64 }}
          MACOS_CERT_PASSWORD: ${{ secrets.MACOS_CERT_PASSWORD }}
          MACOS_SIGNING_IDENTITY: ${{ secrets.MACOS_SIGNING_IDENTITY }}

      - name: Build NSIS installer (Windows)
        if: runner.os == 'Windows'
        shell: cmd
        run: |
          cd installers\windows
          build-installer.bat ${{ github.ref_name }}
        env:
          WINDOWS_CERT_BASE64: ${{ secrets.WINDOWS_CERT_BASE64 }}
          WINDOWS_CERT_PASSWORD: ${{ secrets.WINDOWS_CERT_PASSWORD }}

      - name: Upload DMG artifact (macOS)
        if: runner.os == 'macOS'
        uses: actions/upload-artifact@v4
        with:
          name: installer-macos
          path: "*.dmg"

      - name: Upload installer artifact (Windows)
        if: runner.os == 'Windows'
        uses: actions/upload-artifact@v4
        with:
          name: installer-windows
          path: "installers/windows/Job-Radar-Setup-*.exe"
```

**Update the existing `release` job:**
- Change `needs: build` to `needs: [build, build-installers]`
- Add installer artifacts to the download step
- Add installer files to the release files glob:

```yaml
  release:
    name: Create Release
    needs: [build, build-installers]
    runs-on: ubuntu-latest
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          generate_release_notes: true
          files: |
            job-radar-*/job-radar-${{ github.ref_name }}-*
            installer-macos/*.dmg
            installer-windows/*.exe
```

Important details:
- The build-installers job downloads the archives uploaded by the build job, extracts them, then runs the platform-specific build scripts
- Signing environment variables are passed from GitHub Secrets (empty when secrets not configured = conditional signing skips cleanly)
- Both platform jobs run in parallel (matrix strategy)
- The release job now waits for both build AND build-installers before creating the GitHub Release
- Installer artifacts are uploaded separately so they appear in the release alongside the existing .zip/.tar.gz archives
  </action>
  <verify>
Verify `.github/workflows/release.yml` contains:
- `build-installers` job with matrix (macos-latest, windows-latest)
- `needs: build` on build-installers
- `needs: [build, build-installers]` on release
- `brew install create-dmg` for macOS
- `choco install nsis` for Windows
- Installer artifacts in release files glob
Run `python -c "import yaml; yaml.safe_load(open('.github/workflows/release.yml'))"` or use `actionlint` if available to validate YAML syntax.
  </verify>
  <done>
release.yml has build-installers job that builds DMG on macOS and NSIS installer on Windows after PyInstaller build, with conditional signing, and the release job includes installer artifacts in GitHub Releases.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create installer README and auto-update config</name>
  <files>
    installers/README.md
    job_radar/update_config.py
  </files>
  <action>
**installers/README.md:** Create documentation for unsigned installer warnings:

```markdown
# Installing Job Radar

## Security Warnings for Unsigned Installers

Job Radar installers are currently **unsigned**. This means your operating system
will show security warnings when you try to run the installer. This is normal
for open-source software without paid code signing certificates.

### macOS: Gatekeeper Warning

When you open the DMG or try to run Job Radar, macOS may show:
> "JobRadar.app" cannot be opened because the developer cannot be verified.

**To bypass:**
1. Right-click (or Control-click) on JobRadar.app
2. Select "Open" from the context menu
3. Click "Open" in the dialog that appears
4. macOS will remember your choice for future launches

Alternatively:
1. Go to System Settings > Privacy & Security
2. Scroll down to the "Security" section
3. You'll see a message about JobRadar.app being blocked
4. Click "Open Anyway"

### Windows: SmartScreen Warning

When you run the installer, Windows may show:
> Windows protected your PC - Microsoft Defender SmartScreen prevented
> an unrecognized app from starting.

**To bypass:**
1. Click "More info" (text link below the warning message)
2. Click "Run anyway"
3. Proceed with installation normally

### Why Are Installers Unsigned?

Code signing certificates cost $100-400/year per platform. As an open-source
project, we prioritize features over certificates. Signed installers are planned
for a future release.

The source code is fully available at https://github.com/coryebert/Job-Radar
for verification.

## Building Installers Locally

### macOS DMG
```
# Requires: create-dmg (brew install create-dmg), Pillow (pip install Pillow)
pyinstaller job-radar.spec --clean
installers/macos/build-dmg.sh VERSION
```

### Windows NSIS
```
# Requires: NSIS (choco install nsis -y), Pillow (pip install Pillow)
pyinstaller job-radar.spec --clean
cd installers\windows
build-installer.bat VERSION
```

## Code Signing (CI/CD)

Installers are automatically signed when GitHub Secrets are configured:

### macOS
- `MACOS_CERT_BASE64`: Base64-encoded .p12 certificate
- `MACOS_CERT_PASSWORD`: Certificate password
- `MACOS_SIGNING_IDENTITY`: Signing identity (e.g., "Developer ID Application: Name")

### Windows
- `WINDOWS_CERT_BASE64`: Base64-encoded .pfx certificate
- `WINDOWS_CERT_PASSWORD`: Certificate password

When secrets are not set, installers build successfully but remain unsigned.
```

**job_radar/update_config.py:** Create auto-update infrastructure module:

```python
"""Auto-update configuration infrastructure.

Prepares the foundation for future auto-update feature.
Does NOT implement the update mechanism itself - just the
configuration and version comparison utilities.

Future phases will add:
- GUI notification when update available
- Download and install workflow
"""

import json
import logging
from pathlib import Path
from typing import Optional

log = logging.getLogger(__name__)

# URL where update manifest JSON is hosted
# Will be populated when GitHub Pages or similar hosting is configured
UPDATE_CHECK_URL = "https://coryebert.github.io/Job-Radar/update.json"

# Update manifest schema:
# {
#     "version": "2.1.0",
#     "min_version": "2.0.0",
#     "release_url": "https://github.com/coryebert/Job-Radar/releases/latest",
#     "macos_dmg_url": "https://github.com/.../Job-Radar-v2.1.0-macos.dmg",
#     "windows_exe_url": "https://github.com/.../Job-Radar-Setup-v2.1.0.exe",
#     "linux_tar_url": "https://github.com/.../job-radar-v2.1.0-linux.tar.gz",
#     "changelog": "https://github.com/coryebert/Job-Radar/blob/main/CHANGELOG.md"
# }


def parse_version(version_str: str) -> tuple[int, ...]:
    """Parse a version string like '2.1.0' into a comparable tuple (2, 1, 0)."""
    try:
        # Strip leading 'v' if present
        cleaned = version_str.lstrip("v")
        return tuple(int(p) for p in cleaned.split("."))
    except (ValueError, AttributeError):
        log.warning("Could not parse version: %s", version_str)
        return (0, 0, 0)


def is_update_available(
    current_version: str, latest_version: str
) -> bool:
    """Check if latest_version is newer than current_version."""
    return parse_version(latest_version) > parse_version(current_version)


def is_version_supported(
    current_version: str, min_version: str
) -> bool:
    """Check if current_version meets the minimum version requirement."""
    return parse_version(current_version) >= parse_version(min_version)


def get_update_config() -> dict:
    """Return the update configuration dictionary.

    Returns a dict with UPDATE_CHECK_URL and other config
    that future auto-update code will use.
    """
    return {
        "check_url": UPDATE_CHECK_URL,
        "enabled": False,  # Disabled until auto-update is implemented
    }
```

This module provides:
1. UPDATE_CHECK_URL constant (configurable endpoint)
2. Version parsing and comparison utilities
3. Update manifest JSON schema documented in comments
4. `get_update_config()` for future GUI to check if updates should be checked
5. `enabled: False` flag so nothing runs until the feature is implemented
  </action>
  <verify>
Verify `installers/README.md` contains:
- "Gatekeeper" (macOS bypass instructions)
- "SmartScreen" (Windows bypass instructions)
- "MACOS_CERT_BASE64" (signing secrets documentation)
- Build instructions for both platforms

Verify `job_radar/update_config.py`:
- Run `python -c "from job_radar.update_config import parse_version, is_update_available; assert is_update_available('2.0.0', '2.1.0'); assert not is_update_available('2.1.0', '2.0.0'); print('OK')"` to validate version comparison.
- Contains UPDATE_CHECK_URL constant
- Contains get_update_config() function
  </verify>
  <done>
installers/README.md documents macOS Gatekeeper and Windows SmartScreen bypass steps, local build instructions, and CI signing secrets documentation.
job_radar/update_config.py provides version parsing, comparison, update manifest schema, and disabled-by-default config for future auto-update.
  </done>
</task>

</tasks>

<verification>
1. `.github/workflows/release.yml` has build-installers job with macOS and Windows matrix
2. Release job depends on both build and build-installers
3. Installer artifacts included in GitHub Release files
4. `installers/README.md` has bypass instructions for both platforms
5. `job_radar/update_config.py` passes version comparison unit tests
6. Conditional signing in CI checks for secrets presence and skips cleanly when absent
</verification>

<success_criteria>
- CI/CD pipeline builds DMG and NSIS installers automatically on tagged releases
- Installers appear in GitHub Releases alongside existing .zip/.tar.gz archives
- README provides clear, actionable bypass instructions for unsigned installer warnings on both platforms
- Auto-update config module exists with version comparison utilities and disabled-by-default flag
- Conditional signing infrastructure ready for future certificate addition
</success_criteria>

<output>
After completion, create `.planning/phases/37-platform-native-installers/37-03-SUMMARY.md`
</output>
