---
phase: 08-entry-point-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - job_radar/config.py
  - job_radar/wizard.py
  - job_radar/search.py
  - job_radar/__main__.py
autonomous: true

must_haves:
  truths:
    - "User on repeat run (profile.json exists) skips wizard and goes directly to search without --profile flag"
    - "User running python -m job_radar in development mode gets identical behavior to frozen executable"
    - "Wizard-generated profile flows into search automatically via config.json profile_path field"
    - "CLI --profile flag overrides config.json profile_path setting"
    - "Corrupt or missing profile triggers wizard re-run with backup of corrupt file"
    - "--no-wizard flag skips wizard checks and requires --profile"
    - "--validate-profile flag validates profile JSON and exits without running search"
  artifacts:
    - path: "job_radar/config.py"
      provides: "profile_path in KNOWN_KEYS for config precedence"
      contains: "profile_path"
    - path: "job_radar/wizard.py"
      provides: "profile_path field written to config.json"
      contains: "profile_path"
    - path: "job_radar/search.py"
      provides: "load_profile_with_recovery(), --no-wizard, --validate-profile, profile path fallback"
      contains: "load_profile_with_recovery"
    - path: "job_radar/__main__.py"
      provides: "--no-wizard flag support in first-run check"
      contains: "no_wizard"
  key_links:
    - from: "job_radar/wizard.py"
      to: "config.json"
      via: "profile_path field in config_data dict"
      pattern: "profile_path.*str\\(profile_path\\)"
    - from: "job_radar/search.py"
      to: "job_radar/config.py"
      via: "load_config returns profile_path from KNOWN_KEYS"
      pattern: "profile_path.*config"
    - from: "job_radar/search.py"
      to: "job_radar/wizard.py"
      via: "local import of run_setup_wizard in load_profile_with_recovery"
      pattern: "from .wizard import run_setup_wizard"
    - from: "job_radar/__main__.py"
      to: "job_radar/search.py"
      via: "search_main() receives args with profile resolved from config"
      pattern: "search_main"
---

<objective>
Connect wizard to search pipeline: wizard-created profiles auto-flow into search via config.json bridge, with validation recovery, developer flags, and full backward compatibility.

Purpose: After Phase 7 created the wizard, search.py still requires explicit `--profile` flag. This plan makes profile path automatic (wizard writes it to config.json, search reads it) while preserving CLI override and adding error recovery.

Output: Modified config.py (profile_path in KNOWN_KEYS), wizard.py (writes profile_path to config.json), search.py (load_profile_with_recovery, --no-wizard, --validate-profile, profile path fallback), __main__.py (--no-wizard support).
</objective>

<execution_context>
@/Users/coryebert/.claude/get-shit-done/workflows/execute-plan.md
@/Users/coryebert/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/REQUIREMENTS.md
@.planning/phases/08-entry-point-integration/08-CONTEXT.md
@.planning/phases/08-entry-point-integration/08-RESEARCH.md
@.planning/phases/07-interactive-setup-wizard/07-01-SUMMARY.md
@.planning/phases/07-interactive-setup-wizard/07-02-SUMMARY.md

Source files to modify:
@job_radar/config.py
@job_radar/wizard.py
@job_radar/search.py
@job_radar/__main__.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add profile_path to config.py and wizard.py config output</name>
  <files>job_radar/config.py, job_radar/wizard.py</files>
  <action>
  **config.py changes:**
  1. Add "profile_path" to KNOWN_KEYS set (line 22): `KNOWN_KEYS = {"min_score", "new_only", "output", "profile_path"}`
  2. Remove the comment on line 20 that says `"profile" excluded: required=True...` since profile is no longer required=True. Replace with: `# "config" excluded: circular reference.`

  **wizard.py changes:**
  1. In run_setup_wizard(), after building config_data dict (around line 324), add profile_path field:
     ```python
     config_data = {
         "min_score": float(answers['min_score']),
         "new_only": answers['new_only'],
         "profile_path": str(data_dir / "profile.json"),
     }
     ```
     Note: `data_dir` is already computed later (line 468). Move the `data_dir = get_data_dir()` line BEFORE config_data construction so profile_path can reference it. Currently data_dir is computed on line 468, profile_path on line 469, config_path on line 470. Restructure so data_dir is computed before config_data, then profile_path and config_path use data_dir.

  IMPORTANT: Use absolute path (from get_data_dir()) in profile_path, NOT tilde path, to avoid expansion issues (Pitfall 4 from RESEARCH.md).
  </action>
  <verify>
  - `python -c "from job_radar.config import KNOWN_KEYS; assert 'profile_path' in KNOWN_KEYS; print('OK')"` prints OK
  - `grep -n 'profile_path' job_radar/config.py job_radar/wizard.py` shows profile_path in both files
  </verify>
  <done>config.py recognizes profile_path as valid key (no warning on load), wizard.py writes profile_path to config.json output</done>
</task>

<task type="auto">
  <name>Task 2: Refactor search.py with profile path resolution, recovery, and developer flags</name>
  <files>job_radar/search.py, job_radar/__main__.py</files>
  <action>
  **search.py changes:**

  1. **Add `--no-wizard` and `--validate-profile` flags** to parse_args() function:
     ```python
     parser.add_argument(
         "--no-wizard",
         action="store_true",
         help="Skip first-run wizard (use with --profile for testing)",
     )
     parser.add_argument(
         "--validate-profile",
         metavar="PATH",
         help="Validate profile JSON and exit without searching",
     )
     ```

  2. **Add `load_profile_with_recovery()` function** after existing `load_profile()`:
     - Import shutil at top of file (add to existing imports)
     - Function signature: `def load_profile_with_recovery(path: str, _retry: int = 0) -> dict:`
     - Max retry check: if `_retry > 1`, print error with suggestion to use --profile flag, then `sys.exit(1)`
     - Expand path with `Path(path).expanduser()` (Pitfall 4 fix)
     - Check 1: File missing -> print message -> local import `from .wizard import run_setup_wizard` -> run wizard -> recursive call with `_retry + 1`
     - Check 2: JSONDecodeError -> backup to `{path}.bak` using `shutil.copy()` -> print corruption message with backup location -> run wizard -> recursive call
     - Check 3: Missing required fields (name, target_titles, core_skills) -> backup -> run wizard -> recursive call
     - Check 4: target_titles/core_skills not list or empty -> backup -> run wizard -> recursive call
     - On wizard failure (returns False): print "Setup cancelled" and sys.exit(1)
     - On success: return validated profile dict
     - Use local imports for wizard (`from .wizard import run_setup_wizard`) to avoid circular imports (Pitfall 2)
     - Use existing C color class for output formatting

  3. **Refactor main() function** (currently lines 318-507):
     - Profile resolution block: Replace the current "Check for required --profile flag" block (lines 327-340) with:
       ```python
       # Profile path resolution: CLI --profile > config.json profile_path > default location
       if args.validate_profile:
           # Debug mode: validate and exit
           try:
               profile = load_profile(args.validate_profile)
               print(f"\n{C.GREEN}Profile valid:{C.RESET} {args.validate_profile}")
               print(f"  Name: {profile['name']}")
               print(f"  Titles: {len(profile['target_titles'])}")
               print(f"  Skills: {len(profile['core_skills'])}")
               sys.exit(0)
           except SystemExit:
               raise  # Re-raise sys.exit from load_profile
           except Exception as e:
               print(f"\n{C.RED}Profile invalid:{C.RESET} {e}")
               sys.exit(1)

       profile_path_str = args.profile
       if not profile_path_str:
           # No CLI flag - use default wizard profile location
           from .paths import get_data_dir
           profile_path_str = str(get_data_dir() / "profile.json")

       if args.no_wizard:
           # Developer mode - use load_profile (no wizard recovery)
           profile = load_profile(profile_path_str)
       else:
           # Normal mode - use recovery (auto-wizard on corrupt/missing)
           profile = load_profile_with_recovery(profile_path_str)
       ```
     - Remove the old `profile = load_profile(args.profile)` line (around line 365) since profile is now loaded earlier
     - Keep `name = profile["name"]` right after profile loading

  **__main__.py changes:**

  4. **Update first-run check to respect --no-wizard flag:**
     The current first-run check in __main__.py (lines 28-44) runs wizard before search. With Phase 8, the wizard can also be triggered by `load_profile_with_recovery()` in search.py. Update __main__.py to pass through `--no-wizard` by doing a quick pre-parse:

     Replace the current first-run wizard block (lines 28-44) with:
     ```python
     # First-run setup wizard (skip if --no-wizard flag present)
     import argparse as _argparse
     _pre = _argparse.ArgumentParser(add_help=False)
     _pre.add_argument("--no-wizard", action="store_true")
     _pre_args, _ = _pre.parse_known_args()

     if not _pre_args.no_wizard:
         try:
             from job_radar.wizard import is_first_run, run_setup_wizard
             if is_first_run():
                 print("\nWelcome to Job Radar!")
                 print("Let's set up your profile before your first search.\n")
                 if not run_setup_wizard():
                     print("\nSetup cancelled. Run again when you're ready!")
                     sys.exit(0)
                 print()  # Blank line before search starts
         except ImportError:
             pass  # questionary not installed -- skip wizard (dev mode without extras)
         except Exception:
             pass  # Wizard failure is non-critical -- user can still use --profile flag
     ```

  IMPORTANT NOTES:
  - Do NOT use emojis in error/success messages in search.py (checkmarks are OK using the C color class)
  - Keep all existing search.py functionality intact (scoring, filtering, reporting, etc.)
  - The `import shutil` goes at the top with other stdlib imports
  - load_profile_with_recovery uses local wizard import to avoid circular import (Pitfall 2)
  </action>
  <verify>
  - `python -c "from job_radar.search import load_profile_with_recovery; print('import OK')"` succeeds
  - `python -m job_radar --help` shows --no-wizard and --validate-profile flags
  - `python -m job_radar --validate-profile profiles/_template.json` validates and exits (or errors if template is incomplete)
  - Existing tests still pass: `python -m pytest tests/ -x -q`
  </verify>
  <done>
  search.py has load_profile_with_recovery() with wizard re-run on corrupt/missing profiles, --no-wizard and --validate-profile flags, profile path resolved from config.json with CLI override. __main__.py respects --no-wizard flag. All existing functionality preserved.
  </done>
</task>

</tasks>

<verification>
Run full test suite to ensure no regressions:
```bash
python -m pytest tests/ -x -q
```

Verify new imports work:
```bash
python -c "from job_radar.config import KNOWN_KEYS; print('profile_path' in KNOWN_KEYS)"
python -c "from job_radar.search import load_profile_with_recovery; print('OK')"
```

Verify --help shows new flags:
```bash
python -m job_radar --help 2>&1 | grep -E "(no-wizard|validate-profile)"
```
</verification>

<success_criteria>
1. config.py KNOWN_KEYS includes "profile_path" - config recognizes profile_path from wizard
2. wizard.py writes profile_path (absolute path) to config.json alongside min_score and new_only
3. search.py main() resolves profile from CLI flag > config.json > default path (no more required --profile)
4. load_profile_with_recovery() backs up corrupt profiles and re-runs wizard (max 2 retries)
5. --no-wizard flag bypasses wizard in both __main__.py and search.py
6. --validate-profile flag validates profile and exits
7. All existing tests pass without modification
</success_criteria>

<output>
After completion, create `.planning/phases/08-entry-point-integration/08-01-SUMMARY.md`
</output>
