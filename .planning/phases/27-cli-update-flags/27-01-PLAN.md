---
phase: 27-cli-update-flags
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - job_radar/search.py
  - tests/test_cli_update_flags.py
autonomous: true

must_haves:
  truths:
    - "Running job-radar --update-skills 'python,react,typescript' replaces the skills list in profile.json, shows old/new diff, and exits without searching"
    - "Running job-radar --set-min-score 3.5 updates min_score in config.json, shows old/new diff with context hint, and exits without searching"
    - "Running job-radar --set-titles 'Backend Developer,SRE' replaces target_titles in profile.json, shows old/new diff, and exits without searching"
    - "Invalid values (--set-min-score abc, --set-min-score 7.0, --update-skills with only commas) are rejected with clear error and exit code 1"
    - "Multiple update flags in one command are rejected (mutually exclusive group)"
    - "Update flags with --view-profile or --edit-profile are rejected with guidance message"
    - "Clearing skills with --update-skills '' produces empty list and shows diff"
  artifacts:
    - path: "job_radar/search.py"
      provides: "Three CLI update flags with validators and handlers"
      contains: "comma_separated_skills|valid_score_range|comma_separated_titles"
    - path: "tests/test_cli_update_flags.py"
      provides: "Tests for validators, handlers, flag parsing, mutual exclusion"
      min_lines: 150
  key_links:
    - from: "job_radar/search.py (handle_update_skills)"
      to: "job_radar/profile_manager.py (save_profile)"
      via: "save_profile(profile, profile_path)"
      pattern: "save_profile"
    - from: "job_radar/search.py (handle_set_min_score)"
      to: "job_radar/profile_manager.py (_write_json_atomic)"
      via: "_write_json_atomic(config_path, config)"
      pattern: "_write_json_atomic"
    - from: "job_radar/search.py (handle_set_titles)"
      to: "job_radar/profile_manager.py (save_profile)"
      via: "save_profile(profile, profile_path)"
      pattern: "save_profile"
---

<objective>
Add --update-skills, --set-min-score, and --set-titles CLI flags to job-radar for direct profile/config updates without entering interactive mode.

Purpose: Users can update common profile fields directly from the command line for scripted and rapid workflows — no interactive prompts needed.
Output: Three new CLI flags in search.py with custom validators, handlers showing old/new diffs, and comprehensive tests.
</objective>

<execution_context>
@/home/corye/.claude/get-shit-done/workflows/execute-plan.md
@/home/corye/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/27-cli-update-flags/27-CONTEXT.md
@.planning/phases/27-cli-update-flags/27-RESEARCH.md
@.planning/phases/24-profile-infrastructure/24-01-SUMMARY.md
@.planning/phases/26-interactive-quick-edit/26-02-SUMMARY.md
@job_radar/search.py
@job_radar/profile_manager.py
@job_radar/config.py
@job_radar/profile_editor.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add CLI update flags with validators and handlers to search.py</name>
  <files>job_radar/search.py</files>
  <action>
Add three custom argparse type validator functions, three handler functions, and wire them into parse_args() and main() in search.py.

**Validators (add after the _score_color function, before parse_args):**

1. `comma_separated_skills(value: str) -> list[str]`: Parse comma-separated skill list. Empty string `""` returns `[]` (allows clearing per user decision). Non-empty input splits on commas, strips whitespace, filters empty items. Raises `argparse.ArgumentTypeError` if result is empty but input wasn't empty string (e.g., `",,,"`).

2. `comma_separated_titles(value: str) -> list[str]`: Parse comma-separated title list. Does NOT allow empty string clearing (target_titles is required, must be non-empty per validate_profile). Raises `argparse.ArgumentTypeError` if list would be empty.

3. `valid_score_range(value: str) -> float`: Parse float and validate 0.0-5.0 range. Raises `argparse.ArgumentTypeError` with message `"min_score must be a number, got '{value}'"` for non-numeric input, or `"min_score must be 0.0-5.0, got {score}"` for out-of-range values.

**Handlers (add after load_profile_with_recovery, before filter_by_date):**

4. `_resolve_profile_path(profile_arg: str | None) -> Path`: Helper to resolve profile path from --profile flag or default location. Same logic as main flow lines 570-574 but returns Path object. Used by all three handlers.

5. `_resolve_config_path(config_arg: str | None) -> Path`: Helper to resolve config path from --config flag or default location. Same logic as --edit-profile handler. Returns Path object.

6. `handle_update_skills(skills: list[str], profile_arg: str | None)`: Load profile from resolved path. If profile doesn't exist: print error `"Error: No profile found."` + tip `"Run 'job-radar' first to create one."` and sys.exit(1). Store old core_skills. Set profile["core_skills"] = skills. Call save_profile(profile, profile_path) — this handles backup + validation. Print diff: `"Skills updated.\n  Old: {old}\n  New: {new}"`. Use `", ".join(list)` for display, `"(empty)"` for empty lists. Uses C.GREEN for header, C.BOLD for new value.

7. `handle_set_min_score(score: float, config_arg: str | None)`: Resolve config path. Load config JSON (or empty dict if no file). Store old min_score (default 2.8 if not set). Set config["min_score"] = score. Write with _write_json_atomic (import from profile_manager). Print: `"Min score updated to {score:.1f}"` with C.GREEN, then diff lines, then context hint: `"Jobs scoring below {score:.1f} will be hidden."` with C.DIM.

8. `handle_set_titles(titles: list[str], profile_arg: str | None)`: Same pattern as handle_update_skills but for target_titles field. Same profile-not-found error. Print `"Titles updated."` with diff.

**Flag registration in parse_args():**

9. Create a mutually exclusive group for update flags inside the Profile Options group:
```python
update_group = profile_group.add_mutually_exclusive_group()
update_group.add_argument("--update-skills", type=comma_separated_skills, metavar="SKILLS",
    help='Replace skills list (comma-separated). Example: --update-skills "python,react,typescript"')
update_group.add_argument("--set-min-score", type=valid_score_range, metavar="SCORE",
    help="Set minimum score threshold (0.0-5.0). Example: --set-min-score 3.5")
update_group.add_argument("--set-titles", type=comma_separated_titles, metavar="TITLES",
    help='Replace target titles (comma-separated). Example: --set-titles "Backend Developer,SRE"')
```

10. Update the epilog to remove the "(coming soon: --update-skills, --set-min-score)" placeholder and add examples for all three flags under a "Quick Updates:" section.

**Early exit wiring in main():**

11. Add mutual exclusion check after parse_args() — if any update flag is set AND (args.view_profile or args.edit_profile), print error with guidance and sys.exit(1). Place this check after the --no-color handling but before any other early exit handlers.

12. Add early exit handlers for the three update flags, placed AFTER the --no-color handler and mutual exclusion check, but BEFORE the --setup-apis handler. Use `is not None` checks (since empty list `[]` is valid for --update-skills clearing). Each calls its handler and then `sys.exit(0)`. Pattern matches existing --view-profile/--edit-profile early exits.

**Important details:**
- Use lazy imports inside handlers (Path, get_data_dir) consistent with existing search.py patterns
- For handle_update_skills and handle_set_titles: wrap save_profile in try/except ProfileValidationError, print error with C.RED and sys.exit(1) on validation failure
- For handle_set_min_score: use `from .profile_manager import _write_json_atomic` inside the handler (lazy import)
- Add `import json` at top if not already present (it is)
  </action>
  <verify>
Run: `cd /home/corye/Claude/Job-Radar && python -m pytest tests/ -x -q` — full test suite passes (no regressions).
Run: `cd /home/corye/Claude/Job-Radar && python -c "from job_radar.search import parse_args, comma_separated_skills, valid_score_range, comma_separated_titles; print('imports ok')"` — validators importable.
Run: `cd /home/corye/Claude/Job-Radar && python -c "from job_radar.search import comma_separated_skills; assert comma_separated_skills('python,react') == ['python', 'react']; assert comma_separated_skills('') == []; print('validators ok')"` — validator behavior correct.
Run: `cd /home/corye/Claude/Job-Radar && python -c "from job_radar.search import valid_score_range; assert valid_score_range('3.5') == 3.5; print('score ok')"` — score validator works.
  </verify>
  <done>
Three CLI update flags (--update-skills, --set-min-score, --set-titles) registered in parse_args() with custom type validators. Three handler functions wired in main() with early exit pattern. Mutual exclusion enforced for update flags and update+view/edit combinations. All existing tests still pass.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add tests for CLI update flags, validators, and handlers</name>
  <files>tests/test_cli_update_flags.py</files>
  <action>
Create tests/test_cli_update_flags.py with comprehensive tests for all Phase 27 functionality.

**Test categories:**

1. **Validator tests (parametrized):**
   - `test_comma_separated_skills_valid`: "python,react,typescript" -> ["python", "react", "typescript"]
   - `test_comma_separated_skills_with_spaces`: "python, react , typescript" -> ["python", "react", "typescript"]
   - `test_comma_separated_skills_empty_clears`: "" -> []
   - `test_comma_separated_skills_commas_only_raises`: ",,," raises ArgumentTypeError
   - `test_comma_separated_skills_single_item`: "python" -> ["python"]
   - `test_comma_separated_titles_valid`: "Backend Developer,SRE" -> ["Backend Developer", "SRE"]
   - `test_comma_separated_titles_empty_raises`: "" raises ArgumentTypeError (titles cannot be cleared)
   - `test_valid_score_range_valid`: "3.5" -> 3.5, "0.0" -> 0.0, "5.0" -> 5.0
   - `test_valid_score_range_non_numeric`: "abc" raises ArgumentTypeError with "must be a number"
   - `test_valid_score_range_out_of_range`: "7.0" raises ArgumentTypeError with "must be 0.0-5.0"
   - `test_valid_score_range_negative`: "-1.0" raises ArgumentTypeError

2. **Handler tests (using tmp_path with real profile/config files):**
   - Create a `profile_and_config` fixture that creates valid profile.json and config.json in tmp_path with mock backup dir
   - `test_handle_update_skills_replaces_list`: Call handle_update_skills with ["python", "react"]. Assert profile.json core_skills changed. Assert sys.exit(0) called. Assert output contains "Skills updated" and old/new values.
   - `test_handle_update_skills_clears_list`: Call with [] (empty list from validator). Note: save_profile validates core_skills must be non-empty, so this should sys.exit(1) with validation error. Test that it exits with error.
   - `test_handle_update_skills_no_profile`: Call with non-existent profile path. Assert sys.exit(1) and "No profile found" in output.
   - `test_handle_set_min_score_updates_config`: Call handle_set_min_score with 3.5. Assert config.json min_score is 3.5. Assert output contains "Min score updated" and "Jobs scoring below 3.5 will be hidden".
   - `test_handle_set_min_score_no_config_file`: Call with non-existent config. Should create new config.json with min_score.
   - `test_handle_set_titles_replaces_list`: Call handle_set_titles with ["SRE", "DevOps"]. Assert profile.json target_titles changed.
   - `test_handle_set_titles_no_profile`: Assert sys.exit(1) with guidance.

3. **Flag parsing tests:**
   - `test_parse_args_update_skills`: `parse_args` with --update-skills "python,react" returns args.update_skills == ["python", "react"]
   - `test_parse_args_set_min_score`: --set-min-score 3.5 returns args.set_min_score == 3.5
   - `test_parse_args_set_titles`: --set-titles "Backend,SRE" returns args.set_titles == ["Backend", "SRE"]

4. **Mutual exclusion tests:**
   - `test_update_flags_mutually_exclusive`: Using --update-skills and --set-min-score together causes argparse error (SystemExit)
   - `test_update_flag_with_view_profile_rejected`: Mock to test that the manual check in main() catches --update-skills with --view-profile

5. **Integration-style test:**
   - `test_update_skills_exits_without_search`: Patch main() dependencies. Verify that when --update-skills is set, main() calls handle_update_skills and sys.exit(0) — never reaches the search flow (never calls fetch_all).

**Test patterns to follow:**
- Use `unittest.mock.patch` for sys.exit, sys.argv, and get_data_dir/get_backup_dir
- Use `tmp_path` fixture for file I/O
- Use `capsys` for output capture
- Mock `get_backup_dir` to point to tmp_path/backups (same pattern as test_profile_manager.py and test_profile_editor.py)
- Import validators and handlers directly from job_radar.search
  </action>
  <verify>
Run: `cd /home/corye/Claude/Job-Radar && python -m pytest tests/test_cli_update_flags.py -v` — all new tests pass.
Run: `cd /home/corye/Claude/Job-Radar && python -m pytest tests/ -x -q` — full test suite passes (zero regressions).
  </verify>
  <done>
Comprehensive test file covering all validators (valid input, edge cases, error cases), all handlers (success, profile-not-found, config-not-found), flag parsing, mutual exclusion, and early exit behavior. Full test suite passes with zero regressions.
  </done>
</task>

</tasks>

<verification>
1. `python -m pytest tests/ -x -q` — full suite passes (existing 412+ tests + new tests, zero failures)
2. `python -c "from job_radar.search import comma_separated_skills, valid_score_range, comma_separated_titles"` — validators importable
3. `python -m job_radar.search --help` — shows --update-skills, --set-min-score, --set-titles in help text with examples
4. `python -m job_radar.search --set-min-score abc 2>&1; echo "exit: $?"` — shows error message and exit code 1
5. `python -m job_radar.search --set-min-score 7.0 2>&1; echo "exit: $?"` — shows "must be 0.0-5.0" error and exit code 1
6. `python -m job_radar.search --update-skills "x" --set-min-score 3.5 2>&1; echo "exit: $?"` — shows mutual exclusion error
</verification>

<success_criteria>
- Three CLI update flags (--update-skills, --set-min-score, --set-titles) registered and functional
- Custom type validators reject invalid input at parse time with friendly messages
- Handlers update the correct files (profile.json for skills/titles, config.json for min_score)
- Old/new diff displayed on success, context hint for min_score
- Exit code 0 on success, exit code 1 on all errors
- Mutually exclusive: only one update flag per command, not combinable with --view-profile/--edit-profile
- Profile-not-found gives helpful guidance message
- Empty string clears skills list (validator returns [])
- Full test suite passes with comprehensive new tests
</success_criteria>

<output>
After completion, create `.planning/phases/27-cli-update-flags/27-01-SUMMARY.md`
</output>
