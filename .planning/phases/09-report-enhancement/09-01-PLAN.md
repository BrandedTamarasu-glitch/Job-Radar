---
phase: 09-report-enhancement
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - job_radar/report.py
  - job_radar/browser.py
autonomous: true

must_haves:
  truths:
    - "generate_report() returns a dict with both 'markdown' and 'html' paths plus stats"
    - "HTML report renders with Bootstrap 5 styling, dark mode, responsive layout"
    - "Markdown report still generates correctly (no regressions)"
    - "is_headless_environment() detects CI/server/headless environments"
    - "open_report_in_browser() uses pathlib.as_uri() for cross-platform file:// URLs"
  artifacts:
    - path: "job_radar/report.py"
      provides: "Dual-format report generation (HTML + Markdown)"
      contains: "_generate_html_report"
    - path: "job_radar/browser.py"
      provides: "Browser opening utilities with headless detection"
      exports: ["is_headless_environment", "open_report_in_browser"]
  key_links:
    - from: "job_radar/report.py"
      to: "job_radar/report.py::_generate_html_report"
      via: "generate_report() calls _generate_html_report() internally"
      pattern: "_generate_html_report"
    - from: "job_radar/browser.py"
      to: "webbrowser.open"
      via: "open_report_in_browser() calls webbrowser.open(path.as_uri())"
      pattern: "webbrowser\\.open"
---

<objective>
Create dual-format report generation (HTML + Markdown) and browser utility module.

Purpose: Provide the core report generation and browser opening infrastructure that search.py will wire together in Plan 02.
Output: Modified report.py with HTML generation + new browser.py with headless detection and browser opening.
</objective>

<execution_context>
@/Users/coryebert/.claude/get-shit-done/workflows/execute-plan.md
@/Users/coryebert/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-report-enhancement/09-CONTEXT.md
@.planning/phases/09-report-enhancement/09-RESEARCH.md
@job_radar/report.py
@job_radar/sources.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add HTML report generation to report.py</name>
  <files>job_radar/report.py</files>
  <action>
Refactor `generate_report()` in report.py to produce BOTH Markdown and HTML reports:

1. **Rename the current generate_report function** to `_generate_markdown_report()` — it becomes an internal helper. Keep ALL its existing logic intact (no regressions).

2. **Create `_generate_html_report()`** that generates a Bootstrap 5.3 HTML report:
   - HTML structure: `<!DOCTYPE html><html lang="en" data-bs-theme="auto">` with proper head/body
   - Head includes: charset utf-8, viewport meta, color-scheme meta ("light dark"), Bootstrap 5.3 CSS CDN, Prism.js CSS CDN
   - Body includes: container div with sections for profile summary, recommended roles (score >= 3.5), all results table, manual URLs
   - Bootstrap components to use:
     - `alert alert-info` for date/sources/total summary at top
     - `table table-striped table-hover` with `table-responsive` wrapper for all results
     - `badge bg-success/bg-warning/bg-secondary` for score badges (4.0+ green, 3.5+ yellow, rest secondary)
     - `badge bg-primary rounded-pill` for NEW indicators
     - `btn btn-sm btn-outline-primary` for View links with `target="_blank"`
     - `card` components for recommended roles section (each role as a card)
   - Dark mode: Script at bottom that reads `prefers-color-scheme` and sets `data-bs-theme` attribute
   - Print styles: `@media print` block that hides `.no-print`, sets white background, solid card borders
   - Dark mode CSS adjustments for `[data-bs-theme="dark"]`
   - Include Bootstrap 5.3 JS bundle and Prism.js core + autoloader at bottom of body
   - Use f-strings for HTML generation (no Jinja2/templates dependency)
   - Escape HTML entities in user-provided text (job titles, descriptions) using `html.escape()`
   - The function signature should match the data available: profile dict, scored_results list, manual_urls list, sources_searched list, from_date, to_date, output_path (Path), tracker_stats, min_score

3. **Create new `generate_report()` as the public API** that:
   - Takes same parameters as the old generate_report plus returns a richer result
   - Generates timestamp for filenames: `jobs_YYYY-MM-DD_HH-MM` format (per CONTEXT decision)
   - Calls `_generate_markdown_report()` to produce `jobs_{timestamp}.md`
   - Calls `_generate_html_report()` to produce `jobs_{timestamp}.html`
   - Returns a dict: `{"markdown": str(md_path), "html": str(html_path), "stats": {"total": N, "new": N, "high_score": N}}`
   - The old return type was a string (filepath). The new return type is a dict. This is a breaking change that Plan 02 will handle in search.py.

4. **Helper functions for HTML sections** (keep HTML readable):
   - `_html_profile_section(profile)` — renders candidate profile as Bootstrap card
   - `_html_recommended_section(recommended, profile)` — renders recommended roles as cards with skill matches, talking points
   - `_html_results_table(scored_results)` — renders all results as responsive table with score badges
   - `_html_manual_urls_section(manual_urls)` — renders manual check URLs grouped by source

5. **Import `html` module** at top of file for `html.escape()`. Import `pathlib.Path` for path handling.

IMPORTANT: The Markdown generation must remain IDENTICAL to current behavior. Only the return type of the public `generate_report()` changes. All existing Markdown formatting, snippets, talking points logic stays the same.

File naming: Use `jobs_YYYY-MM-DD_HH-MM` timestamp format per CONTEXT decision (not the old `{safe_name}_{today}.md` format). This applies to BOTH HTML and Markdown files.
  </action>
  <verify>
Run: `python -c "from job_radar.report import generate_report, _generate_markdown_report, _generate_html_report; print('imports OK')"`
Verify the function exists and is importable.
  </verify>
  <done>
generate_report() returns dict with markdown path, html path, and stats. HTML file contains Bootstrap 5.3 markup with dark mode, responsive tables, score badges, and print styles. Markdown generation unchanged from v1.0.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create browser.py utility module</name>
  <files>job_radar/browser.py</files>
  <action>
Create `job_radar/browser.py` with two public functions:

1. **`is_headless_environment() -> bool`**:
   - Check `os.environ.get("CI") == "true"` (GitHub Actions, GitLab, Travis, CircleCI)
   - Check `os.environ.get("GITHUB_ACTIONS") == "true"` (GitHub Actions specific)
   - Check `os.environ.get("BUILD_ID")` (Jenkins)
   - Check `os.name == "posix" and not os.environ.get("DISPLAY")` (headless Linux/X11)
   - On macOS (`sys.platform == "darwin"`), do NOT check DISPLAY — macOS doesn't use X11 by default
   - Return True if any of the above match

2. **`open_report_in_browser(html_path: str, auto_open: bool = True) -> dict`**:
   - If `auto_open` is False, return `{"opened": False, "reason": "auto-open disabled by user"}`
   - If `is_headless_environment()` is True, return `{"opened": False, "reason": "headless environment detected"}`
   - Convert path to file:// URL using `Path(html_path).resolve().as_uri()` (CRITICAL: use resolve() first for absolute path, then as_uri() — per research pitfall #1)
   - Call `webbrowser.open(file_url)` and check return value
   - On success: return `{"opened": True, "reason": ""}`
   - On failure (returns False): return `{"opened": False, "reason": "browser not available"}`
   - Wrap in try/except: on exception return `{"opened": False, "reason": f"error: {e}"}`

3. **Module-level imports**: `import os, sys, webbrowser, logging` and `from pathlib import Path`

4. **Docstrings**: Include clear docstrings explaining what each function does and why (headless detection rationale, file:// URL requirement).

This module has NO dependency on report.py or search.py — it's a standalone utility.
  </action>
  <verify>
Run: `python -c "from job_radar.browser import is_headless_environment, open_report_in_browser; print('headless:', is_headless_environment()); print('imports OK')"`
  </verify>
  <done>
browser.py exists with is_headless_environment() and open_report_in_browser() functions. Headless detection checks CI, GITHUB_ACTIONS, BUILD_ID, and DISPLAY env vars. Browser opening uses pathlib.as_uri() for cross-platform file:// URLs.
  </done>
</task>

</tasks>

<verification>
1. `python -c "from job_radar.report import generate_report; print('OK')"` — imports succeed
2. `python -c "from job_radar.browser import is_headless_environment, open_report_in_browser; print('OK')"` — imports succeed
3. Existing tests still pass: `python -m pytest tests/ -x -q`
</verification>

<success_criteria>
- generate_report() returns dict with markdown, html, and stats keys
- HTML output contains Bootstrap 5.3 CDN links, data-bs-theme="auto", responsive viewport meta
- Markdown output identical in content to pre-refactor version
- browser.py exports is_headless_environment() and open_report_in_browser()
- No new pip dependencies added (all stdlib + CDN)
</success_criteria>

<output>
After completion, create `.planning/phases/09-report-enhancement/09-01-SUMMARY.md`
</output>
