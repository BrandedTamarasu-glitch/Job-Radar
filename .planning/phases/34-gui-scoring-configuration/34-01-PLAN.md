---
phase: 34-gui-scoring-configuration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - job_radar/gui/scoring_config.py
autonomous: true

must_haves:
  truths:
    - "Widget renders 6 labeled sliders with value+percentage display"
    - "Widget renders staffing preference dropdown with 3 options"
    - "Moving any slider or changing dropdown updates live preview immediately"
    - "Live preview shows sample job score breakdown with weighted components"
    - "Normalize button adjusts all weights proportionally to sum to 1.0"
    - "Reset button restores all sliders and dropdown to defaults"
    - "Invalid weight sum shows inline warning (orange text, non-blocking)"
    - "Collapsible header toggles section visibility"
  artifacts:
    - path: "job_radar/gui/scoring_config.py"
      provides: "ScoringConfigWidget class with sliders, dropdown, preview, validation"
      min_lines: 250
  key_links:
    - from: "job_radar/gui/scoring_config.py"
      to: "job_radar/profile_manager.py"
      via: "import DEFAULT_SCORING_WEIGHTS, save_profile, load_profile"
      pattern: "from job_radar\\.profile_manager import"
    - from: "scoring_config.py slider callbacks"
      to: "scoring_config.py update_preview"
      via: "command= parameter on each CTkSlider"
      pattern: "command=.*_on_weight_changed"
---

<objective>
Create the ScoringConfigWidget -- a self-contained CustomTkinter widget providing 6 weight sliders, staffing preference dropdown, live score preview, normalize/reset buttons, and sum-to-1.0 validation.

Purpose: This is the core GUI component for Phase 34. It encapsulates all scoring configuration UI in a single reusable widget that will be embedded in the Settings tab.

Output: `job_radar/gui/scoring_config.py` containing the complete ScoringConfigWidget class.
</objective>

<execution_context>
@/Users/coryebert/.claude/get-shit-done/workflows/execute-plan.md
@/Users/coryebert/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/34-gui-scoring-configuration/34-CONTEXT.md
@.planning/phases/34-gui-scoring-configuration/34-RESEARCH.md
@.planning/phases/33-scoring-configuration-backend/33-01-SUMMARY.md
@.planning/phases/33-scoring-configuration-backend/33-02-SUMMARY.md

Key references for implementation patterns:
@job_radar/gui/search_controls.py (validation pattern: inline error labels, _score_error_label)
@job_radar/gui/main_window.py (Settings tab structure at _build_settings_tab, line 773)
@job_radar/profile_manager.py (DEFAULT_SCORING_WEIGHTS constant, save_profile, load_profile)
@job_radar/scoring.py (score_job function showing how weights are used, lines 12-70)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ScoringConfigWidget with sliders, dropdown, and collapsible section</name>
  <files>job_radar/gui/scoring_config.py</files>
  <action>
Create `job_radar/gui/scoring_config.py` with a `ScoringConfigWidget` class that extends `ctk.CTkFrame`.

**Class structure:**

```python
class ScoringConfigWidget(ctk.CTkFrame):
    def __init__(self, parent, on_save_callback=None, **kwargs)
```

**Collapsible section:**
- Header button with triangle indicator (use unicode chars, not emoji): "▼ Scoring Configuration" when expanded, "▶ Scoring Configuration" when collapsed
- `toggle()` method shows/hides the content frame using `pack_forget()` / `pack()`
- Default state: expanded (per user decision: "expanded on first visit")
- Store `self._is_expanded` boolean

**Layout (inside content frame):**
- Two-column grid: left panel = sliders + controls, right panel = live preview
- Use `self.grid_columnconfigure(0, weight=3)` and `self.grid_columnconfigure(1, weight=2)` for roughly 60/40 split

**Left panel - Weight sliders:**
- Import `DEFAULT_SCORING_WEIGHTS` from `job_radar.profile_manager`
- Group sliders into two labeled sections:
  - "Skills & Fit" group: skill_match, title_relevance, seniority, domain
  - "Context" group: location, response_likelihood
- Each slider row has: label, CTkSlider, value display label showing "0.25 (25%)"
- CTkSlider config: `from_=0.05, to=1.0, number_of_steps=19` (0.05 increments, enforces min 0.05)
- Each slider's `command=` calls `self._on_weight_changed` which updates the value label and triggers preview update
- Help text below each slider group title as a gray CTkLabel explaining the group (e.g., "How much weight to give your skills and experience match")

**Left panel - Staffing preference dropdown:**
- CTkLabel "Staffing Firm Preference:" with help text below: "Applied after scoring: boost favors, penalize discourages staffing firm jobs"
- CTkOptionMenu with values=["Boost (+0.5)", "Neutral (no change)", "Penalize (-1.0)"]
- Store mapping dict: `{"Boost (+0.5)": "boost", "Neutral (no change)": "neutral", "Penalize (-1.0)": "penalize"}`
- Reverse mapping for display: `{"boost": "Boost (+0.5)", ...}`
- `command=` triggers preview update

**Left panel - Validation warning:**
- CTkLabel below sliders, initially empty text
- When weights don't sum to 1.0 (tolerance 0.01): show orange text "Weights sum to X.XX (must equal 1.0). Click Normalize to fix."
- When weights DO sum to 1.0: clear the label text
- Call `self._check_sum_validation()` from every slider callback

**Left panel - Action buttons (horizontal row):**
- "Normalize" button: proportionally adjusts all 6 sliders to sum to 1.0 (if total > 0, divide each by total; if total == 0, set each to 1/6). Updates slider positions AND value labels. Triggers preview update.
- "Reset to Defaults" button: calls `self._reset_to_defaults()` which sets all sliders to DEFAULT_SCORING_WEIGHTS values, sets dropdown to "Neutral (no change)", clears validation warning. Shows confirmation dialog FIRST using tkinter messagebox.askokcancel("Reset Scoring?", "Reset all scoring weights to defaults?").
- "Save" button: validates sum == 1.0 (with 0.01 tolerance). If invalid, shows messagebox.showerror. If valid, loads profile via `load_profile()`, updates `profile["scoring_weights"]` dict and `profile["staffing_preference"]` string, saves via `save_profile()`, calls `on_save_callback` if provided.

**Right panel - Live preview:**
- Title: "Score Preview" (bold, size 14)
- Subtitle: "Sample Job: Senior Python Developer" (gray, size 11)
- Description line: "Remote | Python, Django, AWS | 5+ years"
- Hardcoded sample component scores (representing a well-matched job):
  ```python
  SAMPLE_SCORES = {
      "skill_match": 4.5,
      "title_relevance": 4.0,
      "seniority": 3.8,
      "location": 5.0,
      "domain": 3.5,
      "response_likelihood": 3.2,
  }
  ```
- Display each component as a line: "Skill Match: 4.5 x 0.25 = 1.13"
- Display separator line (dashes or thin frame)
- Display "Overall Score: X.XX / 5.0" in bold
- If staffing preference is not neutral, show adjustment line: "+0.5 staffing boost" or "-1.0 staffing penalty" and adjusted final
- Use `self._preview_text` CTkLabel with `justify="left"` and `anchor="nw"` for the breakdown text
- `update_preview()` method recalculates and updates all preview text on every slider/dropdown change

**Initialize from profile:**
- `load_from_profile(profile)` method: sets sliders to profile["scoring_weights"] values, sets dropdown to profile["staffing_preference"]. Called externally after construction.
- Also provide `set_weights(weights_dict)` for programmatic control.

Do NOT use CTkToolTip (not in project dependencies). Use descriptive gray labels instead for help text.
Do NOT add CTkToolTip to pyproject.toml dependencies.
  </action>
  <verify>
Run `python -c "from job_radar.gui.scoring_config import ScoringConfigWidget; print('Import OK')"` to verify the module imports cleanly without errors.
  </verify>
  <done>
ScoringConfigWidget class exists in job_radar/gui/scoring_config.py with: 6 sliders (0.05-1.0, 19 steps each), staffing dropdown, live preview panel, normalize/reset/save buttons, sum-to-1.0 validation, collapsible header. Module imports without errors.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add profile loading, save integration, and default state initialization</name>
  <files>job_radar/gui/scoring_config.py</files>
  <action>
Ensure the widget properly initializes from profile state on construction and integrates cleanly with the profile save pipeline.

**Profile loading on init:**
- Add `profile` parameter to `__init__` (optional, defaults to None)
- If profile is provided, call `self.load_from_profile(profile)` at end of __init__
- If profile is None, initialize sliders to DEFAULT_SCORING_WEIGHTS and dropdown to "Neutral (no change)"
- Ensure preview updates after initial load

**Save pipeline integration:**
- In `_save_scoring_config()`:
  1. Gather all slider values into a dict matching DEFAULT_SCORING_WEIGHTS keys
  2. Validate sum to 1.0 (tolerance 0.01) -- if fails, show `messagebox.showerror("Invalid Configuration", f"Weights must sum to 1.0 (currently {total:.3f}). Click Normalize to fix.")`
  3. Validate each weight >= 0.05 -- if fails, show error naming the component
  4. Get staffing preference from dropdown, map display text to internal value ("boost"/"neutral"/"penalize")
  5. Load current profile: `profile_path = get_data_dir() / "profile.json"`, `profile = load_profile(profile_path)`
  6. Update: `profile["scoring_weights"] = weights`, `profile["staffing_preference"] = pref`
  7. Save: `save_profile(profile, profile_path)`
  8. Call `self._on_save_callback()` if callback exists
  9. Show success feedback: configure a `self._save_status_label` to show green "Saved!" text, auto-clear after 2 seconds using `self.after(2000, ...)`

**Edge cases:**
- Handle missing profile gracefully (try/except around load_profile, show error dialog)
- Handle ProfileValidationError from save_profile (show error dialog with message)
- Round slider values to 2 decimal places before saving (prevent float artifacts like 0.15000000000000002)

**Imports needed at top of file:**
```python
from pathlib import Path
from tkinter import messagebox
import customtkinter as ctk
from job_radar.profile_manager import (
    DEFAULT_SCORING_WEIGHTS, save_profile, load_profile,
    ProfileValidationError
)
from job_radar.paths import get_data_dir
```
  </action>
  <verify>
Run `python -c "from job_radar.gui.scoring_config import ScoringConfigWidget; print('Import OK')"` to verify the module still imports cleanly. Then verify the save-related imports work: `python -c "from job_radar.profile_manager import DEFAULT_SCORING_WEIGHTS, save_profile, load_profile, ProfileValidationError; print('All imports OK')"`.
  </verify>
  <done>
ScoringConfigWidget loads weights from profile on construction, saves to profile via profile_manager with full validation (sum to 1.0, min 0.05 per component), handles errors gracefully, and provides save success feedback.
  </done>
</task>

</tasks>

<verification>
1. `python -c "from job_radar.gui.scoring_config import ScoringConfigWidget; print('OK')"` -- imports without error
2. `python -c "from job_radar.gui.scoring_config import SAMPLE_SCORES; print(SAMPLE_SCORES)"` -- sample scores accessible
3. `grep -c "CTkSlider" job_radar/gui/scoring_config.py` -- should be >= 6 (one per weight component)
4. `grep -c "CTkOptionMenu" job_radar/gui/scoring_config.py` -- should be >= 1 (staffing dropdown)
5. `grep "number_of_steps=19" job_radar/gui/scoring_config.py` -- confirms 0.05 increment granularity
6. `grep "DEFAULT_SCORING_WEIGHTS" job_radar/gui/scoring_config.py` -- confirms import and usage
7. `grep "save_profile" job_radar/gui/scoring_config.py` -- confirms save integration
</verification>

<success_criteria>
- ScoringConfigWidget is a self-contained, importable CustomTkinter widget
- 6 sliders with 0.05 increments (from_=0.05, to=1.0, number_of_steps=19)
- Staffing preference dropdown with 3 options mapped to internal values
- Live preview recalculates on every slider/dropdown change
- Normalize button proportionally adjusts to sum to 1.0
- Reset button restores defaults with confirmation dialog
- Save button validates and persists to profile
- Sum validation shows inline orange warning (non-blocking) during editing
- Save validation shows messagebox error (blocking) on save attempt
- No new pip dependencies added (no CTkToolTip)
</success_criteria>

<output>
After completion, create `.planning/phases/34-gui-scoring-configuration/34-01-SUMMARY.md`
</output>
