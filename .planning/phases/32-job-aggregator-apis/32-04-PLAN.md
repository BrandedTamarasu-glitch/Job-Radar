---
phase: 32-job-aggregator-apis
plan: 04
type: execute
wave: 3
depends_on: ["32-03"]
files_modified:
  - job_radar/gui/main_window.py
  - tests/test_sources_api.py
  - tests/test_deduplication.py
  - tests/test_api_config.py
autonomous: true

must_haves:
  truths:
    - "GUI Settings section includes API key fields for JSearch and USAJobs with test buttons"
    - "Tests verify JSearch fetch function returns correctly mapped JobResult objects with source attribution"
    - "Tests verify USAJobs fetch function handles nested response structure"
    - "Tests verify deduplication returns stats dict and tracks multi-source matches"
    - "Tip shown in GUI when JSearch API key not configured"
  artifacts:
    - path: "job_radar/gui/main_window.py"
      provides: "API key configuration fields in Settings section"
      contains: "JSearch"
    - path: "tests/test_sources_api.py"
      provides: "Tests for fetch_jsearch, fetch_usajobs, map functions"
      contains: "test_jsearch"
    - path: "tests/test_deduplication.py"
      provides: "Updated tests for new dedup return type with stats"
      contains: "stats"
  key_links:
    - from: "tests/test_sources_api.py"
      to: "job_radar/sources.py"
      via: "Tests import and verify fetch_jsearch, fetch_usajobs, map functions"
      pattern: "from job_radar.sources import"
    - from: "job_radar/gui/main_window.py"
      to: "job_radar/api_setup.py"
      via: "GUI settings trigger API validation same as CLI --test-apis"
      pattern: "test.*api"
---

<objective>
Add GUI API key settings and comprehensive tests for all Phase 32 functionality.

Purpose: Complete the user-facing integration by adding API key configuration to the GUI settings, and ensure reliability with comprehensive tests covering JSearch fetch/mapping, USAJobs fetch/mapping, dedup stats, and API setup.

Output: GUI settings with API key fields, test suite updates covering all new functionality.
</objective>

<execution_context>
@/home/corye/.claude/get-shit-done/workflows/execute-plan.md
@/home/corye/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/32-job-aggregator-apis/32-RESEARCH.md
@.planning/phases/32-job-aggregator-apis/32-01-SUMMARY.md
@.planning/phases/32-job-aggregator-apis/32-02-SUMMARY.md
@.planning/phases/32-job-aggregator-apis/32-03-SUMMARY.md
@job_radar/gui/main_window.py
@tests/test_sources_api.py
@tests/test_deduplication.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add API key configuration to GUI Settings</name>
  <files>job_radar/gui/main_window.py</files>
  <action>
Add an API key configuration section to the GUI. The GUI uses customtkinter (ctk) with a tabbed interface.

**Determine placement:** Check if main_window.py already has a Settings tab or section. If yes, add API fields there. If no, add a collapsible "API Settings" section to the profile form area or create a minimal settings area at the bottom of the main window.

**LOCKED DECISION: Add API key configuration fields to GUI so non-technical users never need the terminal.**

Create API key fields for each source:
1. **JSearch section:**
   - Label: "JSearch API Key (LinkedIn, Indeed, Glassdoor)"
   - Text entry field for JSEARCH_API_KEY
   - "Test" button that validates the key via test API request
   - Status indicator: unconfigured/valid/invalid

2. **USAJobs section:**
   - Label: "USAJobs (Federal Government Jobs)"
   - Text entry for USAJOBS_EMAIL
   - Text entry for USAJOBS_API_KEY
   - "Test" button that validates both credentials
   - Status indicator

3. **Existing sources (Adzuna, Authentic Jobs):**
   - Same pattern — add fields if not already present

**Save behavior:**
- When user clicks "Save API Keys" button, write all non-empty fields to .env file
- Use same atomic write pattern as api_setup.py (tempfile.mkstemp + Path.replace)
- Read existing .env on settings load to populate fields with current values
- Mask key values by default (show as ****), with "Show" toggle

**Test button behavior:**
- Runs in a thread (don't block GUI)
- Shows spinner/loading state during test
- Updates status label: "✓ Valid" (green), "✗ Invalid" (red), "⚠ Network error" (yellow)
- Uses same test request logic as test_apis() in api_setup.py

**LOCKED DECISION: Show tip when JSearch not configured:**
If JSEARCH_API_KEY is empty/not set, show a label:
"Tip: Set up JSearch API key to search LinkedIn, Indeed, and Glassdoor"
Always visible (not just first run), disappears when key is configured.

**Implementation notes:**
- Use ctk.CTkEntry for key fields with `show="*"` for masking
- Use ctk.CTkButton for Test buttons
- Use ctk.CTkLabel for status indicators
- Load current values from os.environ (which are populated from .env via load_api_credentials)
- Keep the API settings in a scrollable frame if space is tight
  </action>
  <verify>
Import main_window module without errors: `python -c "from job_radar.gui.main_window import MainWindow; print('GUI import OK')"`. Grep for "JSearch" in main_window.py to confirm fields exist.
  </verify>
  <done>
GUI includes API key configuration fields for JSearch (1 key), USAJobs (email + key), Adzuna (app_id + key), and Authentic Jobs (key). Each source has a Test button for validation. Keys are masked by default. Save writes atomically to .env. Tip displayed when JSearch not configured.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add comprehensive tests for JSearch, USAJobs, dedup stats, and API setup</name>
  <files>tests/test_sources_api.py, tests/test_deduplication.py, tests/test_api_config.py</files>
  <action>
Add tests covering all new Phase 32 functionality. Follow existing test patterns (pytest, monkeypatch for mocking, parametrize for variants).

**tests/test_sources_api.py — Add JSearch tests:**

1. `test_jsearch_maps_job_publisher_to_source()` — Verify map_jsearch_to_job_result sets source from job_publisher:
   - Input with job_publisher="LinkedIn" -> source="linkedin"
   - Input with job_publisher="Indeed" -> source="indeed"
   - Input with job_publisher="Glassdoor" -> source="glassdoor"
   - Input with job_publisher="Monster" -> source="jsearch_other"
   - Use parametrize for all cases

2. `test_jsearch_requires_title_company_url()` — Verify None returned when required fields missing:
   - Missing job_title -> None
   - Missing employer_name -> None
   - Missing job_apply_link -> None

3. `test_jsearch_maps_remote_location()` — Verify job_is_remote=True maps to "Remote" location

4. `test_jsearch_maps_salary()` — Verify salary formatting from job_min_salary/job_max_salary

5. `test_fetch_jsearch_handles_auth_error()` — Mock requests.get to return 401, verify empty results and no exception

6. `test_fetch_jsearch_handles_missing_api_key()` — Mock get_api_key to return None, verify empty results returned immediately

**tests/test_sources_api.py — Add USAJobs tests:**

7. `test_usajobs_maps_nested_descriptor()` — Verify map_usajobs_to_job_result extracts from MatchedObjectDescriptor:
   - Provide full nested structure, verify title/company/url extracted correctly
   - Verify source is always "usajobs"

8. `test_usajobs_maps_salary_from_remuneration()` — Verify PositionRemuneration[0] mapping

9. `test_usajobs_requires_both_credentials()` — Mock get_api_key to return None for email, verify empty results

10. `test_usajobs_handles_empty_search_result()` — Provide response with empty SearchResultItems, verify empty list

11. `test_fetch_usajobs_passes_federal_filters()` — Mock requests.get, provide profile with gs_grade_min=12, gs_grade_max=14, preferred_agencies=["TREAS"]. Verify request params include PayGradeLow="12", PayGradeHigh="14", Organization="TREAS".

**tests/test_deduplication.py — Update for new return type:**

12. Update ALL existing dedup tests to handle dict return instead of list:
    - Change `result = deduplicate_cross_source(jobs)` to `dedup = deduplicate_cross_source(jobs); result = dedup["results"]`
    - This preserves existing assertions while accommodating the new return type

13. `test_dedup_returns_stats()` — Verify stats dict structure:
    - Input: 5 jobs with 2 duplicates -> stats["duplicates_removed"] == 2
    - Verify stats has original_count, deduped_count, duplicates_removed, sources_involved keys

14. `test_dedup_tracks_multi_source()` — Verify multi_source map:
    - Input: Same job from "dice" and "linkedin" -> multi_source map has entry with both sources
    - Verify multi_source entry lists both source names

15. `test_dedup_empty_returns_stats()` — Verify empty input returns valid stats dict with zeros

**tests/test_sources_api.py — Add query builder tests:**

16. `test_build_queries_includes_jsearch()` — Verify build_search_queries generates jsearch queries for profile titles

17. `test_build_queries_includes_usajobs()` — Verify build_search_queries generates usajobs queries

18. `test_build_queries_jsearch_remote_location()` — Verify JSearch queries get location="remote" when profile has arrangement=["remote"]

**Mock patterns to follow (from existing test_sources_api.py):**
- Use `monkeypatch.setattr` for requests.get
- Use `monkeypatch.setenv` / `monkeypatch.delenv` for API keys
- Use `monkeypatch.setattr("job_radar.sources.get_api_key", ...)` for credential mocking
- Use `monkeypatch.setattr("job_radar.sources.check_rate_limit", lambda *a, **kw: True)` to bypass rate limiting in tests
  </action>
  <verify>
Run `python -m pytest tests/test_sources_api.py tests/test_deduplication.py -x -v` to verify all new tests pass. Run `python -m pytest tests/ -x -q` for full regression check.
  </verify>
  <done>
Tests cover JSearch source attribution (parametrized for LinkedIn/Indeed/Glassdoor/Other), required field validation, remote location mapping, salary formatting, auth error handling, missing API key handling. USAJobs tests cover nested descriptor mapping, salary extraction, dual credential requirement, empty results, federal filter passing. Dedup tests updated for dict return type with stats and multi-source tracking. Query builder tests verify jsearch/usajobs query generation. All existing tests updated for new dedup return type with zero regressions.
  </done>
</task>

</tasks>

<verification>
1. GUI main_window.py imports without errors
2. All new tests pass individually and as part of full suite
3. Existing dedup tests pass with updated return type handling
4. Full test suite passes: `cd /home/corye/Claude/Job-Radar && python -m pytest tests/ -x -q`
5. Test count increased (target: 480+ tests from 460 baseline)
</verification>

<success_criteria>
- GUI has API key fields for JSearch and USAJobs with test buttons
- JSearch source attribution tests pass (LinkedIn, Indeed, Glassdoor, Other)
- USAJobs nested structure tests pass
- Dedup stats tests pass
- All 460+ existing tests pass with zero regressions
- 18+ new tests added covering all Phase 32 functionality
</success_criteria>

<output>
After completion, create `.planning/phases/32-job-aggregator-apis/32-04-SUMMARY.md`
</output>
