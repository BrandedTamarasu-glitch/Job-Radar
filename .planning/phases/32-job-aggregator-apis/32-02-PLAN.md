---
phase: 32-job-aggregator-apis
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - job_radar/api_setup.py
  - profiles/_template.json
  - job_radar/profile_manager.py
autonomous: true

must_haves:
  truths:
    - "User can configure JSearch API key via --setup-apis wizard with test validation"
    - "User can configure USAJobs API key and email via --setup-apis wizard with test validation"
    - "API key validation makes real test requests and reports pass/fail during setup"
    - "Profile template includes optional federal fields (gs_grade_min, gs_grade_max, preferred_agencies, security_clearance)"
  artifacts:
    - path: "job_radar/api_setup.py"
      provides: "JSearch and USAJobs sections in setup_apis() and test_apis()"
      contains: "JSearch API"
    - path: "profiles/_template.json"
      provides: "Optional federal job fields for USAJobs filtering"
      contains: "gs_grade_min"
  key_links:
    - from: "job_radar/api_setup.py"
      to: "https://jsearch.p.rapidapi.com/search"
      via: "Test API request during setup validation"
      pattern: "jsearch.p.rapidapi.com"
    - from: "job_radar/api_setup.py"
      to: "https://data.usajobs.gov/api/search"
      via: "Test API request during setup validation"
      pattern: "data.usajobs.gov"
---

<objective>
Extend the API setup wizard and profile schema for JSearch and USAJobs sources.

Purpose: Enable users to configure API credentials for new sources with immediate validation feedback, and add optional federal job filter fields to the profile schema for USAJobs-specific searches.

Output: Updated api_setup.py with JSearch and USAJobs sections (setup + test), updated profile template with federal fields, updated profile_manager.py validation to accept new optional fields.
</objective>

<execution_context>
@/home/corye/.claude/get-shit-done/workflows/execute-plan.md
@/home/corye/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/32-job-aggregator-apis/32-RESEARCH.md
@job_radar/api_setup.py
@profiles/_template.json
@job_radar/profile_manager.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend API setup wizard and test_apis for JSearch and USAJobs</name>
  <files>job_radar/api_setup.py</files>
  <action>
Add JSearch and USAJobs sections to both `setup_apis()` and `test_apis()` functions, following the exact pattern of Adzuna and Authentic Jobs sections.

**setup_apis() — Add Section 3: JSearch (after Authentic Jobs section):**
```
print("\n" + "=" * 60)
print("JSearch API (LinkedIn, Indeed, Glassdoor)")
print("=" * 60)
print("Sign up at: https://rapidapi.com/letscrape-6bRBa3QguO5/api/jsearch\n")
```
- Prompt for `JSEARCH_API_KEY` (single key from RapidAPI)
- Follow same try/except/Ctrl+C pattern as Adzuna section
- If key provided and non-empty, store in credentials dict

**setup_apis() — Add Section 4: USAJobs (after JSearch section):**
```
print("\n" + "=" * 60)
print("USAJobs API (Federal Government Jobs)")
print("=" * 60)
print("Sign up at: https://developer.usajobs.gov/apirequest/\n")
```
- Prompt for `USAJOBS_EMAIL` first (the email used when requesting API key)
- If email provided, prompt for `USAJOBS_API_KEY`
- Both are required together — if email provided but key is empty (or vice versa), skip both
- Store both in credentials dict

**Update Summary section** in setup_apis():
- Add checks for JSearch and USAJobs in the configured sources display:
  ```python
  if "JSEARCH_API_KEY" in credentials:
      print("  ✓ JSearch (LinkedIn, Indeed, Glassdoor)")
  if "USAJOBS_API_KEY" in credentials:
      print("  ✓ USAJobs (Federal)")
  ```

**Update .env content builder** in setup_apis():
- Add JSearch section:
  ```python
  if "JSEARCH_API_KEY" in credentials:
      env_lines.append("# JSearch API Key (RapidAPI)\n")
      env_lines.append(f"JSEARCH_API_KEY={credentials['JSEARCH_API_KEY']}\n\n")
  ```
- Add USAJobs section:
  ```python
  if "USAJOBS_API_KEY" in credentials:
      env_lines.append("# USAJobs API Credentials\n")
      env_lines.append(f"USAJOBS_API_KEY={credentials['USAJOBS_API_KEY']}\n")
      env_lines.append(f"USAJOBS_EMAIL={credentials['USAJOBS_EMAIL']}\n\n")
  ```

**test_apis() — Add JSearch test (after Authentic Jobs test):**
- Check for `JSEARCH_API_KEY` env var
- If not configured: print skip message
- If configured: test request to `https://jsearch.p.rapidapi.com/search?query=test&num_pages=1`
  - Headers: `X-RapidAPI-Key: {key}`, `X-RapidAPI-Host: jsearch.p.rapidapi.com` (exact case per pitfall #1)
  - Success: 200 + valid JSON
  - Auth failure: 401/403
  - Timeout/network error handling same as Adzuna

**test_apis() — Add USAJobs test (after JSearch test):**
- Check for both `USAJOBS_API_KEY` and `USAJOBS_EMAIL` env vars
- If either not configured: print skip message
- If configured: test request to `https://data.usajobs.gov/api/search?Keyword=test&ResultsPerPage=1`
  - Headers: `Host: data.usajobs.gov`, `User-Agent: {email}`, `Authorization-Key: {key}` (per pitfall #2)
  - Same success/failure/error handling pattern

**LOCKED DECISION: Validate keys during setup with test API call.**
After collecting each source's credentials in setup_apis(), immediately validate:
- Make same test request as test_apis() would
- Print result inline: "  Testing... ✓ Key is valid" or "  Testing... ✗ Invalid key (HTTP 401)"
- On validation failure: still store key (user might fix network later), but warn
- On network error: store key with note "  ⚠ Could not validate (network error) — key saved anyway"

**LOCKED DECISION: Show tip when keys not configured.**
After the Summary section in setup_apis(), if JSearch key NOT in credentials:
```python
if "JSEARCH_API_KEY" not in credentials:
    print("\nTip: Set up JSearch API key to search LinkedIn, Indeed, and Glassdoor")
```
Also add this tip to test_apis() output when JSearch is skipped.
  </action>
  <verify>
Run `python -c "from job_radar.api_setup import setup_apis, test_apis; print('imports OK')"` to verify no syntax errors. Grep for "JSearch" and "USAJobs" in api_setup.py to confirm sections exist.
  </verify>
  <done>
setup_apis() includes JSearch (Section 3) and USAJobs (Section 4) credential collection with inline validation via test API requests. test_apis() includes JSearch and USAJobs test sections. Summary displays all configured sources. .env writer includes new credential sections. Tip shown when JSearch not configured.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add optional federal fields to profile schema</name>
  <files>profiles/_template.json, job_radar/profile_manager.py</files>
  <action>
Add optional USAJobs federal filter fields to the profile template and ensure profile_manager accepts them without validation errors.

**Update profiles/_template.json:**
Add the following optional fields after the existing `highlights` field:
```json
{
  ...existing fields...,
  "highlights": [...existing...],

  "_comment_federal": "Optional: Federal job filters for USAJobs (leave blank to skip)",
  "gs_grade_min": null,
  "gs_grade_max": null,
  "preferred_agencies": [],
  "security_clearance": null
}
```

Note: `_comment_federal` is a documentation-only field (common JSON pattern since JSON doesn't support comments). Profile loading should ignore fields starting with underscore.

**LOCKED DECISION fields:**
- `gs_grade_min`: integer or null (GS grade 1-15, e.g., 12)
- `gs_grade_max`: integer or null (GS grade 1-15, e.g., 14)
- `preferred_agencies`: list of strings (agency codes like "TREAS", "DD") or empty list
- `security_clearance`: string or null ("None", "Secret", "Top Secret")

**Update profile_manager.py:**
Review the validation logic to ensure:
1. New optional fields don't trigger validation errors (they should be silently accepted since they're optional)
2. If `validate_profile()` has a known-fields check that rejects unknown fields, add the new field names to the accepted set
3. If validation is permissive (accepts arbitrary keys), no changes needed — just verify

The federal fields are OPTIONAL — blank/null means no filtering on those parameters. No validation of GS grade ranges or agency codes is needed at this stage (USAJobs API will handle invalid values).
  </action>
  <verify>
Run `python -c "import json; t = json.load(open('profiles/_template.json')); assert 'gs_grade_min' in t; assert 'preferred_agencies' in t; print('template OK')"` to verify template fields. Run `python -m pytest tests/test_profile_manager.py -x -q` to verify no regressions in profile validation.
  </verify>
  <done>
Profile template includes gs_grade_min, gs_grade_max, preferred_agencies, and security_clearance as optional fields with null/empty defaults. Profile manager accepts new fields without validation errors. Existing profile tests pass with no regressions.
  </done>
</task>

</tasks>

<verification>
1. api_setup.py contains JSearch and USAJobs setup sections with inline validation
2. api_setup.py test_apis() contains JSearch and USAJobs test sections
3. profiles/_template.json includes federal fields
4. Profile manager handles new fields gracefully
5. Full test suite passes: `cd /home/corye/Claude/Job-Radar && python -m pytest tests/ -x -q`
</verification>

<success_criteria>
- Users can configure JSearch API key via --setup-apis wizard
- Users can configure USAJobs API key + email via --setup-apis wizard
- API keys are validated with real test requests during setup
- Profile template includes optional federal fields
- All 460 existing tests pass with zero regressions
</success_criteria>

<output>
After completion, create `.planning/phases/32-job-aggregator-apis/32-02-SUMMARY.md`
</output>
