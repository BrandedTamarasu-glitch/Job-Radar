---
phase: 12-api-foundation
plan: 02
type: execute
wave: 2
depends_on: ["12-01"]
files_modified:
  - job_radar/api_setup.py
  - job_radar/search.py
  - tests/test_api_config.py
  - tests/test_rate_limits.py
autonomous: true

must_haves:
  truths:
    - "Running job-radar --setup-apis prompts user for API keys and writes .env file"
    - "Running job-radar --test-apis pings each configured API and reports pass/fail"
    - "--verbose flag shows rate limit remaining quota and reset time per source"
    - "load_api_credentials() is called in main() before any API fetching happens"
    - "Tests verify credential loading, missing key graceful degradation, and rate limit check/deny"
  artifacts:
    - path: "job_radar/api_setup.py"
      provides: "setup_apis() interactive wizard and test_apis() validation command"
      contains: "setup_apis"
    - path: "job_radar/search.py"
      provides: "--setup-apis and --test-apis CLI flags, load_api_credentials() call in main()"
      contains: "setup-apis"
    - path: "tests/test_api_config.py"
      provides: "Tests for load_api_credentials, get_api_key, ensure_env_example"
      contains: "test_get_api_key"
    - path: "tests/test_rate_limits.py"
      provides: "Tests for check_rate_limit, get_rate_limit_status, RATE_LIMITS"
      contains: "test_check_rate_limit"
  key_links:
    - from: "job_radar/search.py"
      to: "job_radar/api_config.py"
      via: "load_api_credentials() called in main() after logging setup"
      pattern: "load_api_credentials"
    - from: "job_radar/search.py"
      to: "job_radar/api_setup.py"
      via: "--setup-apis and --test-apis CLI flags dispatch to setup_apis()/test_apis()"
      pattern: "setup_apis|test_apis"
    - from: "job_radar/api_setup.py"
      to: "job_radar/api_config.py"
      via: "Imports get_api_key for test_apis validation"
      pattern: "from .api_config import"
---

<objective>
Integrate API credential and rate limiting infrastructure into the CLI with interactive setup commands and comprehensive test coverage.

Purpose: Make the infrastructure from Plan 12-01 accessible to users via --setup-apis and --test-apis commands, wire load_api_credentials() into the main pipeline, and verify all infrastructure works correctly through tests.

Output: api_setup.py module with interactive wizard and validation, updated search.py CLI, and test files for api_config and rate_limits modules.
</objective>

<execution_context>
@/Users/coryebert/.claude/get-shit-done/workflows/execute-plan.md
@/Users/coryebert/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12-api-foundation/12-RESEARCH.md
@.planning/phases/12-api-foundation/12-CONTEXT.md
@.planning/phases/12-api-foundation/12-01-SUMMARY.md
@job_radar/search.py (add CLI flags and load_api_credentials() call)
@job_radar/wizard.py (reference for questionary patterns from Phase 7)
@job_radar/api_config.py (created in 12-01)
@job_radar/rate_limits.py (created in 12-01)
@tests/ (existing test files for pattern reference)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create api_setup.py and integrate CLI flags in search.py</name>
  <files>job_radar/api_setup.py, job_radar/search.py</files>
  <action>
**Create `job_radar/api_setup.py`** with two main functions:

1. `setup_apis()`:
   - Interactive API key setup using questionary (reuse Phase 7 patterns from wizard.py)
   - Print header: "API Key Setup" with separator line
   - Print "Configure API keys for job sources. Press Enter to skip optional sources."
   - Section 1 — Adzuna:
     - Print signup URL: "Sign up at: https://developer.adzuna.com/"
     - Prompt for ADZUNA_APP_ID (text input, can skip with Enter)
     - If ID provided, prompt for ADZUNA_APP_KEY
   - Section 2 — Authentic Jobs:
     - Print signup URL: "Sign up at: https://authenticjobs.com/api/"
     - Prompt for AUTHENTIC_JOBS_API_KEY (text input, can skip)
   - Show summary: which sources configured vs skipped
   - Confirm save with questionary.confirm()
   - If confirmed: build .env content string, write atomically to `.env` in cwd
   - Atomic write: use tempfile.mkstemp() + os.fdopen() + Path.replace() pattern (see research Pattern 5)
   - Print success message with path and suggestion to run --test-apis
   - If cancelled: print "Setup cancelled." and return
   - Handle KeyboardInterrupt (Ctrl+C) gracefully: print newline, "Setup cancelled.", return

2. `test_apis()`:
   - Load credentials first: call `load_api_credentials()` from api_config
   - Print header: "Testing API Keys"
   - For each API source (Adzuna, Authentic Jobs):
     - Check if keys exist via `os.getenv()`
     - If not configured: print "Not configured (skipped)" and continue
     - If configured: make a minimal test request (GET with timeout=10)
       - Adzuna: `https://api.adzuna.com/v1/api/jobs/us/search/1?app_id={id}&app_key={key}&results_per_page=1`
       - Authentic Jobs: `https://authenticjobs.com/api/?api_key={key}&method=aj.jobs.search&keywords=test&format=json`
     - Print result: pass (200), fail (401/403 "Invalid credentials"), error (network/timeout)
   - Print summary: X/Y configured APIs working
   - If any failed: print suggestion to run --setup-apis

**Update `job_radar/search.py`:**

1. Add new CLI flags in `parse_args()` function, in a new "API Options" argument group:
   ```python
   api_group = parser.add_argument_group('API Options')
   api_group.add_argument(
       "--setup-apis",
       action="store_true",
       help="Interactive setup for API source credentials",
   )
   api_group.add_argument(
       "--test-apis",
       action="store_true",
       help="Test configured API keys and report status",
   )
   ```
   Place this group after "Profile Options" and before "Developer Options".

2. Add early exit handlers in `main()` function, after `args = parse_args(config)` but BEFORE profile loading:
   ```python
   if args.setup_apis:
       from .api_setup import setup_apis
       setup_apis()
       sys.exit(0)

   if args.test_apis:
       from .api_setup import test_apis
       test_apis()
       sys.exit(0)
   ```
   These must exit early — they don't need a profile.

3. Add `load_api_credentials()` call in `main()`, after logging is configured (after line ~502 where noisy libraries are quieted), before any fetching:
   ```python
   # Load API credentials from .env (before fetching)
   from .api_config import load_api_credentials
   load_api_credentials()
   ```

Use consistent UI style: match existing print formatting in search.py (use `C.BOLD`, `C.GREEN`, `C.YELLOW`, `C.RED`, `C.RESET` for colored output where appropriate, but api_setup.py can use plain print since it's a standalone flow).
  </action>
  <verify>
Run: `python -c "from job_radar.api_setup import setup_apis, test_apis; print('imports OK')"`
Run: `python -m job_radar --help` and verify --setup-apis and --test-apis appear in help output.
Verify search.py has load_api_credentials() call in main().
  </verify>
  <done>
api_setup.py provides setup_apis() and test_apis() functions. search.py has --setup-apis and --test-apis CLI flags that dispatch correctly. load_api_credentials() is called in main() before fetching. --setup-apis and --test-apis exit early without requiring a profile.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create tests for api_config and rate_limits modules</name>
  <files>tests/test_api_config.py, tests/test_rate_limits.py</files>
  <action>
**Create `tests/test_api_config.py`** with these test cases:

1. `test_load_api_credentials_no_env_file()`:
   - Use tmp_path fixture, chdir to it (no .env exists)
   - Call load_api_credentials() — should not crash, no exception raised
   - Verify it logs info message about no .env found (use caplog)

2. `test_load_api_credentials_loads_env_file(tmp_path)`:
   - Write a .env file in tmp_path with `ADZUNA_APP_ID=test123`
   - Monkeypatch cwd to tmp_path
   - Call load_api_credentials()
   - Assert `os.getenv("ADZUNA_APP_ID") == "test123"`
   - Clean up env var after test

3. `test_get_api_key_returns_value_when_set(monkeypatch)`:
   - monkeypatch.setenv("ADZUNA_APP_ID", "my_id")
   - Assert get_api_key("ADZUNA_APP_ID", "Adzuna") == "my_id"

4. `test_get_api_key_returns_none_when_missing(monkeypatch)`:
   - monkeypatch.delenv("ADZUNA_APP_ID", raising=False)
   - Assert get_api_key("ADZUNA_APP_ID", "Adzuna") is None

5. `test_get_api_key_logs_warning_when_missing(monkeypatch, caplog)`:
   - monkeypatch.delenv("ADZUNA_APP_ID", raising=False)
   - Call get_api_key("ADZUNA_APP_ID", "Adzuna")
   - Assert "Skipping Adzuna" in caplog.text

6. `test_ensure_env_example_creates_file(tmp_path, monkeypatch)`:
   - monkeypatch.chdir(tmp_path)
   - Call ensure_env_example()
   - Assert (tmp_path / ".env.example").exists()
   - Assert "ADZUNA_APP_ID" in file content
   - Assert "https://developer.adzuna.com/" in file content

7. `test_ensure_env_example_does_not_overwrite(tmp_path, monkeypatch)`:
   - Write existing .env.example with custom content in tmp_path
   - monkeypatch.chdir(tmp_path)
   - Call ensure_env_example()
   - Assert file content unchanged (not overwritten)

**Create `tests/test_rate_limits.py`** with these test cases:

1. `test_rate_limits_dict_has_expected_sources()`:
   - Assert "adzuna" in RATE_LIMITS
   - Assert "authentic_jobs" in RATE_LIMITS

2. `test_check_rate_limit_allows_first_call(tmp_path, monkeypatch)`:
   - monkeypatch.chdir(tmp_path) so SQLite files go to tmp
   - Clear _limiters cache (reset module state)
   - Assert check_rate_limit("adzuna") is True

3. `test_check_rate_limit_returns_bool(tmp_path, monkeypatch)`:
   - monkeypatch.chdir(tmp_path)
   - Clear _limiters cache
   - result = check_rate_limit("adzuna")
   - Assert isinstance(result, bool)

4. `test_get_rate_limit_status_returns_dict(tmp_path, monkeypatch)`:
   - monkeypatch.chdir(tmp_path)
   - Clear _limiters cache
   - status = get_rate_limit_status("adzuna")
   - Assert isinstance(status, dict)
   - Assert "remaining" in status
   - Assert "configured_rate" in status

5. `test_rate_limit_creates_db_file(tmp_path, monkeypatch)`:
   - monkeypatch.chdir(tmp_path)
   - Clear _limiters cache
   - Call check_rate_limit("adzuna")
   - Assert (tmp_path / ".rate_limits" / "adzuna.db").exists()

6. `test_independent_source_limits(tmp_path, monkeypatch)`:
   - monkeypatch.chdir(tmp_path)
   - Clear _limiters cache
   - Call check_rate_limit("adzuna") and check_rate_limit("authentic_jobs") separately
   - Both should return True (independent limits, not shared)

IMPORTANT: The _limiters dict is module-level state. Tests MUST clear it between test functions to avoid cross-contamination. Create a fixture:
```python
@pytest.fixture(autouse=True)
def reset_limiter_cache():
    from job_radar import rate_limits
    rate_limits._limiters.clear()
    yield
    rate_limits._limiters.clear()
```

Use pytest conventions matching existing test files: function-based tests (not classes), pytest fixtures, monkeypatch for env vars, tmp_path for filesystem isolation.
  </action>
  <verify>
Run: `python -m pytest tests/test_api_config.py tests/test_rate_limits.py -v`
All tests pass. No import errors. No test pollution (each test isolated with tmp_path and monkeypatch).
  </verify>
  <done>
test_api_config.py has 7 tests covering credential loading, key retrieval, missing key warning, and .env.example creation. test_rate_limits.py has 6 tests covering rate limit dict, allow/deny, status reporting, file persistence, and source independence. All tests pass with pytest.
  </done>
</task>

</tasks>

<verification>
1. `python -m pytest tests/test_api_config.py tests/test_rate_limits.py -v` — all tests pass
2. `python -m job_radar --help` — shows --setup-apis and --test-apis in "API Options" group
3. `python -c "from job_radar.api_setup import setup_apis, test_apis"` — imports cleanly
4. `grep -n "load_api_credentials" job_radar/search.py` — confirms call exists in main()
5. `python -m pytest tests/ -v` — full test suite still passes (no regressions)
</verification>

<success_criteria>
- api_setup.py provides interactive --setup-apis wizard and --test-apis validation
- search.py has --setup-apis and --test-apis flags that exit early (no profile needed)
- load_api_credentials() is called in main() after logging setup, before fetching
- 7 tests for api_config pass
- 6 tests for rate_limits pass
- Full existing test suite still passes (no regressions)
</success_criteria>

<output>
After completion, create `.planning/phases/12-api-foundation/12-02-SUMMARY.md`
</output>
