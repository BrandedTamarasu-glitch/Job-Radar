---
phase: 29-profile-setup-search-controls
plan: 03
type: execute
wave: 2
depends_on: ["29-01", "29-02"]
files_modified:
  - job_radar/gui/main_window.py
  - pyproject.toml
autonomous: false

must_haves:
  truths:
    - "Clicking 'Get Started' on welcome screen shows resume/manual choice then profile form"
    - "Clicking 'Edit Profile' on profile summary switches to pre-filled edit form"
    - "After saving profile, GUI navigates to Search tab with success message"
    - "Search tab shows search controls (date range, min score, new-only) above Run Search button"
    - "Clicking Run Search executes real search with progress showing per-source job counts (e.g., 'Dice: 12 jobs found')"
    - "On search completion, user sees 'Search complete! X jobs found' with Open Report button"
    - "Clicking Open Report opens HTML report in default browser"
    - "All GUI operations use existing business logic modules without code duplication"
  artifacts:
    - path: "job_radar/gui/main_window.py"
      provides: "Fully wired main window with profile form, search controls, real search execution, and report opening"
      exports: ["MainWindow", "launch_gui"]
  key_links:
    - from: "job_radar/gui/main_window.py"
      to: "job_radar/gui/profile_form.py"
      via: "ProfileForm instantiation for create and edit modes"
      pattern: "from job_radar\\.gui\\.profile_form import ProfileForm"
    - from: "job_radar/gui/main_window.py"
      to: "job_radar/gui/search_controls.py"
      via: "SearchControls instantiation in Search tab"
      pattern: "from job_radar\\.gui\\.search_controls import SearchControls"
    - from: "job_radar/gui/main_window.py"
      to: "job_radar/gui/worker_thread.py"
      via: "create_search_worker() replacing create_mock_worker()"
      pattern: "from job_radar\\.gui\\.worker_thread import create_search_worker"
    - from: "job_radar/gui/main_window.py"
      to: "webbrowser"
      via: "webbrowser.open() for opening HTML report"
      pattern: "import webbrowser"
---

<objective>
Wire Plan 01's profile form and Plan 02's search controls into main_window.py, replacing all Phase 28 stubs with real functionality, and add a visual verification checkpoint.

Purpose: Complete the integration of all Phase 29 components into the main GUI window, delivering full feature parity with the CLI (PROF-01-04, SRCH-01-05, PROG-01-02). This is the final assembly plan that connects standalone widgets to the application shell.

Output: Updated main_window.py with complete profile creation/editing flow, search controls, real search execution, progress display with per-source job counts, and report opening.
</objective>

<execution_context>
@/home/corye/.claude/get-shit-done/workflows/execute-plan.md
@/home/corye/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/29-profile-setup-search-controls/29-CONTEXT.md
@.planning/phases/29-profile-setup-search-controls/29-RESEARCH.md

# CRITICAL: Must read Plan 01 and 02 summaries to know exact APIs
@.planning/phases/29-profile-setup-search-controls/29-01-SUMMARY.md
@.planning/phases/29-profile-setup-search-controls/29-02-SUMMARY.md

# The file being modified
@job_radar/gui/main_window.py

# New modules from Plans 01 and 02
@job_radar/gui/profile_form.py
@job_radar/gui/search_controls.py
@job_radar/gui/worker_thread.py
@job_radar/gui/tag_chip_widget.py

# Existing modules for integration
@job_radar/profile_manager.py
@job_radar/config.py
@job_radar/paths.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Wire profile form, search controls, and real search into main_window.py</name>
  <files>job_radar/gui/main_window.py, pyproject.toml</files>
  <action>
Rewrite main_window.py to integrate all Phase 29 components. This is a significant update touching most methods. Read the current main_window.py first, then the Plan 01/02 SUMMARY files to understand the exact APIs of ProfileForm, SearchControls, and SearchWorker.

**New imports:**
```python
import webbrowser
from job_radar.gui.profile_form import ProfileForm
from job_radar.gui.search_controls import SearchControls
from job_radar.gui.worker_thread import create_search_worker
from job_radar.config import load_config
```

**Welcome screen changes:**
- Replace stub `_on_get_started` with method that creates ProfileForm in create mode
- The ProfileForm replaces the welcome screen content (same window, same area — per locked decision "form replaces content in-place")
- on_save_callback: after successful save, update `self._profile_exists = True`, destroy the form, call `_show_main_tabs()`, and set the active tab to "Search" with a brief success message
- on_cancel_callback: destroy the form and re-show the welcome screen

**Profile tab changes:**
- Add "Edit Profile" button at the bottom of the profile summary view
- When clicked: destroy current tab content, create ProfileForm with existing_profile=loaded_profile in edit mode
- on_save_callback: destroy form, rebuild profile summary display with updated data, switch to Search tab with success message
- on_cancel_callback: destroy form, rebuild profile summary display

**Search tab changes:**
- Add SearchControls widget above the Run Search button area
- SearchControls loads defaults from config.json on creation
- Run Search button: disabled if no profile, enabled if profile exists
- Replace `_start_mock_search` with `_start_real_search`:
  1. Validate search controls: `search_controls.validate()` — if invalid, show inline error
  2. Get config: `search_config = search_controls.get_config()`
  3. Load profile: `profile = load_profile(profile_path)`
  4. Create real worker: `create_search_worker(self._queue, profile, search_config)`
  5. Start thread

**Progress display changes per locked decision requiring per-source job counts:**
- Immediate: show "Starting search..." before first source (already works from Phase 28)
- Enhanced source progress with per-source job counts: update _check_queue to handle new message types:
  - `("source_started", name, current, total)`: show "Fetching {name}..."
  - `("source_complete", name, current, total, job_count)`: display "{name}: {job_count} jobs found" in a running tally list below the progress bar. Each source gets its own line as it completes, building up a visible list (e.g., "Dice: 12 jobs found", then "Adzuna: 8 jobs found" appears below it, etc.). Use a CTkTextbox or stacked CTkLabels to show this running tally. The job_count comes from the 5th element of the queue message tuple (added in Plan 02's sources.py modification).
  - `("search_complete", job_count, report_path)`: show completion view
  - Keep backward compatibility with old `("progress", ...)` and `("complete", ...)` for mock workers if needed for testing

**Completion view per locked decisions:**
- Show "Search complete! X jobs found"
- Show "Open Report" button (NOT auto-open — per locked decision)
- Open Report button calls `webbrowser.open(Path(report_path).as_uri())`
- Also show "New Search" button to return to search idle state
- Store report_path as instance variable so Open Report can access it

**Error handling per locked decisions:**
- Partial source failures: silent (fetch_all handles internally, report opens with whatever succeeded)
- Total failure (all sources fail): show error message via existing _show_error_dialog
- PROG-02: error messages appear in GUI with actionable text

**Tab navigation after profile save:**
- Store reference to tabview as `self._tabview` so methods can call `self._tabview.set("Search")`
- Show brief success message (CTkLabel that auto-hides after 3 seconds using .after())

**pyproject.toml update:**
- Check if CTkDatePicker is used in search_controls.py. If so, add `tkctkdatepicker` to dependencies. If search_controls.py uses plain CTkEntry fallback for dates, no pyproject.toml change needed. Read search_controls.py first to determine.

Follow codebase conventions: module docstring updated, type hints, private methods with underscore prefix. Keep main_window.py as the single integration point — no business logic, only widget orchestration.
  </action>
  <verify>
Run: `python -m py_compile job_radar/gui/main_window.py && echo 'Syntax OK'`
Run: `python -c "from job_radar.gui.main_window import MainWindow, launch_gui; print('MainWindow imports OK')"`
Grep to confirm all integrations wired:
- `grep -c "ProfileForm" job_radar/gui/main_window.py` should be >= 2 (import + usage)
- `grep -c "SearchControls" job_radar/gui/main_window.py` should be >= 2
- `grep -c "create_search_worker" job_radar/gui/main_window.py` should be >= 1
- `grep -c "webbrowser" job_radar/gui/main_window.py` should be >= 2 (import + usage)
- `grep -c "source_complete\|source_started" job_radar/gui/main_window.py` should be >= 2
- `grep -c "job_count\|jobs found" job_radar/gui/main_window.py` should be >= 2 (per-source job count display)
- `grep -c "Edit Profile" job_radar/gui/main_window.py` should be >= 1
- `grep -c "Open Report" job_radar/gui/main_window.py` should be >= 1
Verify mock worker import removed or updated:
- `grep "create_mock_worker" job_radar/gui/main_window.py` — should either be removed or kept alongside create_search_worker
  </verify>
  <done>
main_window.py fully integrates ProfileForm (create + edit modes), SearchControls (date range, min score, new-only), real SearchWorker (full pipeline), enhanced progress display showing per-source job counts in "Dice: 12 jobs found" format as each source completes, completion view with "Open Report" button (webbrowser.open), and tab navigation after profile save. No business logic duplication — all operations delegate to existing modules.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Visual verification of complete GUI flow</name>
  <files>job_radar/gui/main_window.py</files>
  <action>
Human visual verification checkpoint. All code is already implemented in Task 1. This task verifies the complete GUI flow works end-to-end covering all 11 requirements (PROF-01-04, SRCH-01-05, PROG-01-02).

Launch the GUI and test the complete flow:

1. **First launch (no profile):**
   - Run: `python -m job_radar` (no args)
   - Verify: Welcome screen appears with "Get Started" button
   - Click "Get Started"
   - Verify: Resume upload / manual choice appears
   - Click "Fill Manually"
   - Verify: Profile form appears with grouped sections (Identity, Skills, Preferences, etc.)

2. **Form validation:**
   - Leave Name empty, tab to next field
   - Verify: Red error text appears below Name field
   - Enter invalid years experience (e.g., "abc")
   - Verify: Red error appears
   - Click Save with errors present
   - Verify: First invalid field is focused

3. **Profile creation:**
   - Fill in valid data: name, titles (via tag chips), skills (via tag chips), years experience
   - Verify: Tag chips show as visual pills with X buttons
   - Click Save
   - Verify: Navigates to Search tab with success message

4. **Edit profile:**
   - Click Profile tab
   - Verify: Profile summary displays with "Edit Profile" button
   - Click "Edit Profile"
   - Verify: Form appears pre-filled with saved values
   - Modify a field, click Cancel
   - Verify: "Discard changes?" confirmation dialog appears

5. **Search controls:**
   - On Search tab, verify: date range controls, min score entry, new-only toggle, Run Search button
   - Verify: Min score shows default value (2.8 or from config)

6. **Search execution (if internet available):**
   - Click "Run Search"
   - Verify: Progress view shows per-source job counts as each source completes (e.g., "Dice: 12 jobs found", "Adzuna: 8 jobs found")
   - Verify: Completion shows "Search complete! X jobs found" with "Open Report" button
   - Click "Open Report" — HTML report opens in browser

7. **Cancel search:**
   - Start search, click Cancel
   - Verify: Cancels cleanly, returns to idle state
  </action>
  <verify>Human confirms all 7 verification steps pass visually</verify>
  <done>All 11 Phase 29 requirements verified working in the GUI by human tester</done>
</task>

</tasks>

<verification>
1. main_window.py compiles and imports cleanly
2. All Phase 29 components are wired: ProfileForm, SearchControls, SearchWorker
3. No business logic duplication — all operations delegate to existing modules
4. Queue message handling covers both mock and real worker message types
5. Progress display shows per-source job counts in "Source: N jobs found" format per locked decision
6. Human visual verification confirms all 11 requirements work end-to-end
</verification>

<success_criteria>
- Welcome screen "Get Started" opens profile form (not a stub)
- Profile tab has "Edit Profile" button that opens pre-filled form
- Search tab has configurable controls above Run Search button
- Real search execution with per-source progress showing "Source: N jobs found" as each completes
- Completion view with "Open Report" button that opens browser
- All 11 Phase 29 requirements (PROF-01-04, SRCH-01-05, PROG-01-02) verified visually
</success_criteria>

<output>
After completion, create `.planning/phases/29-profile-setup-search-controls/29-03-SUMMARY.md`
</output>
