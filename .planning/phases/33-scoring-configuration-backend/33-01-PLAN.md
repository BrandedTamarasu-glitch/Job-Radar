---
phase: 33-scoring-configuration-backend
plan: 01
type: tdd
wave: 1
depends_on: []
files_modified:
  - job_radar/profile_manager.py
  - tests/test_profile_manager.py
autonomous: true

must_haves:
  truths:
    - "Existing v1 profiles automatically migrate to v2 schema on first load without data loss"
    - "A backup of the v1 profile is created before migration (profile_v1_backup.json)"
    - "Default scoring_weights in migrated profiles exactly reproduce current hardcoded scoring behavior"
    - "Corrupted or unexpected profile structures get default scoring_weights with a warning, never crash"
    - "Old profiles without scoring_weights fall back to hardcoded defaults (zero errors)"
  artifacts:
    - path: "job_radar/profile_manager.py"
      provides: "DEFAULT_SCORING_WEIGHTS constant, v1->v2 migration, scoring_weights/staffing_preference validation"
      contains: "DEFAULT_SCORING_WEIGHTS"
    - path: "tests/test_profile_manager.py"
      provides: "Tests for v1->v2 migration, validation, backup, and graceful fallback"
      contains: "test_load_v1_migrates_to_v2"
  key_links:
    - from: "job_radar/profile_manager.py"
      to: "DEFAULT_SCORING_WEIGHTS"
      via: "constant used by migration AND scoring.py fallback"
      pattern: "DEFAULT_SCORING_WEIGHTS"
    - from: "job_radar/profile_manager.py"
      to: "load_profile"
      via: "v1->v2 migration branch in schema_version check"
      pattern: "schema_version == 1"
---

<objective>
Add v1-to-v2 profile schema migration with scoring_weights and staffing_preference fields, validated with TDD.

Purpose: Enable user-customizable scoring weights by extending the profile schema with backward-compatible auto-migration that preserves score stability for existing users.

Output: Updated profile_manager.py with DEFAULT_SCORING_WEIGHTS constant, v1->v2 migration logic, extended validation, and comprehensive test coverage.
</objective>

<execution_context>
@/home/corye/.claude/get-shit-done/workflows/execute-plan.md
@/home/corye/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/33-scoring-configuration-backend/33-RESEARCH.md
@job_radar/profile_manager.py
@tests/test_profile_manager.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: RED - Write failing tests for v2 schema migration and validation</name>
  <files>tests/test_profile_manager.py</files>
  <action>
Add the following test cases to `tests/test_profile_manager.py`. Import `DEFAULT_SCORING_WEIGHTS` from `job_radar.profile_manager` (will fail initially since constant doesn't exist yet).

**Migration tests (new section "7. v1->v2 migration tests"):**

1. `test_load_v1_migrates_to_v2` - Write a v1 profile (with `schema_version: 1`, valid required fields) to disk. Call `load_profile()`. Assert:
   - returned profile has `schema_version == 2`
   - returned profile has `scoring_weights` dict matching `DEFAULT_SCORING_WEIGHTS` exactly
   - returned profile has `staffing_preference == "neutral"`
   - file on disk is updated with schema_version 2

2. `test_v1_migration_creates_backup` - Write a v1 profile to disk. Call `load_profile()`. Assert a backup file exists in the backup dir matching `profile_v1_backup_*.json` pattern (or standard backup pattern).

3. `test_v1_migration_preserves_existing_data` - Write a v1 profile with ALL fields populated (name, target_titles, core_skills, years_experience, level, location, arrangement, domain_expertise, comp_floor, dealbreakers, min_score, plus a custom_field). Call `load_profile()`. Assert every original field is preserved unchanged alongside the new scoring_weights and staffing_preference.

4. `test_v0_migrates_directly_to_v2` - Write a v0 profile (no schema_version key). Call `load_profile()`. Assert profile has schema_version 2, scoring_weights, and staffing_preference. (v0 profiles should now migrate all the way to v2, not stop at v1.)

5. `test_load_v2_no_migration` - Write a v2 profile (with schema_version 2, scoring_weights, and staffing_preference already present). Call `load_profile()`. Assert it loads unchanged with no re-save (mock save_profile to assert it's NOT called for v2 profiles).

**Validation tests (new section "8. scoring_weights validation"):**

6. `test_validate_scoring_weights_valid` - Profile with valid scoring_weights dict (all 6 components, sum to 1.0, each >= 0.05). Assert no error.

7. `test_validate_scoring_weights_missing_component` - Profile with scoring_weights missing "domain" key. Assert raises `MissingFieldError` or `ProfileValidationError`.

8. `test_validate_scoring_weights_below_minimum` - Profile with scoring_weights where one weight is 0.02 (below 0.05 minimum). Assert raises `ProfileValidationError`.

9. `test_validate_scoring_weights_bad_sum` - Profile with scoring_weights summing to 0.80. Assert raises `ProfileValidationError` with message about sum to 1.0.

10. `test_validate_staffing_preference_valid` - Profile with staffing_preference "boost", "neutral", "penalize" each passes validation.

11. `test_validate_staffing_preference_invalid` - Profile with staffing_preference "extreme" raises `ProfileValidationError`.

12. `test_graceful_fallback_corrupted_weights` - Profile with schema_version 2 but scoring_weights as a string (not dict). Load should add default scoring_weights, log warning, keep running. (This tests the graceful fallback per user decision.)

All tests should use the existing `valid_profile`, `profile_path`, and `mock_backup_dir` fixtures where applicable.

Run `pytest tests/test_profile_manager.py -x` -- tests MUST FAIL (RED phase).

Commit: `test(33-01): add failing tests for v2 schema migration and validation`
  </action>
  <verify>Run `pytest tests/test_profile_manager.py -x` and confirm new tests fail with ImportError (DEFAULT_SCORING_WEIGHTS) or AssertionError (migration not implemented yet). Existing tests must still pass.</verify>
  <done>12+ new test cases exist covering migration, backup, data preservation, validation of scoring_weights and staffing_preference, and graceful fallback.</done>
</task>

<task type="auto">
  <name>Task 2: GREEN + REFACTOR - Implement v2 migration and validation in profile_manager.py</name>
  <files>job_radar/profile_manager.py, tests/test_profile_manager.py</files>
  <action>
Update `job_radar/profile_manager.py` to make all tests pass:

**1. Add DEFAULT_SCORING_WEIGHTS constant (after CURRENT_SCHEMA_VERSION):**
```python
CURRENT_SCHEMA_VERSION = 2  # Bumped from 1

DEFAULT_SCORING_WEIGHTS = {
    "skill_match": 0.25,
    "title_relevance": 0.15,
    "seniority": 0.15,
    "location": 0.15,
    "domain": 0.10,
    "response_likelihood": 0.20,
}
```
These values are extracted from scoring.py lines 47-54 and MUST match exactly for score stability.

**2. Update load_profile() migration logic:**
Replace the existing migration block (lines 267-273) with:
```python
schema_version = profile.get("schema_version", 0)

if schema_version < 2:
    # Create explicit v1 backup before migration
    _create_backup(profile_path)

    # Add scoring weights with defaults matching current hardcoded behavior
    if "scoring_weights" not in profile:
        profile["scoring_weights"] = dict(DEFAULT_SCORING_WEIGHTS)

    # Add staffing preference -- NEW default is neutral (changed from old +4.5 boost)
    if "staffing_preference" not in profile:
        profile["staffing_preference"] = "neutral"

    profile["schema_version"] = CURRENT_SCHEMA_VERSION
    log.debug("Migrated profile from v%d to v%d", schema_version, CURRENT_SCHEMA_VERSION)
    save_profile(profile, profile_path)
```

This handles both v0 (no schema_version) AND v1 profiles in a single migration path. The `< 2` check means any profile below v2 gets migrated.

**3. Add graceful fallback for corrupted scoring_weights:**
Before calling `validate_profile(profile)` in `load_profile()`, add:
```python
# Graceful fallback for corrupted scoring_weights (per user decision)
if "scoring_weights" in profile and not isinstance(profile["scoring_weights"], dict):
    log.warning("Profile has corrupted scoring_weights (type=%s), resetting to defaults",
                type(profile["scoring_weights"]).__name__)
    profile["scoring_weights"] = dict(DEFAULT_SCORING_WEIGHTS)
```

**4. Extend validate_profile() with scoring_weights validation:**
After the existing min_score validation (around line 141), add:

- Check `scoring_weights` if present:
  - Must be a dict
  - Must contain all 6 required component keys: skill_match, title_relevance, seniority, location, domain, response_likelihood
  - Each weight must be a number (int or float) in range [0.05, 1.0]
  - Weights must sum to 1.0 (tolerance: 0.99-1.01 for float precision)
  - Raise `ProfileValidationError` with descriptive message on failure

- Check `staffing_preference` if present:
  - Must be one of: "boost", "neutral", "penalize"
  - Raise `ProfileValidationError` if invalid

**5. Export DEFAULT_SCORING_WEIGHTS in module's public API** so scoring.py and wizard.py can import it.

Run `pytest tests/test_profile_manager.py -v` -- ALL tests MUST pass (GREEN phase).

Then run `pytest` (full suite) to verify no regressions across all 482+ tests.

Commit: `feat(33-01): implement v2 schema migration with scoring weights and staffing preference`
  </action>
  <verify>Run `pytest tests/test_profile_manager.py -v` -- all tests pass. Run `pytest` -- all 482+ tests pass with zero failures.</verify>
  <done>CURRENT_SCHEMA_VERSION is 2. DEFAULT_SCORING_WEIGHTS constant exported. v1 profiles auto-migrate to v2 with scoring_weights and staffing_preference. Validation enforces sum-to-1.0, minimum 0.05, and valid staffing preference values. Corrupted scoring_weights gracefully reset to defaults. All tests pass.</done>
</task>

</tasks>

<verification>
1. `pytest tests/test_profile_manager.py -v` -- all tests pass including 12+ new migration/validation tests
2. `pytest` -- full test suite passes (482+ tests, zero failures)
3. Manual verification: Create a v1 profile JSON (schema_version: 1), run `python -c "from job_radar.profile_manager import load_profile; from pathlib import Path; p = load_profile(Path('/tmp/test_profile.json')); print(p['scoring_weights']); print(p['staffing_preference'])"` and confirm scoring_weights match DEFAULT_SCORING_WEIGHTS and staffing_preference is "neutral"
</verification>

<success_criteria>
- CURRENT_SCHEMA_VERSION bumped from 1 to 2
- DEFAULT_SCORING_WEIGHTS constant matches current hardcoded values exactly: skill_match(0.25), title_relevance(0.15), seniority(0.15), location(0.15), domain(0.10), response_likelihood(0.20)
- v0 and v1 profiles auto-migrate to v2 with backup on first load
- scoring_weights validated: 6 required components, each 0.05-1.0, sum to 1.0
- staffing_preference validated: must be "boost", "neutral", or "penalize"
- Corrupted scoring_weights gracefully reset with warning
- All existing tests pass (zero regressions)
</success_criteria>

<output>
After completion, create `.planning/phases/33-scoring-configuration-backend/33-01-SUMMARY.md`
</output>
