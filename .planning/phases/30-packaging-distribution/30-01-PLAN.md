---
phase: 30-packaging-distribution
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - entitlements.plist
  - job-radar.spec
  - .github/workflows/release.yml
autonomous: true

must_haves:
  truths:
    - "macOS builds include entitlements for Python JIT memory allocation"
    - "CI workflow smoke-tests executables after building them"
    - "macOS archive preserves symbolic links for shared library compatibility"
    - "GUI executable is separate from CLI executable in all platform builds"
  artifacts:
    - path: "entitlements.plist"
      provides: "macOS code signing entitlements"
      contains: "com.apple.security.cs.allow-unsigned-executable-memory"
    - path: "job-radar.spec"
      provides: "PyInstaller build configuration with entitlements"
      contains: "entitlements_file"
    - path: ".github/workflows/release.yml"
      provides: "CI/CD workflow with smoke tests"
      contains: "--version"
  key_links:
    - from: "job-radar.spec"
      to: "entitlements.plist"
      via: "entitlements_file parameter in BUNDLE and EXE blocks"
      pattern: "entitlements_file.*entitlements\\.plist"
    - from: ".github/workflows/release.yml"
      to: "job-radar.spec"
      via: "pyinstaller job-radar.spec --clean build step"
      pattern: "pyinstaller job-radar.spec"
---

<objective>
Add macOS code signing entitlements, update spec file, and enhance CI workflow with smoke tests

Purpose: Ensure production builds are properly signed for macOS, executable functionality is verified in CI, and distribution archives preserve file system integrity (symlinks). This is the build configuration foundation that Plan 02 will verify with actual builds.

Output: entitlements.plist, updated job-radar.spec, updated release.yml
</objective>

<execution_context>
@/home/corye/.claude/get-shit-done/workflows/execute-plan.md
@/home/corye/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/30-packaging-distribution/30-RESEARCH.md
@.planning/phases/28-gui-foundation-threading/28-01-SUMMARY.md
@job-radar.spec
@.github/workflows/release.yml
@entitlements.plist
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create entitlements.plist and update PyInstaller spec for macOS code signing</name>
  <files>entitlements.plist, job-radar.spec</files>
  <action>
1. Create `entitlements.plist` in the project root with the required macOS entitlement:
   - `com.apple.security.cs.allow-unsigned-executable-memory` set to `true`
   - This is required because Python's JIT compilation creates writable+executable memory at runtime
   - Use standard Apple plist XML format with proper DOCTYPE

2. Update `job-radar.spec` to reference the entitlements file:
   - In the `exe` EXE block (CLI): change `entitlements_file=None` to `entitlements_file='entitlements.plist'`
   - In the `gui_exe` EXE block (GUI): change `entitlements_file=None` to `entitlements_file='entitlements.plist'`
   - In the `BUNDLE` block (macOS .app): add `entitlements_file='entitlements.plist'` parameter
   - Keep `codesign_identity=None` (ad-hoc signing is sufficient for GitHub releases distribution)

Do NOT change any other spec file settings. The existing dual-executable setup, CustomTkinter asset bundling, hidden imports, and excludes are all correct.
  </action>
  <verify>
Verify entitlements.plist exists and contains the correct entitlement key:
```bash
cat entitlements.plist | grep "allow-unsigned-executable-memory"
```

Verify spec file references entitlements in all three locations:
```bash
grep -c "entitlements_file.*entitlements.plist" job-radar.spec
# Should return 3 (exe, gui_exe, BUNDLE)
```
  </verify>
  <done>entitlements.plist exists with com.apple.security.cs.allow-unsigned-executable-memory entitlement. job-radar.spec references entitlements_file='entitlements.plist' in both EXE blocks and the BUNDLE block.</done>
</task>

<task type="auto">
  <name>Task 2: Add CI smoke tests and fix macOS archive symlink preservation</name>
  <files>.github/workflows/release.yml</files>
  <action>
Update `.github/workflows/release.yml` with the following changes:

1. **Add smoke test steps after the build step** (before archive creation). Insert these steps after "Build with PyInstaller" and before the archive steps:

   - Linux smoke test (if: runner.os == 'Linux'):
     ```
     cd dist && ./job-radar/job-radar --version
     ```
   - Windows smoke test (if: runner.os == 'Windows', shell: pwsh):
     ```
     cd dist && .\job-radar\job-radar.exe --version
     ```
   - macOS smoke test (if: runner.os == 'macOS'):
     After the existing "Install Terminal launcher" step, add:
     ```
     cd dist/JobRadar.app/Contents/MacOS && ./job-radar-cli --version
     ```
   NOTE: Only test CLI `--version` (headless-safe). GUI requires a display server so skip automated GUI tests.

2. **Fix macOS archive to preserve symbolic links:**
   Change the macOS archive step from:
   ```
   zip -r ../job-radar-${{ github.ref_name }}-macos.zip JobRadar.app
   ```
   to:
   ```
   zip -r --symlinks ../job-radar-${{ github.ref_name }}-macos.zip JobRadar.app
   ```
   The `--symlinks` flag prevents symlinks from being replaced by file copies, which can cause shared library failures and bloat the archive.

3. **Add CustomTkinter asset verification step** after building (Linux only, for CI visibility):
   ```bash
   ls dist/job-radar/customtkinter/assets/themes/ && echo "CustomTkinter themes bundled OK"
   ls dist/job-radar/customtkinter/assets/fonts/ && echo "CustomTkinter fonts bundled OK"
   ```

Do NOT change the test job, build matrix, release job, or artifact upload logic. Only add smoke test steps and fix the macOS archive command.
  </action>
  <verify>
Verify the workflow file is valid YAML:
```bash
python -c "import yaml; yaml.safe_load(open('.github/workflows/release.yml'))"
```

Verify smoke test steps exist:
```bash
grep -c "\-\-version" .github/workflows/release.yml
# Should return 3 (Linux, Windows, macOS)
```

Verify symlinks flag added:
```bash
grep "symlinks" .github/workflows/release.yml
```

Verify asset verification step added:
```bash
grep "CustomTkinter themes bundled" .github/workflows/release.yml
```
  </verify>
  <done>CI workflow has smoke test steps for all 3 platforms testing --version after build. macOS archive uses --symlinks flag. CustomTkinter asset verification step confirms themes and fonts are bundled.</done>
</task>

</tasks>

<verification>
1. `entitlements.plist` exists in project root with correct XML plist format
2. `job-radar.spec` references entitlements in exe, gui_exe, and BUNDLE blocks
3. `.github/workflows/release.yml` has smoke tests for Linux, Windows, macOS
4. macOS archive step uses `--symlinks` flag
5. All files are syntactically valid (YAML, XML, Python)
</verification>

<success_criteria>
- entitlements.plist created with com.apple.security.cs.allow-unsigned-executable-memory
- job-radar.spec updated with entitlements_file in all 3 blocks (2 EXE + 1 BUNDLE)
- release.yml updated with 3 smoke tests and symlinks flag
- No existing build/CI functionality broken
</success_criteria>

<output>
After completion, create `.planning/phases/30-packaging-distribution/30-01-SUMMARY.md`
</output>
