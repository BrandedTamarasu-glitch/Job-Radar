---
phase: 25-profile-preview
plan: 02
type: execute
wave: 2
depends_on: ["25-01"]
files_modified:
  - job_radar/search.py
  - tests/test_profile_display.py
autonomous: true

must_haves:
  truths:
    - "Running job-radar displays profile preview after wizard check, before search begins"
    - "Running job-radar --view-profile displays profile and exits without running search"
    - "Running job-radar --view-profile with no profile launches wizard automatically"
    - "Running job-radar --no-wizard suppresses profile preview on startup"
    - "Running job-radar --help documents --view-profile alongside other profile management flags"
    - "--view-profile offers to edit with 'Want to edit? (y/N)' prompt"
  artifacts:
    - path: "job_radar/search.py"
      provides: "CLI integration of profile preview into main flow"
      contains: "view_profile"
    - path: "tests/test_profile_display.py"
      provides: "Unit tests for profile_display module and CLI integration"
      contains: "test_"
  key_links:
    - from: "job_radar/search.py"
      to: "job_radar/profile_display.py"
      via: "import and call display_profile"
      pattern: "from .profile_display import display_profile"
    - from: "job_radar/search.py"
      to: "argparse"
      via: "--view-profile flag in profile_group"
      pattern: "view.profile"
---

<objective>
Wire profile_display.py into search.py CLI flow: add --view-profile flag, integrate startup preview, update help text, and create comprehensive tests.

Purpose: This plan connects the display module (Plan 01) to the CLI entry point, implementing all 5 VIEW requirements. It also adds tests to ensure the display logic is correct and the CLI integration works.

Output: Updated search.py with profile preview in main flow, new test file for profile display
</objective>

<execution_context>
@/home/corye/.claude/get-shit-done/workflows/execute-plan.md
@/home/corye/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/25-profile-preview/25-RESEARCH.md
@.planning/phases/25-profile-preview/25-01-SUMMARY.md
@job_radar/search.py
@job_radar/profile_display.py (created in Plan 01)
@job_radar/profile_manager.py
@tests/test_entry_integration.py (existing CLI integration test patterns)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add --view-profile flag and integrate preview into main()</name>
  <files>job_radar/search.py</files>
  <action>
Three changes to search.py:

**1. Add --view-profile argument to parse_args():**

Add to the existing `profile_group` (Profile Options):

```python
profile_group.add_argument(
    "--view-profile",
    action="store_true",
    help="Display your current profile settings and exit",
)
```

**2. Update --no-wizard help text:**

Change the existing `--no-wizard` argument help from `"Skip setup wizard (for testing)"` to:

```python
"Skip setup wizard and profile preview (quiet mode)"
```

**3. Update help description and epilog:**

Update the `description` in parse_args() to mention profile management. Update the `epilog` examples to include:

```
  job-radar --view-profile              View current profile settings
```

Also add a profile management section to the epilog:

```
Profile Management:
  --view-profile                       Show profile and offer to edit
  --no-wizard                          Suppress wizard and profile preview
  (coming soon: --update-skills, --set-min-score)
```

**4. Add --view-profile early exit handler in main():**

Insert AFTER the `--validate-profile` handler and BEFORE the profile path resolution block. The flow:

```python
if args.view_profile:
    from .profile_display import display_profile
    from pathlib import Path as _Path

    # Resolve profile path (same logic as main flow)
    vp_path_str = args.profile
    if not vp_path_str:
        from .paths import get_data_dir
        vp_path_str = str(get_data_dir() / "profile.json")

    vp_path = _Path(vp_path_str).expanduser()

    # If no profile exists, launch wizard to create one (per user decision)
    if not vp_path.exists():
        print(f"\n{C.YELLOW}No profile found -- launching setup wizard...{C.RESET}\n")
        from .wizard import run_setup_wizard
        if not run_setup_wizard():
            print("\nSetup cancelled.")
            sys.exit(1)

    # Load and display
    profile = load_profile(str(vp_path))
    display_profile(profile, config)

    # Offer to edit (Phase 26 forward-looking, per user decision)
    try:
        edit = input("\nWant to edit? (y/N) ").strip().lower()
        if edit == 'y':
            print(f"\n{C.YELLOW}Interactive editing coming in a future update.{C.RESET}")
    except (EOFError, KeyboardInterrupt):
        pass

    sys.exit(0)
```

Use `input()` for the "Want to edit?" prompt instead of questionary -- this is a simple y/N confirmation, no need for the full library. This avoids importing questionary at all in the --view-profile path.

**5. Add startup preview in main() after profile load:**

Insert AFTER the profile loading block (after `profile = load_profile_with_recovery(profile_path_str)`) and BEFORE `name = profile["name"]`:

```python
# Profile preview on startup (unless suppressed by --no-wizard)
if not args.no_wizard:
    from .profile_display import display_profile
    display_profile(profile, config)
```

The --no-wizard flag already controls whether we use `load_profile` (direct) vs `load_profile_with_recovery` (wizard). Per user decision, it ALSO suppresses the profile preview. This keeps one flag for quiet mode.
  </action>
  <verify>
Verify the argument is recognized:
```bash
cd /home/corye/Claude/Job-Radar && python -m job_radar.search --help 2>&1 | head -40
```
Confirm --view-profile appears in Profile Options group.
Confirm --no-wizard help text updated.

Test --view-profile with existing profile:
```bash
echo '{"name":"Test","target_titles":["Dev"],"core_skills":["Python"]}' > /tmp/test_profile.json
echo "n" | python -m job_radar.search --view-profile --profile /tmp/test_profile.json 2>&1
```
Confirm: profile displays, "Want to edit?" prompt appears, exits without search.

Existing test suite still passes: `pytest tests/ -q`
  </verify>
  <done>
--view-profile flag exists in parse_args() and works as early exit.
--view-profile with no profile triggers wizard launch.
--view-profile offers "Want to edit? (y/N)" after display.
Startup preview shows after profile load (unless --no-wizard).
--no-wizard suppresses both wizard recovery and profile preview.
--help documents --view-profile and profile management flags.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create tests for profile_display module and CLI integration</name>
  <files>tests/test_profile_display.py</files>
  <action>
Create `tests/test_profile_display.py` with tests covering both the display module and CLI integration. Use capsys for output capture and monkeypatch for environment/input mocking.

**Test categories:**

**1. Display Function Tests (6-8 tests):**

- `test_display_profile_basic` -- Minimal profile (name + required fields) renders with branded header and section structure
- `test_display_profile_full` -- Full profile with all fields shows all populated fields
- `test_display_profile_filters_empty_fields` -- Empty lists, None values, and missing keys are NOT shown in output
- `test_display_profile_lists_comma_separated` -- core_skills and other list fields render as "a, b, c"
- `test_display_profile_boolean_yes_no` -- new_only=True shows "Yes", new_only=False shows "No"
- `test_display_profile_numeric_plain` -- min_score shows "3.5" (no range hint), comp_floor shows "$120,000"
- `test_display_profile_no_color` -- With NO_COLOR=1, output contains no ANSI escape codes (\033)
- `test_display_profile_section_headers` -- Output contains section headers (IDENTITY, SKILLS, etc.)

**2. Field Filtering Tests (3 tests):**

- `test_empty_dealbreakers_hidden` -- dealbreakers=[] does not appear in output
- `test_none_comp_floor_hidden` -- comp_floor=None does not appear in output
- `test_no_config_skips_preferences` -- When config is None or empty {}, no PREFERENCES section appears

**3. CLI Integration Tests (3-4 tests):**

Test patterns: Use monkeypatch on sys.argv and capture output. Mock profile loading where needed.

- `test_view_profile_flag_in_args` -- parse_args() recognizes --view-profile as boolean flag
- `test_no_wizard_help_text_updated` -- --help output mentions "profile preview" in --no-wizard description
- `test_help_documents_view_profile` -- --help output contains --view-profile
- `test_help_documents_profile_management` -- help epilog mentions profile management section

**Test fixtures:**

```python
@pytest.fixture
def minimal_profile():
    return {
        "name": "Test User",
        "target_titles": ["Software Engineer"],
        "core_skills": ["Python", "Docker"],
    }

@pytest.fixture
def full_profile(minimal_profile):
    return {
        **minimal_profile,
        "years_experience": 7,
        "level": "senior",
        "location": "Remote",
        "arrangement": ["remote", "hybrid"],
        "secondary_skills": ["React", "TypeScript"],
        "certifications": ["AWS Solutions Architect"],
        "domain_expertise": ["fintech", "healthcare"],
        "dealbreakers": ["PHP", "Salesforce"],
        "comp_floor": 120000,
        "highlights": ["Led team of 5 engineers"],
    }

@pytest.fixture
def sample_config():
    return {"min_score": 3.5, "new_only": True}
```

**Key assertions:**
- Use `capsys.readouterr().out` for output capture
- Check for "Job Radar Profile" in branded header
- Check `\033` NOT in output for NO_COLOR tests (monkeypatch NO_COLOR=1 env var AND reinitialize _Colors)
- Check field labels ("Core Skills", "Location") appear in output
- Check field values ("Python, Docker") appear in output
- Check empty fields ("Dealbreakers") do NOT appear when empty

**For NO_COLOR testing:** The _Colors class initializes at import time. To test NO_COLOR properly, set `os.environ["NO_COLOR"] = "1"` via monkeypatch, then reload the module or directly set _Colors attributes to empty strings. Use the same pattern as search.py's --no-color handler.
  </action>
  <verify>
Run the new test file:
```bash
pytest tests/test_profile_display.py -v
```
All tests pass.

Run full test suite to verify no regressions:
```bash
pytest tests/ -q
```
Previous 373 tests + new tests all pass.
  </verify>
  <done>
tests/test_profile_display.py exists with 12+ tests covering:
- Display function output (branded header, sections, field rendering)
- Field filtering (empty fields hidden, None fields hidden)
- Boolean/numeric formatting (Yes/No, plain values)
- NO_COLOR compliance (no ANSI codes)
- CLI flag recognition (--view-profile in parse_args)
- Help text documentation (--view-profile, --no-wizard updated)
All tests pass, zero regressions in existing suite.
  </done>
</task>

</tasks>

<verification>
1. `python -m job_radar.search --help` shows --view-profile in Profile Options and profile management section in epilog
2. `echo "n" | python -m job_radar.search --view-profile --profile /tmp/test_profile.json` displays profile, asks to edit, exits
3. Profile preview appears on normal run (mock or real profile): startup shows formatted profile before "Job Search" banner
4. `python -m job_radar.search --no-wizard --profile /tmp/test_profile.json --dry-run` does NOT show profile preview
5. `pytest tests/test_profile_display.py -v` -- all tests pass
6. `pytest tests/ -q` -- full suite passes, zero regressions
</verification>

<success_criteria>
- VIEW-01: Profile preview displays automatically on startup (after wizard check, before search)
- VIEW-02: --view-profile displays profile and exits
- VIEW-03: Table layout with clear section headers, readable at 80 columns
- VIEW-04: --no-wizard suppresses automatic profile preview
- VIEW-05: --help documents all profile management commands and flags
- 12+ tests pass with zero regressions
</success_criteria>

<output>
After completion, create `.planning/phases/25-profile-preview/25-02-SUMMARY.md`
</output>
