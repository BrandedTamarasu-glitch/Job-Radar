---
phase: 24-profile-infrastructure
plan: 02
type: execute
wave: 2
depends_on: ["24-01"]
files_modified:
  - job_radar/wizard.py
  - job_radar/search.py
  - tests/test_profile_manager.py
autonomous: true

must_haves:
  truths:
    - "All profile I/O in the codebase routes through profile_manager.py"
    - "wizard.py uses profile_manager.save_profile() instead of its own _write_json_atomic()"
    - "search.py uses profile_manager.load_profile() and validate_profile() instead of inline logic"
    - "Invalid profile on load warns and offers to re-run wizard (per user decision)"
    - "Existing tests still pass after wiring changes"
  artifacts:
    - path: "job_radar/wizard.py"
      provides: "Wizard using profile_manager.save_profile() for profile writes"
      contains: "from .profile_manager import save_profile"
    - path: "job_radar/search.py"
      provides: "Search using profile_manager.load_profile() for profile reads and validation"
      contains: "from .profile_manager import"
    - path: "tests/test_profile_manager.py"
      provides: "Unit tests for profile_manager module"
      min_lines: 100
  key_links:
    - from: "job_radar/wizard.py"
      to: "job_radar/profile_manager.py"
      via: "import and call save_profile()"
      pattern: "save_profile\\("
    - from: "job_radar/search.py"
      to: "job_radar/profile_manager.py"
      via: "import and call load_profile()"
      pattern: "from .profile_manager import"
    - from: "tests/test_profile_manager.py"
      to: "job_radar/profile_manager.py"
      via: "import and test all public functions"
      pattern: "from job_radar.profile_manager import"
---

<objective>
Wire wizard.py and search.py to use the centralized profile_manager.py, removing duplicated profile I/O logic. Add comprehensive unit tests for the profile_manager module covering atomic writes, backup creation/rotation, validation, schema migration, and error handling.

Purpose: Completes the centralization goal (SAFE-05, SAFE-06, SAFE-08) by making all existing callers use profile_manager. Tests provide confidence for future phases (25-27) that will also use profile_manager.

Output: Modified wizard.py, modified search.py, new tests/test_profile_manager.py
</objective>

<execution_context>
@/home/corye/.claude/get-shit-done/workflows/execute-plan.md
@/home/corye/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/24-profile-infrastructure/24-CONTEXT.md
@.planning/phases/24-profile-infrastructure/24-01-SUMMARY.md
@job_radar/wizard.py
@job_radar/search.py
@job_radar/profile_manager.py
@job_radar/paths.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Wire wizard.py and search.py to use profile_manager.py</name>
  <files>job_radar/wizard.py, job_radar/search.py</files>
  <action>
**wizard.py changes:**

1. Remove the `_write_json_atomic()` function entirely (lines 145-186). It has been extracted to profile_manager.py.

2. Add import at top of file: `from .profile_manager import save_profile`

3. In `run_setup_wizard()`, replace the profile write at the end (around line 795):
   - OLD: `_write_json_atomic(profile_path, profile_data)`
   - NEW: `save_profile(profile_data, profile_path)`
   - This gives the wizard atomic writes, backups, validation, and schema versioning automatically.

4. Keep the config.json write using a local atomic write helper OR import `_write_json_atomic` from profile_manager. Since config.json is NOT a profile, the simplest approach: add a minimal `_write_json_atomic` inline for config.json only (it's 15 lines), OR import the private function. Claude's Discretion: import the private helper `from .profile_manager import _write_json_atomic as _write_json` for config.json write since it's the same pattern and avoids duplication. Document the import with a comment: `# Config.json also uses atomic write but doesn't need backup/validation`.

5. Do NOT change any wizard prompting logic, question order, or validation behavior. Only the file write path changes.

**search.py changes:**

1. Add import near top: `from .profile_manager import load_profile as _pm_load_profile, ProfileValidationError, ProfileNotFoundError, ProfileCorruptedError`

2. Rewrite `load_profile(path: str) -> dict` to delegate to profile_manager:
   ```python
   def load_profile(path: str) -> dict:
       """Load and validate a candidate profile JSON file."""
       from pathlib import Path as _Path
       try:
           return _pm_load_profile(_Path(path))
       except ProfileNotFoundError:
           print(f"{C.RED}Error: Profile not found: {path}{C.RESET}")
           print(f"\n{C.YELLOW}Tip:{C.RESET} Create a profile from the template:")
           print(f"  cp profiles/_template.json profiles/your_name.json")
           print(f"  job-radar --profile profiles/your_name.json")
           sys.exit(1)
       except ProfileCorruptedError as e:
           print(f"{C.RED}Error: {e}{C.RESET}")
           sys.exit(1)
       except ProfileValidationError as e:
           print(f"{C.RED}Error: {e}{C.RESET}")
           sys.exit(1)
   ```
   - Keep the same exit behavior (sys.exit(1)) for backward compatibility
   - The recommended field warnings can be removed since validate_profile handles validation now
   - Keep the friendly tone per user decision

3. Rewrite `load_profile_with_recovery(path: str, _retry: int = 0) -> dict` to delegate:
   ```python
   def load_profile_with_recovery(path: str, _retry: int = 0) -> dict:
       """Load profile with wizard recovery on corrupt/missing files."""
       from pathlib import Path as _Path

       if _retry > 1:
           print(f"\n{C.RED}Error: Profile setup failed after multiple attempts{C.RESET}")
           print(f"\n{C.YELLOW}Tip:{C.RESET} Use --profile flag to specify a valid profile:")
           print(f"  job-radar --profile profiles/your_name.json")
           sys.exit(1)

       expanded_path = _Path(path).expanduser()

       try:
           return _pm_load_profile(expanded_path)
       except ProfileNotFoundError:
           print(f"\n{C.YELLOW}Profile not found:{C.RESET} {expanded_path}")
           print("Running setup wizard to create profile...\n")
           from .wizard import run_setup_wizard
           if not run_setup_wizard():
               print("\nSetup cancelled.")
               sys.exit(1)
           return load_profile_with_recovery(path, _retry + 1)
       except (ProfileCorruptedError, ProfileValidationError) as e:
           # Per user decision: warn and offer to re-run wizard on invalid profile
           import shutil
           backup_path = f"{expanded_path}.bak"
           shutil.copy(expanded_path, backup_path)
           print(f"\n{C.RED}Profile invalid:{C.RESET} {e}")
           print(f"Backed up to: {backup_path}")
           print("Running setup wizard to create valid profile...\n")
           from .wizard import run_setup_wizard
           if not run_setup_wizard():
               print("\nSetup cancelled.")
               sys.exit(1)
           return load_profile_with_recovery(path, _retry + 1)
   ```
   - Consolidates the 5 separate error checks into 2 exception catches
   - Keeps wizard recovery behavior identical
   - Per user decision: invalid profile on load warns and offers to re-run wizard

4. Remove the now-unused inline validation logic from the old load_profile and load_profile_with_recovery functions. The validation is now in profile_manager.validate_profile().

5. Keep `shutil` import in search.py (still needed for backup in recovery path).
  </action>
  <verify>
1. Run existing tests to ensure no regressions: `cd /home/corye/Claude/Job-Radar && python -m pytest tests/ -x -q`
2. Verify wizard import works: `python -c "from job_radar.wizard import run_setup_wizard; print('wizard import OK')"`
3. Verify search import works: `python -c "from job_radar.search import load_profile; print('search import OK')"`
4. Verify _write_json_atomic is NOT defined in wizard.py anymore: `python -c "from job_radar.wizard import _write_json_atomic" 2>&1` should fail with ImportError
5. Verify profile_manager is used: `grep -n "from .profile_manager import" /home/corye/Claude/Job-Radar/job_radar/wizard.py /home/corye/Claude/Job-Radar/job_radar/search.py`
  </verify>
  <done>wizard.py calls save_profile() from profile_manager for profile writes. search.py delegates load_profile() and load_profile_with_recovery() to profile_manager. Duplicated validation logic removed from both files. All existing tests pass. Invalid profile on load triggers wizard recovery per user decision.</done>
</task>

<task type="auto">
  <name>Task 2: Add comprehensive unit tests for profile_manager.py</name>
  <files>tests/test_profile_manager.py</files>
  <action>
Create tests/test_profile_manager.py with comprehensive tests for the profile_manager module. Use pytest with tmp_path fixture for all file I/O tests.

**Test structure (use pytest conventions matching existing tests in the project):**

```python
"""Tests for profile_manager module -- centralized profile I/O."""
import json
import pytest
from pathlib import Path
from unittest.mock import patch

from job_radar.profile_manager import (
    validate_profile,
    save_profile,
    load_profile,
    _rotate_backups,
    ProfileValidationError,
    MissingFieldError,
    InvalidTypeError,
    ProfileNotFoundError,
    ProfileCorruptedError,
    CURRENT_SCHEMA_VERSION,
    MAX_BACKUPS,
)
```

**Test categories (aim for ~15-20 tests):**

1. **Validation tests** (5-6 tests):
   - `test_validate_valid_profile` — minimal valid profile passes
   - `test_validate_valid_profile_with_optional_fields` — all fields pass
   - `test_validate_missing_required_fields` — raises MissingFieldError with field names
   - `test_validate_invalid_type_target_titles` — raises InvalidTypeError for non-list
   - `test_validate_invalid_type_core_skills` — empty list raises InvalidTypeError
   - `test_validate_years_experience_out_of_range` — raises ProfileValidationError with friendly message
   - `test_validate_preserves_unknown_fields` — unknown fields do NOT cause validation error (forward-compatible per user decision)

2. **Atomic write tests** (2-3 tests):
   - `test_save_creates_file` — save_profile creates file at specified path
   - `test_save_atomic_content` — saved JSON is valid and contains all fields
   - `test_save_adds_schema_version` — schema_version=1 added to output even if not in input

3. **Backup tests** (3-4 tests):
   - `test_save_creates_backup` — second save creates backup file in backups/ dir
   - `test_backup_has_timestamp_filename` — backup filename matches `profile_YYYY-MM-DD_HH-MM-SS.json` pattern
   - `test_backup_rotation_keeps_max` — creating >10 backups deletes oldest, keeps 10
   - `test_first_save_no_backup` — first save (no existing file) does not create backup

4. **Schema versioning tests** (3 tests):
   - `test_load_adds_schema_version_to_legacy` — loading profile without schema_version auto-migrates to v1 and saves
   - `test_load_preserves_current_schema` — loading profile with schema_version=1 returns unchanged
   - `test_load_ignores_future_schema` — loading profile with schema_version=99 does not error (per user decision: ignore unknown schema versions)

5. **Error handling tests** (3 tests):
   - `test_load_missing_file_raises` — ProfileNotFoundError with path in message
   - `test_load_corrupt_json_raises` — ProfileCorruptedError for invalid JSON
   - `test_save_rejects_invalid_profile` — ProfileValidationError raised BEFORE any file write (verify file unchanged)

6. **Round-trip tests** (1-2 tests):
   - `test_round_trip_preserves_data` — save then load returns same data (including unknown fields)
   - `test_round_trip_preserves_unknown_fields` — custom_field survives save+load (per user decision)

**Helper fixture:**
```python
@pytest.fixture
def valid_profile():
    return {
        "name": "Test User",
        "target_titles": ["Software Engineer", "Backend Developer"],
        "core_skills": ["Python", "PostgreSQL"],
    }

@pytest.fixture
def profile_path(tmp_path):
    return tmp_path / "profile.json"
```

**Important for backup tests:**
- The backup directory is resolved via `get_backup_dir()` which uses platformdirs. For tests, mock `get_backup_dir` to return `tmp_path / "backups"` so tests don't write to the real user data directory.
- Use `@patch("job_radar.profile_manager.get_backup_dir")` to redirect backups to tmp_path.

**Important for schema migration test:**
- Write a legacy profile (no schema_version) directly to disk with json.dump, then call load_profile. Verify the file on disk now has schema_version=1. Mock get_backup_dir for the auto-save.

**Test naming:** Use `test_` prefix, descriptive names, match existing test file style in the project.
  </action>
  <verify>
Run the full test suite: `cd /home/corye/Claude/Job-Radar && python -m pytest tests/test_profile_manager.py -v`
All tests should pass. Then run the full suite to check no regressions: `python -m pytest tests/ -x -q`
  </verify>
  <done>tests/test_profile_manager.py exists with 15+ tests covering validation, atomic writes, backups, rotation, schema versioning, error handling, and round-trip data preservation. All tests pass. Full test suite passes with no regressions.</done>
</task>

</tasks>

<verification>
1. `python -m pytest tests/test_profile_manager.py -v` -- all profile_manager tests pass
2. `python -m pytest tests/ -x -q` -- full test suite passes (no regressions)
3. `grep -r "_write_json_atomic" job_radar/wizard.py` -- function definition no longer in wizard.py
4. `grep -r "from .profile_manager import" job_radar/wizard.py job_radar/search.py` -- both files import from profile_manager
5. `grep -r "def load_profile" job_radar/search.py` -- function exists but delegates to profile_manager
6. No inline validation logic duplicated in search.py (validation lives in profile_manager only)
</verification>

<success_criteria>
- wizard.py uses profile_manager.save_profile() for profile writes (SAFE-08: extracted atomic write)
- search.py uses profile_manager.load_profile() for profile reads (SAFE-05: shared validation, SAFE-06: centralized I/O)
- Duplicated validation logic removed from search.py
- Invalid profile on load: warns and offers wizard re-run (per user decision)
- tests/test_profile_manager.py has 15+ tests covering all profile_manager functionality
- All existing tests pass without regressions
- All SAFE-01 through SAFE-08 requirements covered across Plan 01 and Plan 02
</success_criteria>

<output>
After completion, create `.planning/phases/24-profile-infrastructure/24-02-SUMMARY.md`
</output>
